# AstroRead 技术实施方案

> 基于 HarmonyOS ArkTS 的阅读器应用 - 代码复用与整合方案

## 目录

- [一、项目概述](#一项目概述)
- [二、内容解析模块](#二内容解析模块)
- [三、搜索引擎模块](#三搜索引擎模块)
- [四、统一接口设计](#四统一接口设计)
- [五、鸿蒙代码评估](#五鸿蒙代码评估)
- [六、版本控制与分支管理](#六版本控制与分支管理)
- [七、测试框架设计](#七测试框架设计)
- [八、实施计划](#八实施计划)
- [九、单元测试框架](#九单元测试框架)
- [十、API 文档体系](#十api-文档体系)
- [十一、代码复用与整合方案](#十一代码复用与整合方案)

---

## 一、项目概述

### 1.1 项目架构

```
AstroRead/
├── entry/src/main/ets/
│   ├── components/          # UI 组件
│   ├── pages/               # 页面
│   ├── viewmodel/           # 视图模型
│   ├── models/              # 数据模型
│   ├── utils/               # 工具类
│   │   ├── HTMLParser.ets
│   │   ├── CssSelectorParser.ets
│   │   ├── ContentParser.ets
│   │   ├── RuleEngine.ets
│   │   ├── JSEngine.ets
│   │   ├── EnhancedJSEngine.ets
│   │   ├── BookSourceManager.ets
│   │   ├── BookSourceSearchEngine.ets
│   │   └── ...
│   └── common/              # 公共模块
```

### 1.2 技术栈

| 类别 | 技术 |
|------|------|
| 语言 | ArkTS (TypeScript 超集) |
| 框架 | HarmonyOS SDK |
| 网络 | @ohos/axios, @ohos.net.http |
| 存储 | @ohos.data.relationalStore |
| 图片 | @ohos/imageknife |
| 文件 | @ohos.file.fs |

---

## 二、内容解析模块

### 2.1 模块架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                     内容解析模块架构                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│  │ HTMLParser  │    │CssSelector  │    │ ContentParser│        │
│  │   .ets      │    │  Parser.ets │    │    .ets      │        │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘        │
│         │                  │                   │               │
│         └──────────────────┼───────────────────┘               │
│                            ▼                                   │
│                   ┌─────────────┐                              │
│                   │ RuleEngine  │  ← 统一规则调度               │
│                   │    .ets     │                              │
│                   └──────┬──────┘                              │
│                          │                                     │
│         ┌────────────────┼────────────────┐                   │
│         ▼                ▼                ▼                   │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐              │
│  │  JSEngine  │  │EnhancedJS  │  │ Network    │              │
│  │   .ets     │  │ Engine.ets │  │ Adapter.ets│              │
│  └────────────┘  └────────────┘  └────────────┘              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 模块功能定义

#### HTMLParser.ets

| 项目 | 说明 |
|------|------|
| **功能** | HTML/XML 解析，支持多种规则格式 |
| **输入** | `html: string, rule: string` |
| **输出** | `string[]` |
| **支持规则** | XPath、CSS Selector、JSONPath、正则表达式 |
| **依赖** | 无外部依赖（纯 TypeScript 实现） |

**核心方法：**

```typescript
class HTMLParser {
  parse(html: string, rule: string): string[]
  parseDetailed(html: string, rule: string): ParseResult[]
  extractText(html: string): string
  resolveUrl(baseUrl: string, relativeUrl: string): string
}
```

#### CssSelectorParser.ets

| 项目 | 说明 |
|------|------|
| **功能** | CSS 选择器和 XPath 解析 |
| **输入** | `html: string, selector: string` |
| **输出** | `string[]` |
| **支持格式** | `.class`, `#id`, `tag`, `[attr=value]`, XPath |

**核心方法：**

```typescript
class CssSelectorParser {
  static selectElements(html: string, selector: string): string[]
  static extractValue(html: string, rule: string): string
  static extractTextContent(html: string): string
}
```

#### ContentParser.ets

| 项目 | 说明 |
|------|------|
| **功能** | 书源内容解析（搜索结果、章节列表、正文内容） |
| **输入** | `html: string, BookSource` |
| **输出** | `ParsedBookItem[]`, `ParsedChapterItem[]`, `string` |
| **支持格式** | JSONPath、XPath、正则表达式 |

**核心方法：**

```typescript
class ContentParser {
  static parseSearchResult(html: string, bookSource: BookSource): ParsedBookItem[]
  static parseChapterList(html: string, bookSource: BookSource): ParsedChapterItem[]
  static parseChapterContent(html: string, bookSource: BookSource): string
  static purifyContent(content: string, replaceRule?: ReplaceRuleConfig): string
}
```

#### RuleEngine.ets

| 项目 | 说明 |
|------|------|
| **功能** | 规则引擎调度中心 |
| **输入** | `rule: string, html: string` |
| **输出** | `string`, `string[]` |
| **支持规则** | CSS、XPath、JSON、正则、变量、组合规则 |

**核心方法：**

```typescript
class RuleEngine {
  static parseRule(rule: string, html: string): string
  static parseRuleList(rule: string, html: string): string[]
  static parseSearchUrl(searchUrl: string, keyword: string, page: number, baseUrl: string): ParsedUrl
  static setContext(context: Partial<RuleContext>): void
}
```

### 2.3 规则类型支持

| 规则类型 | 前缀 | 示例 | 说明 |
|---------|------|------|------|
| CSS Selector | 无 | `.book-list .item` | 标准 CSS 选择器 |
| XPath | `//` | `//div[@class="book"]` | XPath 路径表达式 |
| JSONPath | `$.` | `$.data.books[*].name` | JSON 路径表达式 |
| 正则表达式 | `##` 或 `@regex:` | `##<a href="([^"]+)"` | 正则匹配 |
| JavaScript | `@js:` 或 `<js>` | `@js: result.replace(/a/g, 'b')` | JS 脚本执行 |
| 变量存储 | `@put:` | `@put:{key:rule}` | 存储变量 |
| 变量获取 | `@get:` | `@get:{key}` | 获取变量 |
| 组合规则 | `&&`, `||` | `rule1&&rule2` | 与/或组合 |

---

## 三、搜索引擎模块

### 3.1 模块架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                     搜索引擎模块架构                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                   ┌───────────────────┐                        │
│                   │BookSourceManager  │ ← 书源管理入口           │
│                   │      .ets         │                        │
│                   └─────────┬─────────┘                        │
│                             │                                   │
│         ┌───────────────────┼───────────────────┐              │
│         ▼                   ▼                   ▼              │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│  │BookSource   │    │BookSource   │    │BookSource   │        │
│  │SearchEngine │    │  Debugger   │    │  Parser     │        │
│  │    .ets     │    │    .ets     │    │    .ets     │        │
│  └──────┬──────┘    └─────────────┘    └─────────────┘        │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────────────────────────────────────────┐           │
│  │              AxiosNetworkManager                 │           │
│  │  - HTTP 请求管理                                  │           │
│  │  - 并发控制                                       │           │
│  │  - 超时处理                                       │           │
│  └─────────────────────────────────────────────────┘           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 模块功能定义

#### BookSourceManager.ets

| 项目 | 说明 |
|------|------|
| **功能** | 书源管理入口，整合导入、搜索、调试功能 |
| **支持格式** | JSON、TXT、YCK 格式 |
| **核心能力** | 书源导入、搜索、调试、导出 |

**核心方法：**

```typescript
class BookSourceManager {
  async importSources(input: string): Promise<BookSource[]>
  async searchBooks(keyword: string, options?: Partial<SearchOptions>): Promise<SearchBooksResult>
  async debugSearch(source: BookSource, keyword: string)
  async debugChapters(source: BookSource, bookUrl: string)
  async debugContent(source: BookSource, chapterUrl: string)
  getAllSources(): BookSource[]
  getEnabledSources(): BookSource[]
  exportSources(sources?: BookSource[]): string
  exportToYCKFormat(sources?: BookSource[]): string
}
```

#### BookSourceSearchEngine.ets

| 项目 | 说明 |
|------|------|
| **功能** | 多书源并发搜索引擎 |
| **特性** | 并发控制、频率限制、结果聚合 |
| **配置** | 最大并发数、请求间隔、超时时间 |

**核心方法：**

```typescript
class BookSourceSearchEngine {
  async search(sources: BookSource[], options: SearchOptions): Promise<SearchResult[]>
  async searchSingleSource(source: BookSource, key: string, page: number): Promise<SearchResult>
  aggregateResults(results: SearchResult[]): Book[]
  setConfig(config: Partial<SearchConfig>): void
}
```

**配置参数：**

```typescript
interface SearchConfig {
  maxConcurrent: number;      // 最大并发数，默认 3
  requestInterval: number;    // 请求间隔(ms)，默认 1000
  timeout: number;            // 超时时间(ms)，默认 30000
  maxResultsPerSource: number; // 每书源最大结果数，默认 20
}
```

### 3.3 数据流程

```
用户输入关键词
      │
      ▼
┌─────────────────┐
│ BookSourceManager│
│  searchBooks()  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 获取启用的书源   │
│ getEnabledSources│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│BookSourceSearch │
│   Engine.search │
│  (并发控制)      │
└────────┬────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌───────┐ ┌───────┐
│书源1  │ │书源2  │ ...
└───┬───┘ └───┬───┘
    │         │
    ▼         ▼
┌───────┐ ┌───────┐
│HTTP请求│ │HTTP请求│
└───┬───┘ └───┬───┘
    │         │
    ▼         ▼
┌───────┐ ┌───────┐
│解析结果│ │解析结果│
└───┬───┘ └───┬───┘
    │         │
    └────┬────┘
         │
         ▼
┌─────────────────┐
│  结果聚合去重    │
│aggregateResults │
└─────────────────┘
```

---

## 四、统一接口设计

### 4.1 接口定义

```typescript
// interfaces/IParser.ts

/**
 * 内容解析接口
 */
export interface IContentParser {
  parse(html: string, rule: string): string[];
  parseList(html: string, rule: string): string[];
  extractText(html: string): string;
}

/**
 * 规则引擎接口
 */
export interface IRuleEngine {
  parseRule(rule: string, html: string): string;
  parseRuleList(rule: string, html: string): string[];
  setContext(context: RuleContext): void;
  getContext(): RuleContext;
}

/**
 * 搜索引擎接口
 */
export interface ISearchEngine {
  search(sources: BookSource[], options: SearchOptions): Promise<SearchResult[]>;
  searchSingleSource(source: BookSource, key: string, page: number): Promise<SearchResult>;
  aggregateResults(results: SearchResult[]): Book[];
}

/**
 * 网络请求接口
 */
export interface INetworkAdapter {
  get(url: string, options?: RequestOptions): Promise<string>;
  post(url: string, body: string, options?: RequestOptions): Promise<string>;
  setDefaultHeaders(headers: Record<string, string>): void;
}

/**
 * 书源管理接口
 */
export interface IBookSourceManager {
  importSources(input: string): Promise<BookSource[]>;
  searchBooks(keyword: string, options?: Partial<SearchOptions>): Promise<SearchBooksResult>;
  getAllSources(): BookSource[];
  getEnabledSources(): BookSource[];
  addSource(source: BookSource): void;
  removeSource(id: string): void;
  updateSource(source: BookSource): void;
}
```

### 4.2 门面类设计

```typescript
// core/ParserFacade.ets

import { HTMLParser } from '../utils/HTMLParser';
import { ContentParser, ParsedBookItem, ParsedChapterItem } from '../utils/ContentParser';
import { RuleEngine } from '../utils/RuleEngine';
import { BookSourceSearchEngine, SearchOptions, SearchResult } from '../utils/BookSourceSearchEngine';
import { BookSourceManager, SearchBooksResult } from '../utils/BookSourceManager';
import { BookSource } from '../models/BookSource';
import { Book } from '../models/Book';

/**
 * 解析器门面类 - 统一入口
 * 提供标准化的解析服务接口
 */
export class ParserFacade {
  private static instance: ParserFacade | null = null;
  
  private htmlParser: HTMLParser;
  private ruleEngine: typeof RuleEngine;
  private searchEngine: BookSourceSearchEngine;
  private sourceManager: BookSourceManager;

  private constructor() {
    this.htmlParser = HTMLParser.getInstance();
    this.ruleEngine = RuleEngine;
    this.searchEngine = BookSourceSearchEngine.getInstance();
    this.sourceManager = BookSourceManager.getInstance();
  }

  static getInstance(): ParserFacade {
    if (!ParserFacade.instance) {
      ParserFacade.instance = new ParserFacade();
    }
    return ParserFacade.instance;
  }

  // ========== HTML 解析接口 ==========

  parseHtml(html: string, rule: string): string[] {
    return this.htmlParser.parse(html, rule);
  }

  extractText(html: string): string {
    return this.htmlParser.extractText(html);
  }

  // ========== 书源内容解析接口 ==========

  parseSearchResult(html: string, source: BookSource): ParsedBookItem[] {
    return ContentParser.parseSearchResult(html, source);
  }

  parseChapterList(html: string, source: BookSource): ParsedChapterItem[] {
    return ContentParser.parseChapterList(html, source);
  }

  parseChapterContent(html: string, source: BookSource): string {
    return ContentParser.parseChapterContent(html, source);
  }

  // ========== 规则执行接口 ==========

  executeRule(rule: string, html: string): string {
    return this.ruleEngine.parseRule(rule, html);
  }

  executeRuleList(rule: string, html: string): string[] {
    return this.ruleEngine.parseRuleList(rule, html);
  }

  // ========== 搜索接口 ==========

  async searchBooks(keyword: string, options?: Partial<SearchOptions>): Promise<SearchBooksResult> {
    return this.sourceManager.searchBooks(keyword, options);
  }

  async searchSingleSource(sourceId: string, keyword: string, page: number = 1): Promise<SearchResult> {
    return this.sourceManager.searchFromSource(sourceId, keyword, page);
  }

  // ========== 书源管理接口 ==========

  async importSources(input: string): Promise<BookSource[]> {
    return this.sourceManager.importSources(input);
  }

  getAllSources(): BookSource[] {
    return this.sourceManager.getAllSources();
  }

  getEnabledSources(): BookSource[] {
    return this.sourceManager.getEnabledSources();
  }

  addSource(source: BookSource): void {
    this.sourceManager.addSource(source);
  }

  removeSource(id: string): void {
    this.sourceManager.removeSource(id);
  }

  updateSource(source: BookSource): void {
    this.sourceManager.updateSource(source);
  }

  // ========== 调试接口 ==========

  async debugSearch(source: BookSource, keyword: string) {
    return this.sourceManager.debugSearch(source, keyword);
  }

  async debugChapters(source: BookSource, bookUrl: string) {
    return this.sourceManager.debugChapters(source, bookUrl);
  }

  async debugContent(source: BookSource, chapterUrl: string) {
    return this.sourceManager.debugContent(source, chapterUrl);
  }

  // ========== 导出接口 ==========

  exportSources(sources?: BookSource[]): string {
    return this.sourceManager.exportSources(sources);
  }

  exportToYCKFormat(sources?: BookSource[]): string {
    return this.sourceManager.exportToYCKFormat(sources);
  }
}

export default ParserFacade.getInstance();
```

### 4.3 使用示例

```typescript
import ParserFacade from '../core/ParserFacade';

// 获取单例实例
const parser = ParserFacade.getInstance();

// 导入书源
const sources = await parser.importSources('https://example.com/sources.json');

// 搜索书籍
const result = await parser.searchBooks('斗罗大陆', { page: 1 });
console.log(`找到 ${result.books.length} 本书`);

// 解析 HTML
const elements = parser.parseHtml(html, '.book-list .item');

// 执行规则
const value = parser.executeRule('@css:.title@text', html);
```

---

## 五、鸿蒙代码评估

### 5.1 API 使用统计

| API 类别 | 使用文件数 | 关键 API | 处理建议 |
|---------|-----------|---------|---------|
| @kit.AbilityKit | 5 | `UIAbility`, `Want`, `router` | ✅ 保留 |
| @kit.ArkUI | 6 | `window`, `router`, `hilog` | ✅ 保留 |
| @kit.ArkData | 3 | `preferences`, `relationalStore` | ✅ 保留 |
| @ohos.net.http | 3 | `http.createHttp()` | ✅ 保留 |
| @ohos.file.fs | 6 | `fs.open()`, `fs.read()` | ✅ 保留 |
| @ohos.web.webview | 2 | `WebviewController` | ⚠️ 评估 |
| @ohos.zlib | 1 | `zlib.decompress()` | ✅ 保留 |
| @ohos.imageknife | 2 | `ImageKnife` | ✅ 保留 |
| @ohos/axios | 1 | `axios` | ✅ 保留 |

### 5.2 代码分类

#### A. 必须保留的核心代码

| 文件 | 鸿蒙依赖 | 功能描述 |
|------|---------|---------|
| EntryAbility.ets | @kit.AbilityKit | 应用入口 |
| DatabaseManager.ets | @ohos.data.relationalStore | 数据库管理 |
| FileManager.ets | @ohos.file.fs | 文件管理 |
| AxiosNetworkManager.ets | @ohos/axios | 网络请求 |
| ImageKnifeManager.ets | @ohos/imageknife | 图片缓存 |
| EPUBParser.ets | @ohos.zlib | EPUB 解压 |

#### B. 需要评估调整的代码

| 文件 | 问题 | 处理方案 |
|------|------|---------|
| JSEngine.ets | 依赖 @ohos.web.webview | 评估是否可用 EnhancedJSEngine 替代 |
| WebReader.ets | 依赖 WebView | 保留，阅读功能需要 |

#### C. 可优化/重构的代码

| 文件 | 优化建议 |
|------|---------|
| NetworkAdapter.ets | 统一使用 AxiosNetworkManager |
| NetworkManager.ets | 可能重复，评估是否合并 |

### 5.3 依赖关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                        鸿蒙 API 依赖关系                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐                                              │
│  │ @kit.Ability│──────▶ EntryAbility.ets                      │
│  │    Kit      │──────▶ BookSourceViewModel.ets               │
│  └─────────────┘                                              │
│                                                                 │
│  ┌─────────────┐                                              │
│  │ @kit.ArkUI  │──────▶ BookshelfPage.ets                     │
│  │             │──────▶ BookDetailPage.ets                    │
│  │             │──────▶ ReadPage.ets                          │
│  │             │──────▶ SearchPage.ets                        │
│  └─────────────┘                                              │
│                                                                 │
│  ┌─────────────┐                                              │
│  │@kit.ArkData │──────▶ BookViewModel.ets (preferences)       │
│  │             │──────▶ ThemeManager.ets (preferences)        │
│  └─────────────┘                                              │
│                                                                 │
│  ┌─────────────┐                                              │
│  │@ohos.net.http│─────▶ BookSourceManager.ets                 │
│  │             │──────▶ NetworkManager.ets                    │
│  └─────────────┘                                              │
│                                                                 │
│  ┌─────────────┐                                              │
│  │@ohos.file.fs│──────▶ FileManager.ets                       │
│  │             │──────▶ EPUBParser.ets                        │
│  │             │──────▶ SourcePage.ets                        │
│  └─────────────┘                                              │
│                                                                 │
│  ┌─────────────┐                                              │
│  │@ohos.web.   │──────▶ JSEngine.ets                          │
│  │  webview    │──────▶ WebReader.ets                         │
│  └─────────────┘                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 六、版本控制与分支管理

### 6.1 分支策略

```
main (生产分支 - 稳定版本)
  │
  ├── develop (开发分支 - 集成测试)
  │     │
  │     ├── feature/parser-interface      # 解析器接口重构
  │     ├── feature/facade-class          # 门面类实现
  │     ├── feature/network-unify         # 网络层统一
  │     ├── feature/harmony-optimization  # 鸿蒙代码优化
  │     └── feature/test-framework        # 测试框架
  │
  ├── release/v1.x (发布分支)
  │     └── hotfix/xxx (紧急修复)
  │
  └── docs (文档分支)
```

### 6.2 分支管理规则

| 分支类型 | 命名规范 | 说明 | 合并目标 |
|---------|---------|------|---------|
| `main` | main | 生产环境代码，只接受 release 合并 | - |
| `develop` | develop | 开发集成分支，日常开发基础 | release |
| `feature` | feature/功能名 | 新功能开发，从 develop 创建 | develop |
| `release` | release/v版本号 | 发布准备，从 develop 创建 | main |
| `hotfix` | hotfix/问题描述 | 紧急修复，从 main 创建 | main, develop |
| `docs` | docs | 文档更新 | develop |

### 6.3 提交规范

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type 类型：**
- `feat`: 新功能
- `fix`: Bug 修复
- `refactor`: 重构
- `docs`: 文档更新
- `test`: 测试相关
- `chore`: 构建/工具相关

**示例：**
```
feat(parser): 添加 ParserFacade 门面类

- 实现 JSON/XML/HTML/CSV 统一解析接口
- 添加缓存机制
- 支持批量解析

Closes #123
```

### 6.4 代码审查流程

```
1. 开发者创建 feature 分支
        │
        ▼
2. 完成开发并自测
        │
        ▼
3. 创建 Pull Request → develop
        │
        ▼
4. CI 自动检查（构建、测试）
        │
        ▼
5. 代码审查（至少 1 人 approve）
        │
        ▼
6. 合并到 develop
        │
        ▼
7. 定期创建 release 分支
        │
        ▼
8. 测试通过后合并到 main
```

---

## 七、测试框架设计

### 7.1 测试架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        测试框架架构                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    E2E 测试层                             │   │
│  │  - 用户流程测试                                           │   │
│  │  - UI 交互测试                                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                            │                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   集成测试层                              │   │
│  │  - BookSourceSearchEngine 测试                           │   │
│  │  - BookSourceManager 测试                                │   │
│  │  - DatabaseManager 测试                                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                            │                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   单元测试层                              │   │
│  │  - HTMLParser 测试                                       │   │
│  │  - CssSelectorParser 测试                                │   │
│  │  - ContentParser 测试                                    │   │
│  │  - RuleEngine 测试                                       │   │
│  │  - ParserFacade 测试                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 单元测试设计

#### 7.2.1 HTMLParser 测试用例

```typescript
// entry/src/ohosTest/ets/test/HTMLParser.test.ets

import { describe, it, expect } from '@ohos/hypium';
import { HTMLParser } from '../../../main/ets/utils/HTMLParser';

export default function HTMLParserTest() {
  describe('HTMLParser', () => {
    const parser = HTMLParser.getInstance();

    it('should parse CSS selector correctly', () => {
      const html = '<div class="book"><span class="title">Test Book</span></div>';
      const result = parser.parse(html, '.book .title');
      expect(result.length).assertEqual(1);
      expect(result[0]).assertEqual('Test Book');
    });

    it('should handle nested elements', () => {
      const html = `
        <ul class="book-list">
          <li><a href="/book/1">Book 1</a></li>
          <li><a href="/book/2">Book 2</a></li>
        </ul>
      `;
      const result = parser.parse(html, '.book-list li a');
      expect(result.length).assertEqual(2);
    });

    it('should extract text content', () => {
      const html = '<div><p>Hello</p><p>World</p></div>';
      const text = parser.extractText(html);
      expect(text).assertContain('Hello');
      expect(text).assertContain('World');
    });

    it('should resolve relative URLs', () => {
      const baseUrl = 'https://example.com/books/';
      const relativeUrl = '/chapter/1';
      const resolved = parser.resolveUrl(baseUrl, relativeUrl);
      expect(resolved).assertEqual('https://example.com/chapter/1');
    });
  });
}
```

#### 7.2.2 ContentParser 测试用例

```typescript
// entry/src/ohosTest/ets/test/ContentParser.test.ets

import { describe, it, expect, beforeEach } from '@ohos/hypium';
import { ContentParser, ParsedBookItem } from '../../../main/ets/utils/ContentParser';
import { BookSource } from '../../../main/ets/models/BookSource';

export default function ContentParserTest() {
  describe('ContentParser', () => {
    let mockBookSource: BookSource;

    beforeEach(() => {
      mockBookSource = {
        id: 'test-source',
        name: 'Test Source',
        url: 'https://example.com',
        ruleType: 'xpath',
        searchRule: {
          bookList: '.book-list .item',
          name: '.title',
          author: '.author',
          cover: 'img@src',
          bookUrl: 'a@href'
        }
      } as BookSource;
    });

    it('should parse search results with XPath', () => {
      const html = `
        <div class="book-list">
          <div class="item">
            <span class="title">Test Book</span>
            <span class="author">Test Author</span>
            <a href="/book/123">Link</a>
          </div>
        </div>
      `;
      
      const results = ContentParser.parseSearchResult(html, mockBookSource);
      expect(results.length).assertEqual(1);
      expect(results[0].name).assertEqual('Test Book');
      expect(results[0].author).assertEqual('Test Author');
    });

    it('should parse search results with JSONPath', () => {
      const jsonSource = {
        ...mockBookSource,
        ruleType: 'jsonpath',
        searchRule: {
          bookList: '$.data.books[*]',
          name: '$.name',
          author: '$.author',
          bookUrl: '$.url'
        }
      };
      
      const json = JSON.stringify({
        data: {
          books: [
            { name: 'Book 1', author: 'Author 1', url: '/book/1' },
            { name: 'Book 2', author: 'Author 2', url: '/book/2' }
          ]
        }
      });
      
      const results = ContentParser.parseSearchResult(json, jsonSource);
      expect(results.length).assertEqual(2);
    });

    it('should purify content correctly', () => {
      const content = '<p>Hello&nbsp;World</p><script>alert("xss")</script>';
      const purified = ContentParser.purifyContent(content, { removeHtmlTags: true });
      expect(purified).assertNotContain('<script>');
      expect(purified).assertContain('Hello World');
    });
  });
}
```

#### 7.2.3 RuleEngine 测试用例

```typescript
// entry/src/ohosTest/ets/test/RuleEngine.test.ets

import { describe, it, expect } from '@ohos/hypium';
import { RuleEngine } from '../../../main/ets/utils/RuleEngine';

export default function RuleEngineTest() {
  describe('RuleEngine', () => {
    it('should parse CSS selector rule', () => {
      const html = '<div class="content">Test Content</div>';
      const result = RuleEngine.parseRule('.content', html);
      expect(result).assertEqual('Test Content');
    });

    it('should parse JSON rule', () => {
      const json = '{"data": {"name": "Test"}}';
      const result = RuleEngine.parseRule('@json:$.data.name', json);
      expect(result).assertEqual('Test');
    });

    it('should parse regex rule', () => {
      const html = '<a href="https://example.com/book/123">Link</a>';
      const result = RuleEngine.parseRule('##href="([^"]+)"', html);
      expect(result).assertContain('https://example.com/book/123');
    });

    it('should handle combined rules with OR', () => {
      const html = '<div class="title">Title</div>';
      const result = RuleEngine.parseRule('.not-exist || .title', html);
      expect(result).assertEqual('Title');
    });

    it('should handle variable storage and retrieval', () => {
      RuleEngine.putVariable('testVar', 'testValue');
      const value = RuleEngine.getVariable('testVar');
      expect(value).assertEqual('testValue');
    });
  });
}
```

### 7.3 集成测试设计

#### 7.3.1 BookSourceSearchEngine 集成测试

```typescript
// entry/src/ohosTest/ets/test/BookSourceSearchEngine.test.ets

import { describe, it, expect, beforeAll } from '@ohos/hypium';
import { BookSourceSearchEngine, SearchResult } from '../../../main/ets/utils/BookSourceSearchEngine';
import { BookSource } from '../../../main/ets/models/BookSource';
import { databaseManager } from '../../../main/ets/utils/DatabaseManager';

export default function SearchEngineIntegrationTest() {
  describe('BookSourceSearchEngine Integration', () => {
    let searchEngine: BookSourceSearchEngine;
    let testSources: BookSource[];

    beforeAll(async () => {
      // 初始化测试环境
      searchEngine = BookSourceSearchEngine.getInstance();
      
      // 创建测试书源
      testSources = [
        {
          id: 'test-source-1',
          name: 'Test Source 1',
          url: 'https://source1.example.com',
          enabled: true,
          searchUrl: 'https://source1.example.com/search?key={{key}}',
          ruleType: 'xpath',
          searchRule: { /* ... */ }
        }
      ] as BookSource[];
    });

    it('should search from multiple sources concurrently', async () => {
      const results = await searchEngine.search(testSources, {
        key: '测试关键词',
        page: 1,
        concurrent: 2
      });
      
      expect(results.length).assertEqual(testSources.length);
    });

    it('should aggregate and deduplicate results', () => {
      const mockResults: SearchResult[] = [
        {
          books: [{ name: 'Book 1', author: 'Author' } as Book],
          sourceName: 'Source 1',
          sourceUrl: 'url1',
          success: true,
          responseTime: 100
        },
        {
          books: [{ name: 'Book 1', author: 'Author' } as Book], // 重复
          sourceName: 'Source 2',
          sourceUrl: 'url2',
          success: true,
          responseTime: 150
        }
      ];
      
      const aggregated = searchEngine.aggregateResults(mockResults);
      expect(aggregated.length).assertEqual(1); // 去重后只有 1 本
    });

    it('should respect rate limiting', async () => {
      searchEngine.setConfig({ requestInterval: 500 });
      
      const startTime = Date.now();
      await searchEngine.search(testSources, { key: 'test' });
      const endTime = Date.now();
      
      // 验证请求间隔
      expect(endTime - startTime).assertLargerOrEqual(400);
    });
  });
}
```

### 7.4 测试覆盖率目标

| 模块 | 目标覆盖率 | 优先级 |
|------|-----------|--------|
| HTMLParser | 90% | 高 |
| CssSelectorParser | 85% | 高 |
| ContentParser | 85% | 高 |
| RuleEngine | 90% | 高 |
| ParserFacade | 80% | 高 |
| BookSourceSearchEngine | 75% | 中 |
| BookSourceManager | 70% | 中 |
| DatabaseManager | 60% | 低 |

### 7.5 测试执行命令

```bash
# 运行所有测试
hvigorw test

# 运行单元测试
hvigorw test --mode unit

# 运行集成测试
hvigorw test --mode integration

# 生成覆盖率报告
hvigorw test --coverage

# 运行特定测试文件
hvigorw test --file HTMLParser.test.ets
```

---

## 八、实施计划

### 8.1 阶段一：代码整合（优先级：高）

**目标**：建立统一的代码引用机制

| 任务 | 负责模块 | 交付物 |
|------|---------|--------|
| 创建 interfaces/ 目录 | 架构 | 接口文件结构 |
| 定义 IParser 接口 | 架构 | `interfaces/IParser.ts` |
| 实现 ParserFacade 门面类 | 核心 | `core/ParserFacade.ets` |
| 重构现有代码适配接口 | 全模块 | 适配后的模块代码 |
| 编写单元测试 | 测试 | 测试用例文件 |

**验收标准**：
- 所有解析模块通过 ParserFacade 统一调用
- 接口定义完整，包含类型注释
- 单元测试覆盖率 ≥ 80%

### 8.2 阶段二：鸿蒙代码处理（优先级：高）

**目标**：优化鸿蒙 API 使用，消除冗余

| 任务 | 说明 | 交付物 |
|------|------|--------|
| 评估 JSEngine vs EnhancedJSEngine | 选择最优方案 | 选型报告 |
| 统一网络请求实现 | 合并 NetworkManager | 统一网络层 |
| 优化文件操作代码 | 统一使用 FileManager | 优化后的文件操作 |
| 更新依赖文档 | 记录 API 使用 | API 使用文档 |

**验收标准**：
- 消除重复的网络请求实现
- JS 引擎选型有明确依据
- 鸿蒙 API 使用文档完整

### 8.3 阶段三：测试与文档（优先级：中）

**目标**：确保代码质量和可维护性

| 任务 | 说明 | 交付物 |
|------|------|--------|
| 解析器单元测试 | HTMLParser, CssSelectorParser | 测试用例 |
| 搜索引擎集成测试 | BookSourceSearchEngine | 集成测试 |
| API 文档编写 | 接口说明、使用示例 | API 文档 |
| 错误处理完善 | 异常捕获、日志记录 | 错误处理规范 |

**验收标准**：
- 测试覆盖率达标
- API 文档完整可用
- 错误处理规范统一

### 8.4 实施步骤

```
Step 1: 环境准备
├── 初始化 Git 仓库
├── 创建分支结构
└── 配置 CI/CD

Step 2: 接口设计
├── 定义 IParser 接口
├── 定义 ISearchEngine 接口
├── 定义 INetworkAdapter 接口
└── 定义 IBookSourceManager 接口

Step 3: 门面类实现
├── 实现 ParserFacade
├── 集成现有解析模块
└── 添加缓存机制

Step 4: 代码重构
├── 适配新接口
├── 消除重复代码
└── 优化依赖关系

Step 5: 测试编写
├── 单元测试
├── 集成测试
└── 覆盖率报告

Step 6: 文档完善
├── API 文档
├── 使用指南
└── 维护手册
```

### 8.5 风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 接口设计不合理 | 重构成本高 | 充分调研，小步迭代 |
| 鸿蒙 API 变更 | 兼容性问题 | 关注官方更新，预留适配层 |
| 测试覆盖不足 | 质量风险 | 设定覆盖率目标，持续监控 |
| 文档滞后 | 维护困难 | 文档与代码同步更新 |

---

## 十一、代码复用与整合方案

### 11.1 模块梳理总结

#### 内容解析模块

| 模块 | 文件路径 | 输入 | 输出 | 依赖 | 功能说明 |
|------|---------|------|------|------|---------|
| HTMLParser | `utils/HTMLParser.ets` | `html: string, rule: string` | `string[]` | 无 | HTML/XML 解析，支持 XPath、CSS、JSONPath、正则 |
| CssSelectorParser | `utils/CssSelectorParser.ets` | `html: string, selector: string` | `string[]` | 无 | CSS 选择器和 XPath 解析 |
| ContentParser | `utils/ContentParser.ets` | `html: string, BookSource` | `ParsedBookItem[]` | RuleEngine, CssSelectorParser | 书源内容解析（搜索、章节、正文） |
| RuleEngine | `utils/RuleEngine.ets` | `rule: string, html: string` | `string` | CssSelectorParser | 规则引擎调度中心 |
| EnhancedJSEngine | `utils/EnhancedJSEngine.ets` | `code: string, context: object` | `string` | 无 | 增强版 JS 执行引擎 |

#### 搜索引擎模块

| 模块 | 文件路径 | 输入 | 输出 | 依赖 | 功能说明 |
|------|---------|------|------|------|---------|
| BookSourceManager | `utils/BookSourceManager.ets` | `input: string` | `BookSource[]` | BookSourceParser, BookSourceSearchEngine | 书源管理入口 |
| BookSourceSearchEngine | `utils/BookSourceSearchEngine.ets` | `sources: BookSource[], options: SearchOptions` | `SearchResult[]` | AxiosNetworkManager, HTMLParser | 多书源并发搜索 |
| BookSourceDebugger | `utils/BookSourceDebugger.ets` | `source: BookSource` | `DebugResult` | AxiosNetworkManager, ContentParser | 书源调试工具 |
| AxiosNetworkManager | `utils/AxiosNetworkManager.ets` | `url: string, config: RequestConfig` | `string` | @ohos/axios | HTTP 网络请求管理 |

### 11.2 统一接口设计

#### 接口定义文件

```
entry/src/main/ets/
├── interfaces/
│   └── IContentParser.ets     # 核心接口定义
└── core/
    └── AstroReadFacade.ets    # 统一门面类
```

#### AstroReadFacade 统一入口

```typescript
import AstroReadFacade from '../core/AstroReadFacade';

const facade = AstroReadFacade.getInstance();

// HTML 解析
const elements = facade.parseHtml(html, '.book-list .item');

// 书源导入
const sources = await facade.importSources('https://example.com/sources.json');

// 搜索书籍
const result = await facade.searchBooks('斗罗大陆');

// 解析章节
const chapters = facade.parseChapterList(html, source);

// 网络请求
const content = await facade.get('https://example.com/content');
```

### 11.3 模块依赖关系

```
┌─────────────────────────────────────────────────────────────────┐
│                    AstroReadFacade (统一入口)                     │
├─────────────────────────────────────────────────────────────────┤
│                            │                                    │
│    ┌───────────────────────┼───────────────────────┐           │
│    ▼                       ▼                       ▼           │
│ ┌──────────────┐    ┌──────────────┐    ┌──────────────┐      │
│ │ HTMLParser   │    │BookSource    │    │AxiosNetwork  │      │
│ │              │    │Manager       │    │Manager       │      │
│ └──────┬───────┘    └──────┬───────┘    └──────────────┘      │
│        │                   │                                   │
│        ▼                   ▼                                   │
│ ┌──────────────┐    ┌──────────────┐                          │
│ │CssSelector   │    │BookSource    │                          │
│ │Parser        │    │SearchEngine  │                          │
│ └──────────────┘    └──────┬───────┘                          │
│                            │                                   │
│                            ▼                                   │
│                     ┌──────────────┐                          │
│                     │ContentParser │                          │
│                     │RuleEngine    │                          │
│                     └──────────────┘                          │
└─────────────────────────────────────────────────────────────────┘
```

### 11.4 调用方式规范

#### 标准调用流程

```typescript
// 1. 获取 Facade 实例
const facade = AstroReadFacade.getInstance();

// 2. 导入书源
const sources = await facade.importSources(sourceUrl);
facade.addSources(sources);

// 3. 搜索书籍
const searchResult = await facade.searchBooks('关键词', {
  page: 1,
  concurrent: 3,
  timeout: 30000
});

// 4. 获取章节列表
const book = searchResult.books[0];
const bookHtml = await facade.get(book.bookUrl);
const source = facade.getAllSources().find(s => s.id === book.bookSourceId);
const chapters = facade.parseChapterList(bookHtml, source);

// 5. 获取章节内容
const chapterHtml = await facade.get(chapters[0].url);
const content = facade.parseChapterContent(chapterHtml, source);
```

#### 错误处理规范

```typescript
try {
  const result = await facade.searchBooks(keyword);
  if (result.books.length === 0) {
    console.log('未找到相关书籍');
  }
} catch (error) {
  console.error('搜索失败:', error.message);
}
```

### 11.5 扩展机制

#### 添加新的解析规则类型

1. 在 `RuleEngine.ets` 中添加新的规则解析方法
2. 在 `ContentParser.ets` 中添加对应的解析逻辑
3. 通过 `AstroReadFacade` 暴露新接口

#### 添加新的书源格式支持

1. 在 `BookSourceParser.ets` 中添加新格式解析
2. 在 `BookSourceManager.importSources()` 中添加格式检测
3. 更新 `AstroReadFacade` 文档

---

## 附录

### A. 文件清单

#### 解析模块

| 文件路径 | 功能 |
|---------|------|
| `utils/HTMLParser.ets` | HTML/XML 解析 |
| `utils/CssSelectorParser.ets` | CSS 选择器解析 |
| `utils/ContentParser.ets` | 书源内容解析 |
| `utils/RuleEngine.ets` | 规则引擎调度 |
| `utils/JSEngine.ets` | JavaScript 执行引擎 |
| `utils/EnhancedJSEngine.ets` | 增强版 JS 引擎 |

#### 搜索模块

| 文件路径 | 功能 |
|---------|------|
| `utils/BookSourceManager.ets` | 书源管理 |
| `utils/BookSourceSearchEngine.ets` | 搜索引擎 |
| `utils/BookSourceDebugger.ets` | 书源调试 |
| `utils/BookSourceParser.ets` | 书源解析 |

#### 网络模块

| 文件路径 | 功能 |
|---------|------|
| `utils/AxiosNetworkManager.ets` | Axios 网络请求 |
| `utils/NetworkAdapter.ets` | 网络适配器 |
| `utils/NetworkManager.ets` | HTTP 网络请求 |

### B. 接口类型定义

```typescript
// 书籍解析结果
interface ParsedBookItem {
  name?: string;
  author?: string;
  cover?: string;
  intro?: string;
  bookUrl?: string;
}

// 章节解析结果
interface ParsedChapterItem {
  title: string;
  url: string;
  isVip: boolean;
  order: number;
}

// 搜索结果
interface SearchResult {
  books: Book[];
  sourceName: string;
  sourceUrl: string;
  success: boolean;
  error?: string;
  responseTime: number;
}

// 搜索选项
interface SearchOptions {
  key: string;
  page?: number;
  timeout?: number;
  concurrent?: number;
  interval?: number;
}

// 规则上下文
interface RuleContext {
  variables: Map<string, string>;
  baseUrl: string;
  html: string;
}

// 解析 URL 结果
interface ParsedUrl {
  url: string;
  method: 'GET' | 'POST';
  body?: string;
  headers?: Record<string, string>;
  charset?: string;
}
```

### C. 版本控制策略

```
main (稳定分支)
  │
  ├── develop (开发分支)
  │     │
  │     ├── feature/parser-interface (功能分支)
  │     ├── feature/facade-class (功能分支)
  │     └── feature/network-unify (功能分支)
  │
  └── release/v1.x (发布分支)
```

**分支管理规则**：
1. `main` 分支只接受来自 `release` 的合并
2. `develop` 分支用于日常开发
3. `feature/*` 分支从 `develop` 创建，完成后合并回 `develop`
4. 每个 feature 分支对应一个具体功能

---

## 九、单元测试框架

### 9.1 测试框架架构

```
┌─────────────────────────────────────────────────────────────────┐
│                     测试框架架构                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    TestRunner                            │   │
│  │  - 测试执行引擎                                           │   │
│  │  - 并行/串行执行                                          │   │
│  │  - 覆盖率收集                                             │   │
│  └─────────────────────────┬───────────────────────────────┘   │
│                            │                                   │
│         ┌──────────────────┼──────────────────┐               │
│         ▼                  ▼                  ▼               │
│  ┌────────────┐     ┌────────────┐     ┌────────────┐        │
│  │ Console    │     │   Json     │     │   Html     │        │
│  │ Reporter   │     │  Reporter  │     │  Reporter  │        │
│  └────────────┘     └────────────┘     └────────────┘        │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   TestFramework                          │   │
│  │  - Expect 断言类                                         │   │
│  │  - describe/it/beforeEach/afterEach                     │   │
│  │  - 测试类型定义                                           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Test Suites                           │   │
│  │  - DatabaseTestSuite                                     │   │
│  │  - ParserTestSuite                                       │   │
│  │  - NetworkTestSuite                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 核心组件

#### TestFramework.ets

| 项目 | 说明 |
|------|------|
| **功能** | 测试断言和组织框架 |
| **核心类** | `Expect` 断言类 |
| **组织函数** | `describe`, `it`, `beforeEach`, `afterEach` |

**断言方法：**

| 方法 | 说明 |
|------|------|
| `toBe(expected)` | 严格相等比较 |
| `toEqual(expected)` | 深度相等比较 |
| `toBeNull()` | 判断是否为 null |
| `toBeUndefined()` | 判断是否为 undefined |
| `toBeDefined()` | 判断是否已定义 |
| `toBeTruthy()` | 判断是否为真值 |
| `toBeFalsy()` | 判断是否为假值 |
| `toContain(item)` | 判断是否包含 |
| `toHaveLength(length)` | 判断长度 |
| `toBeGreaterThan(num)` | 大于比较 |
| `toBeLessThan(num)` | 小于比较 |
| `toThrow()` | 判断是否抛出异常 |
| `toBeInstanceOf(cls)` | 判断实例类型 |

#### TestRunner.ets

| 项目 | 说明 |
|------|------|
| **功能** | 测试执行引擎 |
| **特性** | 并行执行、覆盖率收集、多种报告器 |

**配置选项：**

```typescript
interface TestConfig {
  timeout: number;           // 超时时间，默认 5000ms
  retries: number;           // 重试次数，默认 0
  parallel: boolean;         // 并行执行，默认 false
  maxParallel: number;       // 最大并行数，默认 4
  coverage: boolean;         // 启用覆盖率，默认 true
  coverageThreshold: number; // 覆盖率阈值，默认 80%
  reporters: Reporter[];     // 报告器列表
  bail: boolean;             // 遇错即停，默认 false
  grep?: string | RegExp;    // 过滤测试
}
```

### 9.3 测试套件

#### DatabaseTestSuite

| 测试类别 | 测试内容 |
|---------|---------|
| 基础操作 | insert, update, delete, queryById, queryAll, search |
| 边界条件 | 空数据库、长字符串、特殊字符、并发操作、批量数据 |
| 异常处理 | 无效 ID、重复 ID、缺失字段、连接错误、事务回滚 |

#### ParserTestSuite

| 测试类别 | 测试内容 |
|---------|---------|
| JSON 解析 | 有效 JSON、带注释 JSON、数组、嵌套、Unicode |
| XML 解析 | 有效 XML、属性、嵌套、CDATA、命名空间 |
| HTML 解析 | 有效 HTML、自闭合标签、实体、DOCTYPE |
| CSV 解析 | 有效 CSV、引号值、分隔符检测、空行处理 |
| ParserFacade | 自动检测、缓存、验证、格式化 |
| 边界条件 | 空内容、大数据、深度嵌套、特殊字符 |
| 性能测试 | 时间限制、并发解析 |

#### NetworkTestSuite

| 测试类别 | 测试内容 |
|---------|---------|
| HTTP 请求 | GET, POST, PUT, DELETE, PATCH |
| 拦截器 | 请求拦截、响应拦截、优先级排序、错误处理 |
| 缓存 | 缓存命中、强制刷新、TTL、统计 |
| 重试 | 错误重试、超时重试、指数退避、条件重试 |
| 取消 | AbortController、按 ID 取消、批量取消、按标签取消 |
| 错误处理 | 404, 500, 超时、无效 URL、网络错误 |
| 边界条件 | 空响应、大响应、长 URL、特殊字符、并发请求 |
| 性能测试 | 时间限制、指标记录 |

### 9.4 测试覆盖率目标

| 模块 | 目标覆盖率 | 当前状态 |
|------|-----------|---------|
| ParserFacade | 85%+ | ✅ 已实现 |
| HttpClient | 85%+ | ✅ 已实现 |
| Database | 80%+ | ✅ 已实现 |
| BookSource | 75%+ | 待实现 |
| Reader | 75%+ | 待实现 |

---

## 十、API 文档体系

### 10.1 文档结构

```
docs/
├── API-Documentation-Standard.md  # 文档规范
├── API-Reference.md               # 完整 API 参考
├── ParserFacade-API.md            # 解析器 API
├── HttpClient-API.md              # 网络 API
└── 技术实施方案.md                  # 本文档
```

### 10.2 文档规范

#### 接口文档模板

每个 API 模块文档包含：

1. **概述** - 模块简介和主要功能
2. **接口清单** - 所有公开接口的列表
3. **详细接口说明** - 每个接口的详细文档
4. **数据模型** - 相关的数据类型定义
5. **错误码** - 可能的错误码及解决方案
6. **使用示例** - 完整的调用示例
7. **变更日志** - 接口变更记录

#### 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 接口名 | 小驼峰 | `getUserInfo`, `searchBooks` |
| 参数名 | 小驼峰 | `userId`, `bookName` |
| 布尔参数 | is/has/can 前缀 | `isEnabled`, `hasCover` |
| 时间戳 | Time 后缀 | `createTime`, `updateTime` |
| 数量 | Count 后缀 | `chapterCount`, `wordCount` |

### 10.3 错误码体系

#### 错误码格式

错误码采用 5 位数字格式：`AABBC`

- `AA`：模块代码
- `BB`：错误类型
- `C`：具体错误

#### 模块代码

| 模块 | 代码 |
|------|------|
| 通用 | 00 |
| 用户 | 01 |
| 书籍 | 02 |
| 书源 | 03 |
| 阅读 | 04 |
| 网络 | 05 |
| 数据库 | 06 |
| 解析器 | 07 |

#### 错误类型

| 类型 | 代码 |
|------|------|
| 参数错误 | 01 |
| 权限错误 | 02 |
| 资源不存在 | 03 |
| 操作失败 | 04 |
| 系统错误 | 05 |

#### 常用错误码

| 错误码 | 描述 | 解决方案 |
|-------|------|---------|
| 00000 | 成功 | - |
| 00101 | 参数缺失 | 检查必填参数 |
| 00102 | 参数格式错误 | 检查参数类型和格式 |
| 00201 | 未授权访问 | 先进行登录认证 |
| 00301 | 资源不存在 | 检查资源 ID 是否正确 |
| 00501 | 网络请求失败 | 检查网络连接 |
| 00502 | 网络超时 | 增加超时时间或重试 |
| 00601 | 数据库操作失败 | 检查数据格式和约束 |
| 00701 | 解析失败 | 检查内容格式 |

### 10.4 文档更新机制

#### DocUpdateManager.ets

| 组件 | 功能 |
|------|------|
| `DocVersionManager` | 版本管理、变更记录、变更日志生成 |
| `DocUpdateChecker` | 更新检查、建议生成 |
| `DocSyncManager` | 文档同步状态检查 |

#### 更新触发条件

1. **新增接口** - 新增公开 API 时必须同步更新文档
2. **接口变更** - 参数、返回值、行为发生变化时更新
3. **接口废弃** - 标记为废弃，说明替代方案
4. **错误码变更** - 新增或修改错误码时更新

#### 变更日志格式

```markdown
## [版本号] - YYYY-MM-DD

### 新增
- 新增接口：`接口名称` - 功能描述

### 变更
- 变更接口：`接口名称` - 变更描述

### 废弃
- 废弃接口：`接口名称` - 替代方案

### 移除
- 移除接口：`接口名称` - 移除原因

### 修复
- 修复问题：问题描述
```

---

> 文档版本: v3.0  
> 最后更新: 2026-02-17  
> 维护者: AstroRead Team

---

## 附录 D：鸿蒙代码专项评估报告

### D.1 鸿蒙 API 使用清单

| API 模块 | 导入方式 | 使用文件 | 功能描述 | 处理建议 |
|---------|---------|---------|---------|---------|
| `@kit.AbilityKit` | `import { UIAbility, Want, router } from '@kit.AbilityKit'` | EntryAbility.ets, 多个 ViewModel | 应用能力管理、页面路由 | ✅ 保留，核心功能 |
| `@kit.ArkUI` | `import { window } from '@kit.ArkUI'` | 多个 Page 文件 | 窗口管理、UI 组件 | ✅ 保留，核心功能 |
| `@kit.PerformanceAnalysisKit` | `import { hilog } from '@kit.PerformanceAnalysisKit'` | EntryAbility.ets | 日志输出 | ✅ 保留，调试需要 |
| `@ohos.data.relationalStore` | `import relationalStore from '@ohos.data.relationalStore'` | DatabaseManager.ets, 各 Repository | 关系型数据库 | ✅ 保留，核心存储 |
| `@ohos.app.ability.common` | `import common from '@ohos.app.ability.common'` | DatabaseManager.ets | 应用上下文 | ✅ 保留，必需依赖 |
| `@ohos.net.http` | `import http from '@ohos.net.http'` | HttpClient.ets | HTTP 网络请求 | ✅ 保留，网络核心 |
| `@ohos.file.fs` | `import fs from '@ohos.file.fs'` | FileManager.ets, EPUBParser.ets | 文件系统操作 | ✅ 保留，文件核心 |
| `@ohos.file.picker` | `import picker from '@ohos.file.picker'` | FileManager.ets | 文件选择器 | ✅ 保留，用户交互 |
| `@ohos.util` | `import util from '@ohos.util'` | FileManager.ets | 工具类（编码解码） | ✅ 保留，编码处理 |
| `@ohos.web.webview` | `import webview from '@ohos.web.webview'` | JSEngine.ets, WebReader.ets | WebView 组件 | ⚠️ 评估，可能可用 EnhancedJSEngine 替代 |
| `@ohos.zlib` | `import zlib from '@ohos.zlib'` | EPUBParser.ets | ZIP 解压 | ✅ 保留，EPUB 解析需要 |
| `@ohos/axios` | 第三方库 | AxiosNetworkManager.ets | Axios 网络库 | ✅ 保留，推荐使用 |
| `@ohos/imageknife` | 第三方库 | ImageKnifeManager.ets | 图片加载缓存 | ✅ 保留，图片核心 |

### D.2 代码模块评估

#### A. 必须保留的核心模块

| 模块 | 文件路径 | 鸿蒙依赖 | 评估结论 |
|------|---------|---------|---------|
| 应用入口 | `entryability/EntryAbility.ets` | @kit.AbilityKit, @kit.ArkUI | 必须保留，应用生命周期管理 |
| 数据库管理 | `utils/DatabaseManager.ets` | @ohos.data.relationalStore | 必须保留，数据持久化核心 |
| 文件管理 | `utils/FileManager.ets` | @ohos.file.fs, @ohos.file.picker | 必须保留，本地文件功能 |
| 网络请求 | `network/HttpClient.ets` | @ohos.net.http | 必须保留，HTTP 通信核心 |
| 图片加载 | `utils/ImageKnifeManager.ets` | @ohos/imageknife | 必须保留，图片缓存核心 |
| EPUB 解析 | `utils/EPUBParser.ets` | @ohos.zlib | 必须保留，电子书格式支持 |

#### B. 需要评估调整的模块

| 模块 | 文件路径 | 问题分析 | 处理方案 |
|------|---------|---------|---------|
| JS 引擎 | `utils/JSEngine.ets` | 依赖 @ohos.web.webview，可能存在性能问题 | 评估 EnhancedJSEngine 是否可替代 |
| 增强 JS 引擎 | `utils/EnhancedJSEngine.ets` | 自实现 JS 解释器，无 WebView 依赖 | 推荐使用，性能更好 |
| WebView 阅读 | `components/WebReader.ets` | 依赖 WebView 渲染网页内容 | 保留，特定场景需要 |

#### C. 可优化/合并的模块

| 模块 | 文件路径 | 问题分析 | 处理方案 |
|------|---------|---------|---------|
| 网络适配器 | `utils/NetworkAdapter.ets` | 与 AxiosNetworkManager 功能重叠 | 统一使用 AxiosNetworkManager |
| 网络管理 | `utils/NetworkManager.ets` | 与 HttpClient 功能重叠 | 统一使用 HttpClient |
| 网络管理(Axios) | `utils/AxiosNetworkManager.ets` | 推荐的网络实现 | 作为主要网络层 |

### D.3 鸿蒙代码处理优先级

| 优先级 | 处理类型 | 涉及模块 | 处理方式 |
|--------|---------|---------|---------|
| P0 | 立即处理 | NetworkAdapter, NetworkManager | 合并到统一网络层 |
| P1 | 短期处理 | JSEngine | 评估并迁移到 EnhancedJSEngine |
| P2 | 中期处理 | 各 Repository | 优化数据库操作，添加事务支持 |
| P3 | 长期优化 | 所有鸿蒙 API 调用 | 封装适配层，便于未来迁移 |

### D.4 跨平台兼容性考虑

为未来可能的跨平台需求，建议对鸿蒙 API 进行抽象封装：

```typescript
// interfaces/IPlatformAdapter.ets

/**
 * 平台适配器接口
 * 用于抽象平台相关功能，便于未来跨平台
 */
export interface IPlatformAdapter {
  // 文件系统
  readFile(path: string): Promise<string>;
  writeFile(path: string, content: string): Promise<void>;
  deleteFile(path: string): Promise<void>;
  
  // 网络
  httpRequest(url: string, options: RequestOptions): Promise<Response>;
  
  // 数据库
  initDatabase(config: DatabaseConfig): Promise<void>;
  executeSql(sql: string, params?: any[]): Promise<ResultSet>;
  
  // 存储
  getPreferences(key: string): Promise<string>;
  setPreferences(key: string, value: string): Promise<void>;
}

/**
 * 鸿蒙平台适配器实现
 */
export class HarmonyOSAdapter implements IPlatformAdapter {
  // 使用 @ohos.* API 实现
}
```

### D.5 鸿蒙 API 版本兼容性

| API | 最低版本 | 当前版本 | 兼容性说明 |
|-----|---------|---------|-----------|
| @kit.AbilityKit | API 9 | API 12 | 稳定，无废弃风险 |
| @kit.ArkUI | API 9 | API 12 | 稳定，无废弃风险 |
| @ohos.data.relationalStore | API 9 | API 12 | 稳定，推荐使用 |
| @ohos.net.http | API 9 | API 12 | 稳定，推荐使用 |
| @ohos.file.fs | API 9 | API 12 | 稳定，推荐使用 |
| @ohos.web.webview | API 9 | API 12 | 稳定，但性能需评估 |

### D.6 处理决策记录

| 决策ID | 决策内容 | 决策日期 | 决策理由 |
|--------|---------|---------|---------|
| D001 | 统一使用 AxiosNetworkManager | 2026-02-17 | Axios 提供更好的 API 设计和拦截器支持 |
| D002 | 优先使用 EnhancedJSEngine | 2026-02-17 | 避免 WebView 依赖，性能更好 |
| D003 | 保留 WebReader 组件 | 2026-02-17 | 某些书源需要 WebView 渲染 |
| D004 | 封装平台适配层 | 2026-02-17 | 为未来跨平台预留扩展性 |
