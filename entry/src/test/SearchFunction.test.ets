  /**
   * æœç´¢åŠŸèƒ½æµ‹è¯•å¥—ä»¶
   * åŒ…å«åŠŸèƒ½æµ‹è¯•ã€è¾¹ç•Œæµ‹è¯•å’Œå…¼å®¹æ€§æµ‹è¯•
   */

  import { describe, beforeAll, beforeEach, afterEach, afterAll, it, expect } from '@ohos/hypium';
  import { SearchResultBuilder, PagedSearchResult, SearchPaginationConfig, DEFAULT_PAGINATION_CONFIG } from '../main/ets/models/SearchResult';
  import { Book } from '../main/ets/models/Book';

  // æ¨¡æ‹Ÿä¹¦ç±æ•°æ®ç”Ÿæˆå™¨
  function createMockBook(overrides: Partial<Book> = {}): Book {
    const book: Book = {
      id: `book_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      name: 'æµ‹è¯•ä¹¦ç±',
      author: 'æµ‹è¯•ä½œè€…',
      cover: 'http://example.com/cover.jpg',
      intro: 'è¿™æ˜¯ä¸€æœ¬æµ‹è¯•ä¹¦ç±çš„ç®€ä»‹',
      kind: 'ç„å¹»',
      wordCount: 1000000,
      latestChapter: 'ç¬¬100ç«  æµ‹è¯•ç« èŠ‚',
      bookSourceId: 'source_1',
      bookSourceName: 'æµ‹è¯•ä¹¦æº',
      bookUrl: 'http://example.com/book/1',
      lastUpdateTime: Date.now(),
      addTime: Date.now(),
      readProgress: 0,
      lastReadChapter: undefined,
      lastReadChapterIndex: undefined,
      lastReadTime: 0,
      totalChapters: 100,
      currentChapterIndex: 0,
      currentChapterTitle: '',
      isInShelf: false
    };
    // æ‰‹åŠ¨åˆå¹¶è¦†ç›–å±æ€§
    if (overrides.id !== undefined) book.id = overrides.id;
    if (overrides.name !== undefined) book.name = overrides.name;
    if (overrides.author !== undefined) book.author = overrides.author;
    if (overrides.cover !== undefined) book.cover = overrides.cover;
    if (overrides.intro !== undefined) book.intro = overrides.intro;
    if (overrides.kind !== undefined) book.kind = overrides.kind;
    if (overrides.wordCount !== undefined) book.wordCount = overrides.wordCount;
    if (overrides.latestChapter !== undefined) book.latestChapter = overrides.latestChapter;
    if (overrides.bookSourceId !== undefined) book.bookSourceId = overrides.bookSourceId;
    if (overrides.bookSourceName !== undefined) book.bookSourceName = overrides.bookSourceName;
    if (overrides.bookUrl !== undefined) book.bookUrl = overrides.bookUrl;
    if (overrides.lastUpdateTime !== undefined) book.lastUpdateTime = overrides.lastUpdateTime;
    if (overrides.addTime !== undefined) book.addTime = overrides.addTime;
    if (overrides.readProgress !== undefined) book.readProgress = overrides.readProgress;
    if (overrides.lastReadChapter !== undefined) book.lastReadChapter = overrides.lastReadChapter;
    if (overrides.lastReadChapterIndex !== undefined) book.lastReadChapterIndex = overrides.lastReadChapterIndex;
    if (overrides.lastReadTime !== undefined) book.lastReadTime = overrides.lastReadTime;
    if (overrides.totalChapters !== undefined) book.totalChapters = overrides.totalChapters;
    if (overrides.currentChapterIndex !== undefined) book.currentChapterIndex = overrides.currentChapterIndex;
    if (overrides.currentChapterTitle !== undefined) book.currentChapterTitle = overrides.currentChapterTitle;
    if (overrides.isInShelf !== undefined) book.isInShelf = overrides.isInShelf;
    return book;
  }

  export default function searchFunctionTest() {
    describe('SearchFunctionTest', () => {

      // ==================== åŠŸèƒ½æµ‹è¯• ====================
      describe('åŠŸèƒ½æµ‹è¯•', () => {
        it('should_add_source_result_correctly', 0, () => {
          const builder = new SearchResultBuilder(DEFAULT_PAGINATION_CONFIG);
          const books: Book[] = [
            createMockBook({ name: 'å®Œç¾ä¸–ç•Œ', author: 'è¾°ä¸œ' }),
            createMockBook({ name: 'é®å¤©', author: 'è¾°ä¸œ' }),
            createMockBook({ name: 'ç¥å¢“', author: 'è¾°ä¸œ' })
          ];

          const newBooks = builder.addSourceResult('source_1', 'æµ‹è¯•ä¹¦æº1', books, true, undefined, 500);

          expect(newBooks.length).assertEqual(3);
          expect(builder.getTotalCount()).assertEqual(3);
        });

        it('should_deduplicate_books_with_same_name_and_author', 0, () => {
          const builder = new SearchResultBuilder(DEFAULT_PAGINATION_CONFIG);

          // ç¬¬ä¸€æ‰¹æ¬¡
          const books1: Book[] = [
            createMockBook({ name: 'å®Œç¾ä¸–ç•Œ', author: 'è¾°ä¸œ' }),
            createMockBook({ name: 'é®å¤©', author: 'è¾°ä¸œ' })
          ];
          builder.addSourceResult('source_1', 'ä¹¦æº1', books1, true, undefined, 500);

          // ç¬¬äºŒæ‰¹æ¬¡ - åŒ…å«é‡å¤ä¹¦ç±
          const books2: Book[] = [
            createMockBook({ name: 'å®Œç¾ä¸–ç•Œ', author: 'è¾°ä¸œ' }), // é‡å¤
            createMockBook({ name: 'åœ£å¢Ÿ', author: 'è¾°ä¸œ' })
          ];
          const newBooks = builder.addSourceResult('source_2', 'ä¹¦æº2', books2, true, undefined, 600);

          // åªæœ‰ä¸€æœ¬æ–°ä¹¦
          expect(newBooks.length).assertEqual(1);
          expect(newBooks[0].name).assertEqual('åœ£å¢Ÿ');
          expect(builder.getTotalCount()).assertEqual(3);
        });

        it('should_handle_empty_book_name', 0, () => {
          const builder = new SearchResultBuilder(DEFAULT_PAGINATION_CONFIG);
          const books: Book[] = [
            createMockBook({ name: '', author: 'ä½œè€…' }),
            createMockBook({ name: 'æœ‰æ•ˆä¹¦å', author: 'ä½œè€…' })
          ];

          const newBooks = builder.addSourceResult('source_1', 'ä¹¦æº1', books, true, undefined, 500);

          // ç©ºä¹¦åçš„ä¹¦ç±åº”è¯¥è¢«è·³è¿‡
          expect(newBooks.length).assertEqual(1);
          expect(newBooks[0].name).assertEqual('æœ‰æ•ˆä¹¦å');
        });

        it('should_set_default_author_for_empty_author', 0, () => {
          const builder = new SearchResultBuilder(DEFAULT_PAGINATION_CONFIG);
          const books: Book[] = [
            createMockBook({ name: 'æµ‹è¯•ä¹¦', author: '' })
          ];

          builder.addSourceResult('source_1', 'ä¹¦æº1', books, true, undefined, 500);
          const result = builder.build(1);

          expect(result.books[0].author).assertEqual('æœªçŸ¥ä½œè€…');
        });

        it('should_build_paged_result_correctly', 0, () => {
          const config: SearchPaginationConfig = {
            pageSize: 2,
            maxResultsPerSource: 10,
            maxTotalResults: 100,
            enableDeduplication: true,
            sortByRelevance: false
          };
          const builder = new SearchResultBuilder(config);

          const books: Book[] = [
            createMockBook({ name: 'ä¹¦1' }),
            createMockBook({ name: 'ä¹¦2' }),
            createMockBook({ name: 'ä¹¦3' }),
            createMockBook({ name: 'ä¹¦4' }),
            createMockBook({ name: 'ä¹¦5' })
          ];

          builder.addSourceResult('source_1', 'ä¹¦æº1', books, true, undefined, 500);

          const page1 = builder.build(1);
          expect(page1.books.length).assertEqual(2);
          expect(page1.totalCount).assertEqual(5);
          expect(page1.totalPages).assertEqual(3);
          expect(page1.hasMore).assertTrue();

          const page2 = builder.build(2);
          expect(page2.books.length).assertEqual(2);
          expect(page2.currentPage).assertEqual(2);

          const page3 = builder.build(3);
          expect(page3.books.length).assertEqual(1);
          expect(page3.hasMore).assertFalse();
        });
      });

      // ==================== è¾¹ç•Œæµ‹è¯• ====================
      describe('è¾¹ç•Œæµ‹è¯•', () => {
        it('should_handle_empty_search_result', 0, () => {
          const builder = new SearchResultBuilder(DEFAULT_PAGINATION_CONFIG);
          const result = builder.build(1);

          expect(result.books.length).assertEqual(0);
          expect(result.totalCount).assertEqual(0);
          expect(result.totalPages).assertEqual(1);
          expect(result.hasMore).assertFalse();
        });

        it('should_handle_very_long_book_name', 0, () => {
          const builder = new SearchResultBuilder(DEFAULT_PAGINATION_CONFIG);
          const longName = 'a'.repeat(500);
          const books: Book[] = [
            createMockBook({ name: longName, author: 'ä½œè€…' })
          ];

          const newBooks = builder.addSourceResult('source_1', 'ä¹¦æº1', books, true, undefined, 500);
          expect(newBooks.length).assertEqual(1);
          expect(newBooks[0].name.length).assertEqual(500);
        });

        it('should_handle_special_characters_in_book_name', 0, () => {
          const builder = new SearchResultBuilder(DEFAULT_PAGINATION_CONFIG);
          const books: Book[] = [
            createMockBook({ name: 'ã€Šå®Œç¾ä¸–ç•Œã€‹', author: 'è¾°ä¸œ' }),
            createMockBook({ name: 'å®Œç¾ä¸–ç•Œ!', author: 'è¾°ä¸œ' }),
            createMockBook({ name: 'å®Œç¾ä¸–ç•Œ?', author: 'è¾°ä¸œ' }),
            createMockBook({ name: 'å®Œç¾ä¸–ç•Œ  ', author: 'è¾°ä¸œ' }) // å°¾éƒ¨ç©ºæ ¼
          ];

          // è¿™äº›åº”è¯¥è¢«è§†ä¸ºé‡å¤ï¼ˆæ ‡å‡†åŒ–åï¼‰
          const newBooks1 = builder.addSourceResult('source_1', 'ä¹¦æº1', [books[0]], true, undefined, 500);
          const newBooks2 = builder.addSourceResult('source_2', 'ä¹¦æº2', [books[1]], true, undefined, 500);
          const newBooks3 = builder.addSourceResult('source_3', 'ä¹¦æº3', [books[2]], true, undefined, 500);
          const newBooks4 = builder.addSourceResult('source_4', 'ä¹¦æº4', [books[3]], true, undefined, 500);

          expect(newBooks1.length).assertEqual(1);
          expect(newBooks2.length).assertEqual(0); // é‡å¤
          expect(newBooks3.length).assertEqual(0); // é‡å¤
          expect(newBooks4.length).assertEqual(0); // é‡å¤
        });

        it('should_handle_page_number_out_of_range', 0, () => {
          const builder = new SearchResultBuilder(DEFAULT_PAGINATION_CONFIG);
          const books: Book[] = [createMockBook({ name: 'ä¹¦1' })];

          builder.addSourceResult('source_1', 'ä¹¦æº1', books, true, undefined, 500);

          // è¯·æ±‚è¶…å‡ºèŒƒå›´çš„é¡µç 
          const result = builder.build(100);
          expect(result.currentPage).assertEqual(1);
          expect(result.books.length).assertEqual(1);
        });

        it('should_handle_unicode_characters', 0, () => {
          const builder = new SearchResultBuilder(DEFAULT_PAGINATION_CONFIG);
          const books: Book[] = [
            createMockBook({ name: 'ğŸ“–å®Œç¾ä¸–ç•Œ', author: 'è¾°ä¸œ' }),
            createMockBook({ name: 'å®Œç¾ä¸–ç•ŒğŸ”¥', author: 'è¾°ä¸œ' }),
            createMockBook({ name: 'ğ“ğğ¬ğ­', author: 'ä½œè€…' })
          ];

          const newBooks = builder.addSourceResult('source_1', 'ä¹¦æº1', books, true, undefined, 500);
          expect(newBooks.length).assertEqual(3);
        });
      });

      // ==================== ç›¸å…³æ€§æ’åºæµ‹è¯• ====================
      describe('ç›¸å…³æ€§æ’åºæµ‹è¯•', () => {
        it('should_sort_by_relevance_correctly', 0, () => {
          const config: SearchPaginationConfig = {
            pageSize: 10,
            maxResultsPerSource: 10,
            maxTotalResults: 100,
            enableDeduplication: true,
            sortByRelevance: true
          };
          const builder = new SearchResultBuilder(config);

          // åˆ›å»ºä¸åŒè´¨é‡çš„ä¹¦ç±
          const books: Book[] = [
            createMockBook({
              name: 'ä½è´¨é‡ä¹¦',
              author: '',
              cover: '',
              intro: '',
              wordCount: 0
            }),
            createMockBook({
              name: 'é«˜è´¨é‡ä¹¦',
              author: 'çŸ¥åä½œè€…',
              cover: 'http://example.com/cover.jpg',
              intro: 'è¿™æ˜¯ä¸€æœ¬éå¸¸ç²¾å½©çš„å°è¯´ï¼Œå†…å®¹ä¸°å¯Œï¼Œæƒ…èŠ‚è·Œå®•èµ·ä¼ï¼Œå€¼å¾—ä¸€è¯»ã€‚',
              wordCount: 5000000,
              latestChapter: 'æœ€æ–°ç« èŠ‚',
              kind: 'ç„å¹»'
            }),
            createMockBook({
              name: 'ä¸­ç­‰è´¨é‡ä¹¦',
              author: 'æ™®é€šä½œè€…',
              cover: 'http://example.com/cover2.jpg',
              intro: 'ç®€ä»‹',
              wordCount: 1000000
            })
          ];

          builder.addSourceResult('source_1', 'ä¹¦æº1', books, true, undefined, 500);
          const result = builder.build(1);

          // é«˜è´¨é‡ä¹¦åº”è¯¥æ’åœ¨å‰é¢
          expect(result.books[0].name).assertEqual('é«˜è´¨é‡ä¹¦');
        });
      });

      // ==================== æ€§èƒ½æµ‹è¯• ====================
      describe('æ€§èƒ½æµ‹è¯•', () => {
        it('should_handle_large_number_of_books', 0, () => {
          const builder = new SearchResultBuilder(DEFAULT_PAGINATION_CONFIG);
          const startTime = Date.now();

          // æ·»åŠ å¤§é‡ä¹¦ç±
          for (let i = 0; i < 100; i++) {
            const books: Book[] = [
              createMockBook({ name: `ä¹¦ç±${i}`, author: `ä½œè€…${i % 10}` })
            ];
            builder.addSourceResult(`source_${i}`, `ä¹¦æº${i}`, books, true, undefined, 500);
          }

          const result = builder.build(1);
          const endTime = Date.now();

          expect(result.totalCount).assertEqual(100);
          // å¤„ç†100æœ¬ä¹¦åº”è¯¥åœ¨1ç§’å†…å®Œæˆ
          expect(endTime - startTime).assertLess(1000);
        });

        it('should_handle_many_duplicate_books_efficiently', 0, () => {
          const builder = new SearchResultBuilder(DEFAULT_PAGINATION_CONFIG);
          const startTime = Date.now();

          // æ·»åŠ å¤§é‡é‡å¤ä¹¦ç±
          for (let i = 0; i < 100; i++) {
            const books: Book[] = [
              createMockBook({ name: 'é‡å¤ä¹¦ç±', author: 'åŒä¸€ä½œè€…' })
            ];
            builder.addSourceResult(`source_${i}`, `ä¹¦æº${i}`, books, true, undefined, 500);
          }

          const result = builder.build(1);
          const endTime = Date.now();

          // å»é‡ååº”è¯¥åªæœ‰1æœ¬
          expect(result.totalCount).assertEqual(1);
          expect(endTime - startTime).assertLess(500);
        });
      });

      // ==================== å…¼å®¹æ€§æµ‹è¯• ====================
      describe('å…¼å®¹æ€§æµ‹è¯•', () => {
        it('should_handle_null_and_undefined_fields', 0, () => {
          const builder = new SearchResultBuilder(DEFAULT_PAGINATION_CONFIG);
          const books: Book[] = [
            {
              id: 'book_1',
              name: 'æµ‹è¯•ä¹¦',
              author: '',
              cover: '',
              intro: '',
              kind: '',
              wordCount: 0,
              latestChapter: '',
              bookSourceId: 'source_1',
              bookSourceName: 'ä¹¦æº1',
              bookUrl: 'http://example.com',
              lastUpdateTime: 0,
              addTime: 0,
              readProgress: 0,
              lastReadChapter: undefined,
              lastReadChapterIndex: undefined,
              lastReadTime: 0,
              totalChapters: 0,
              currentChapterIndex: 0,
              currentChapterTitle: '',
              isInShelf: false
            } as Book
          ];

          const newBooks = builder.addSourceResult('source_1', 'ä¹¦æº1', books, true, undefined, 500);
          expect(newBooks.length).assertEqual(1);
          expect(newBooks[0].author).assertEqual('æœªçŸ¥ä½œè€…');
        });

        it('should_handle_failed_source_gracefully', 0, () => {
          const builder = new SearchResultBuilder(DEFAULT_PAGINATION_CONFIG);

          // æˆåŠŸçš„ä¹¦æº
          const successBooks: Book[] = [createMockBook({ name: 'æˆåŠŸä¹¦ç±' })];
          builder.addSourceResult('source_1', 'ä¹¦æº1', successBooks, true, undefined, 500);

          // å¤±è´¥çš„ä¹¦æº
          builder.addSourceResult('source_2', 'ä¹¦æº2', [], false, 'ç½‘ç»œé”™è¯¯', 0);

          const result = builder.build(1);
          expect(result.books.length).assertEqual(1);
          expect(result.sourceStats.length).assertEqual(2);
          expect(result.sourceStats[1].success).assertFalse();
          expect(result.sourceStats[1].error).assertEqual('ç½‘ç»œé”™è¯¯');
        });
      });
    });
  }
