/**
 * SafeRegex å•å…ƒæµ‹è¯•
 * æµ‹è¯•æ­£åˆ™è¡¨è¾¾å¼å®‰å…¨æ‰§è¡ŒåŠŸèƒ½
 */

import { SafeRegex } from '../SafeRegex';

export class SafeRegexTest {
  private passed: number = 0;
  private failed: number = 0;

  /**
   * æµ‹è¯•å®‰å…¨çš„æ­£åˆ™è¡¨è¾¾å¼æ‰§è¡Œ
   */
  testSafeExecute(): boolean {
    const testCases = [
      {
        pattern: /hello/g,
        input: 'hello world hello',
        expected: ['hello', 'hello'],
        description: 'å…¨å±€åŒ¹é…'
      },
      {
        pattern: /\d+/,
        input: 'abc123def',
        expected: ['123'],
        description: 'æ•°å­—åŒ¹é…'
      },
      {
        pattern: /^test$/,
        input: 'test',
        expected: ['test'],
        description: 'ç²¾ç¡®åŒ¹é…'
      },
      {
        pattern: /no-match/,
        input: 'hello world',
        expected: null,
        description: 'æ— åŒ¹é…'
      },
    ];

    let allPassed = true;

    for (const testCase of testCases) {
      try {
        const result = SafeRegex.safeExecute(testCase.pattern, testCase.input);

        if (testCase.expected === null) {
          if (result !== null) {
            console.error(`âŒ testSafeExecute: ${testCase.description}`);
            console.error(`   æœŸæœ›: null, å®é™…: ${JSON.stringify(result)}`);
            this.failed++;
            allPassed = false;
            continue;
          }
        } else {
          if (result === null) {
            console.error(`âŒ testSafeExecute: ${testCase.description}`);
            console.error(`   æœŸæœ›: ${JSON.stringify(testCase.expected)}, å®é™…: null`);
            this.failed++;
            allPassed = false;
            continue;
          }

          if (result.length !== testCase.expected.length) {
            console.error(`âŒ testSafeExecute: ${testCase.description}`);
            console.error(`   æœŸæœ›é•¿åº¦: ${testCase.expected.length}, å®é™…é•¿åº¦: ${result.length}`);
            this.failed++;
            allPassed = false;
            continue;
          }
        }

        console.log(`âœ… ${testCase.description}`);
      } catch (error) {
        console.error(`âŒ testSafeExecute: ${testCase.description}`);
        console.error(`   å¼‚å¸¸: ${error instanceof Error ? error.message : String(error)}`);
        this.failed++;
        allPassed = false;
      }
    }

    if (allPassed) {
      this.passed++;
      console.log('âœ… testSafeExecute passed');
    }

    return allPassed;
  }

  /**
   * æµ‹è¯•ReDoSé˜²æŠ¤
   */
  testReDoSProtection(): boolean {
    // æ„é€ å¯èƒ½å¯¼è‡´ReDoSçš„æ¨¡å¼
    const evilPattern = /(a+)+$/;
    const evilInput = 'a'.repeat(100) + 'b'; // è¿™ç§è¾“å…¥ä¼šå¯¼è‡´ç¾éš¾æ€§å›æº¯

    try {
      const startTime = Date.now();
      const result = SafeRegex.safeExecute(evilPattern, evilInput, { timeout: 100 });
      const endTime = Date.now();

      // åº”è¯¥è¿”å›nullï¼ˆè¶…æ—¶ï¼‰è€Œä¸æ˜¯å¡ä½
      if (result !== null) {
        console.error('âŒ testReDoSProtection: åº”è¯¥è¶…æ—¶è¿”å›null');
        this.failed++;
        return false;
      }

      // æ‰§è¡Œæ—¶é—´åº”è¯¥æ¥è¿‘è¶…æ—¶æ—¶é—´è€Œä¸æ˜¯å¾ˆé•¿
      if (endTime - startTime > 200) {
        console.error(`âŒ testReDoSProtection: æ‰§è¡Œæ—¶é—´è¿‡é•¿ (${endTime - startTime}ms)`);
        this.failed++;
        return false;
      }

      console.log('âœ… ReDoSé˜²æŠ¤æµ‹è¯•é€šè¿‡');
      this.passed++;
      console.log('âœ… testReDoSProtection passed');
      return true;
    } catch (error) {
      console.error(`âŒ testReDoSProtection: å¼‚å¸¸ ${error instanceof Error ? error.message : String(error)}`);
      this.failed++;
      return false;
    }
  }

  /**
   * æµ‹è¯•æ­£åˆ™è¡¨è¾¾å¼éªŒè¯
   */
  testValidatePattern(): boolean {
    const testCases = [
      {
        pattern: /simple/,
        shouldBeValid: true,
        description: 'ç®€å•æ¨¡å¼'
      },
      {
        pattern: /(a+)+/,
        shouldBeValid: false,
        description: 'å±é™©æ¨¡å¼ - åµŒå¥—é‡è¯'
      },
      {
        pattern: /(a*)*/,
        shouldBeValid: false,
        description: 'å±é™©æ¨¡å¼ - åµŒå¥—æ˜Ÿå·'
      },
      {
        pattern: /(a+)*b+/,
        shouldBeValid: false,
        description: 'å±é™©æ¨¡å¼ - æ··åˆåµŒå¥—'
      },
      {
        pattern: /(?:a+)+/,
        shouldBeValid: false,
        description: 'å±é™©æ¨¡å¼ - éæ•è·ç»„åµŒå¥—'
      },
    ];

    let allPassed = true;

    for (const testCase of testCases) {
      const isValid = SafeRegex.validatePattern(testCase.pattern);

      if (isValid !== testCase.shouldBeValid) {
        console.error(`âŒ testValidatePattern: ${testCase.description}`);
        console.error(`   æœŸæœ›: ${testCase.shouldBeValid ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ'}, å®é™…: ${isValid ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ'}`);
        this.failed++;
        allPassed = false;
      } else {
        console.log(`âœ… ${testCase.description}`);
      }
    }

    if (allPassed) {
      this.passed++;
      console.log('âœ… testValidatePattern passed');
    }

    return allPassed;
  }

  /**
   * æµ‹è¯•å­—ç¬¦ä¸²è½¬ä¹‰
   */
  testEscapeString(): boolean {
    const testCases = [
      {
        input: 'hello.world',
        expected: 'hello\\.world',
        description: 'è½¬ä¹‰ç‚¹å·'
      },
      {
        input: 'a*b+c?',
        expected: 'a\\*b\\+c\\?',
        description: 'è½¬ä¹‰é‡è¯'
      },
      {
        input: '[test]',
        expected: '\\[test\\]',
        description: 'è½¬ä¹‰æ–¹æ‹¬å·'
      },
      {
        input: '(group)',
        expected: '\\(group\\)',
        description: 'è½¬ä¹‰åœ†æ‹¬å·'
      },
      {
        input: 'normal',
        expected: 'normal',
        description: 'æ— éœ€è½¬ä¹‰'
      },
    ];

    let allPassed = true;

    for (const testCase of testCases) {
      const result = SafeRegex.escapeString(testCase.input);

      if (result !== testCase.expected) {
        console.error(`âŒ testEscapeString: ${testCase.description}`);
        console.error(`   æœŸæœ›: "${testCase.expected}", å®é™…: "${result}"`);
        this.failed++;
        allPassed = false;
      } else {
        console.log(`âœ… ${testCase.description}`);
      }
    }

    if (allPassed) {
      this.passed++;
      console.log('âœ… testEscapeString passed');
    }

    return allPassed;
  }

  /**
   * æµ‹è¯•åˆ›å»ºå®‰å…¨æ­£åˆ™
   */
  testCreateSafeRegex(): boolean {
    const testCases = [
      {
        pattern: 'hello',
        flags: '',
        shouldSucceed: true,
        description: 'ç®€å•å­—ç¬¦ä¸²'
      },
      {
        pattern: '(a+)+',
        flags: '',
        shouldSucceed: false,
        description: 'å±é™©æ¨¡å¼'
      },
      {
        pattern: '\\d+',
        flags: 'g',
        shouldSucceed: true,
        description: 'å¸¦è½¬ä¹‰å­—ç¬¦'
      },
    ];

    let allPassed = true;

    for (const testCase of testCases) {
      try {
        const result = SafeRegex.createSafeRegex(testCase.pattern, testCase.flags);

        if (testCase.shouldSucceed) {
          if (result === null) {
            console.error(`âŒ testCreateSafeRegex: ${testCase.description}`);
            console.error(`   æœŸæœ›: æˆåŠŸ, å®é™…: å¤±è´¥`);
            this.failed++;
            allPassed = false;
          } else {
            console.log(`âœ… ${testCase.description}`);
          }
        } else {
          if (result !== null) {
            console.error(`âŒ testCreateSafeRegex: ${testCase.description}`);
            console.error(`   æœŸæœ›: å¤±è´¥, å®é™…: æˆåŠŸ`);
            this.failed++;
            allPassed = false;
          } else {
            console.log(`âœ… ${testCase.description}`);
          }
        }
      } catch (error) {
        if (testCase.shouldSucceed) {
          console.error(`âŒ testCreateSafeRegex: ${testCase.description}`);
          console.error(`   å¼‚å¸¸: ${error instanceof Error ? error.message : String(error)}`);
          this.failed++;
          allPassed = false;
        } else {
          console.log(`âœ… ${testCase.description} (é¢„æœŸå¤±è´¥)`);
        }
      }
    }

    if (allPassed) {
      this.passed++;
      console.log('âœ… testCreateSafeRegex passed');
    }

    return allPassed;
  }

  /**
   * æµ‹è¯•æµ‹è¯•æ–¹æ³•ï¼ˆä»…æµ‹è¯•ï¼Œä¸æå–ï¼‰
   */
  testSafeTest(): boolean {
    const testCases = [
      {
        pattern: /hello/,
        input: 'hello world',
        expected: true,
        description: 'åŒ¹é…æˆåŠŸ'
      },
      {
        pattern: /test/,
        input: 'hello world',
        expected: false,
        description: 'åŒ¹é…å¤±è´¥'
      },
    ];

    let allPassed = true;

    for (const testCase of testCases) {
      try {
        const result = SafeRegex.safeTest(testCase.pattern, testCase.input);

        if (result !== testCase.expected) {
          console.error(`âŒ testSafeTest: ${testCase.description}`);
          console.error(`   æœŸæœ›: ${testCase.expected}, å®é™…: ${result}`);
          this.failed++;
          allPassed = false;
        } else {
          console.log(`âœ… ${testCase.description}`);
        }
      } catch (error) {
        console.error(`âŒ testSafeTest: ${testCase.description}`);
        console.error(`   å¼‚å¸¸: ${error instanceof Error ? error.message : String(error)}`);
        this.failed++;
        allPassed = false;
      }
    }

    if (allPassed) {
      this.passed++;
      console.log('âœ… testSafeTest passed');
    }

    return allPassed;
  }

  /**
   * è¿è¡Œæ‰€æœ‰æµ‹è¯•
   */
  async runAllTests(): Promise<boolean> {
    console.log('ğŸš€ Starting SafeRegex tests...\n');

    this.testSafeExecute();
    this.testReDoSProtection();
    this.testValidatePattern();
    this.testEscapeString();
    this.testCreateSafeRegex();
    this.testSafeTest();

    const total: number = this.passed + this.failed;
    console.log(`\nğŸ“Š Test Results: ${this.passed}/${total} tests passed`);

    if (this.failed > 0) {
      console.log(`âŒ ${this.failed} tests failed`);
    } else {
      console.log('âœ… All tests passed!');
    }

    return this.failed === 0;
  }
}

// å¯¼å‡ºæµ‹è¯•å®ä¾‹
const safeRegexTest: SafeRegexTest = new SafeRegexTest();
export default safeRegexTest;
