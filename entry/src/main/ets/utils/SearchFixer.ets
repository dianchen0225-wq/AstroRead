/**
 * SearchFixer - æœç´¢åŠŸèƒ½ä¿®å¤å·¥å…·
 * é›†æˆæ‰€æœ‰ä¿®å¤æ–¹æ¡ˆ,ä¸€é”®ä¿®å¤æœç´¢åŠŸèƒ½
 */

import { Logger } from './performance/Logger';
import { sourceCleaner } from './SourceCleaner';
import { enhancedSourceHealthManager, HealthStatistics } from './EnhancedSourceHealthManager';
import { networkDiagnostics } from './NetworkDiagnostics';
import { BookSourceManager } from './validation/BookSourceManager';
import { BookSource } from '../models/BookSource';

export interface FixReport {
  timestamp: string;
  networkStatus: string;
  failedSourcesCount: number;
  disabledSourcesCount: number;
  recommendations: string[];
}

export class SearchFixer {
  private static instance: SearchFixer | null = null;
  private readonly TAG = 'SearchFixer';

  private constructor() {}

  static getInstance(): SearchFixer {
    if (!SearchFixer.instance) {
      SearchFixer.instance = new SearchFixer();
    }
    return SearchFixer.instance;
  }

  /**
   * æ‰§è¡Œå®Œæ•´ä¿®å¤æµç¨‹
   */
  async performFullFix(): Promise<FixReport> {
    Logger.info(this.TAG, '=== å¼€å§‹æ‰§è¡Œæœç´¢åŠŸèƒ½ä¿®å¤ ===');

    const report: FixReport = {
      timestamp: new Date().toLocaleString(),
      networkStatus: '',
      failedSourcesCount: 0,
      disabledSourcesCount: 0,
      recommendations: []
    };

    try {
      // æ­¥éª¤1: æ£€æµ‹ç½‘ç»œè¿æ¥
      Logger.info(this.TAG, 'æ­¥éª¤1: æ£€æµ‹ç½‘ç»œè¿æ¥...');
      const networkStatus = await networkDiagnostics.checkNetworkConnection();
      report.networkStatus = networkStatus.isConnected 
        ? `å·²è¿æ¥ (å»¶è¿Ÿ: ${networkStatus.latency}ms)` 
        : 'æœªè¿æ¥';

      if (!networkStatus.isConnected) {
        report.recommendations.push('âŒ ç½‘ç»œæœªè¿æ¥,è¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®');
        Logger.error(this.TAG, 'ç½‘ç»œæœªè¿æ¥,ä¿®å¤ç»ˆæ­¢');
        return report;
      }

      // æ­¥éª¤2: åŒæ­¥ä¹¦æºæ•°æ®åˆ°å¥åº·åº¦ç®¡ç†å™¨
      Logger.info(this.TAG, 'æ­¥éª¤2: åŒæ­¥ä¹¦æºæ•°æ®...');
      const bookSourceManager = BookSourceManager.getInstance();
      const allSources = bookSourceManager.getAllSources();
      const enabledSources = bookSourceManager.getEnabledSources();

      Logger.info(this.TAG, `ä» BookSourceManager è·å–åˆ° ${allSources.length} ä¸ªä¹¦æº, å…¶ä¸­å¯ç”¨ ${enabledSources.length} ä¸ª`);

      // å°†ä¹¦æºåŒæ­¥åˆ°å¥åº·åº¦ç®¡ç†å™¨
      for (const source of allSources) {
        enhancedSourceHealthManager.initializeSourceIfNeeded(source.id, source.name, source.url, source.metadata.enabled);
      }

      // æ­¥éª¤3: æ¸…ç†å¤±æ•ˆä¹¦æº
      Logger.info(this.TAG, 'æ­¥éª¤3: æ¸…ç†å¤±æ•ˆä¹¦æº...');
      await sourceCleaner.cleanupFailedSources();
      const failedSources = sourceCleaner.getFailedSourceNames();
      report.failedSourcesCount = failedSources.length;

      if (failedSources.length > 0) {
        report.recommendations.push(`âš ï¸ å·²è¯†åˆ« ${failedSources.length} ä¸ªå¤±æ•ˆä¹¦æº,å»ºè®®ç¦ç”¨`);
        for (const sourceName of failedSources) {
          report.recommendations.push(`   - ${sourceName}`);
        }
      }

      // æ­¥éª¤4: æ›´æ–°ä¹¦æºå¥åº·åº¦
      Logger.info(this.TAG, 'æ­¥éª¤4: æ›´æ–°ä¹¦æºå¥åº·åº¦...');
      const healthStats = enhancedSourceHealthManager.getStatistics();
      report.disabledSourcesCount = healthStats.disabled;

      Logger.info(this.TAG, `ä¹¦æºç»Ÿè®¡: æ€»æ•°=${healthStats.total}, å¯ç”¨=${healthStats.enabled}, ç¦ç”¨=${healthStats.disabled}, æ°¸ä¹…ç¦ç”¨=${healthStats.permanentlyDisabled}`);

      // å¦‚æœç»Ÿè®¡ä¸º0ä½†å®é™…æœ‰ä¹¦æºï¼Œä½¿ç”¨å®é™…ä¹¦æºæ•°é‡
      if (healthStats.total === 0 && allSources.length > 0) {
        Logger.warn(this.TAG, `å¥åº·åº¦ç®¡ç†å™¨ç»Ÿè®¡ä¸º0,ä½†å®é™…æœ‰ ${allSources.length} ä¸ªä¹¦æº,ä½¿ç”¨å®é™…æ•°é‡`);
        report.recommendations.push(`ğŸ“Š ä¹¦æºæ€»æ•°: ${allSources.length} ä¸ª`);
        report.recommendations.push(`âœ… å¯ç”¨ä¹¦æº: ${enabledSources.length} ä¸ª`);
      }

      // æ­¥éª¤5: ç”Ÿæˆå¥åº·æŠ¥å‘Š
      Logger.info(this.TAG, 'æ­¥éª¤5: ç”Ÿæˆå¥åº·æŠ¥å‘Š...');
      const healthReport = enhancedSourceHealthManager.generateHealthReport();
      Logger.info(this.TAG, healthReport);

      // æ­¥éª¤6: ç”Ÿæˆå»ºè®®
      Logger.info(this.TAG, 'æ­¥éª¤6: ç”Ÿæˆä¿®å¤å»ºè®®...');
      // åˆ›å»ºåŒ…å«å®é™…ä¹¦æºæ•°é‡çš„ç»Ÿè®¡
      const actualStats: HealthStatistics = healthStats.total === 0 && allSources.length > 0
        ? { total: allSources.length, enabled: enabledSources.length, disabled: allSources.length - enabledSources.length, permanentlyDisabled: 0, avgScore: 50 }
        : healthStats;
      this.generateRecommendations(report, actualStats);

      Logger.info(this.TAG, '=== æœç´¢åŠŸèƒ½ä¿®å¤å®Œæˆ ===');

    } catch (error) {
      Logger.error(this.TAG, `ä¿®å¤è¿‡ç¨‹å‡ºé”™: ${error}`);
      report.recommendations.push(`âŒ ä¿®å¤è¿‡ç¨‹å‡ºé”™: ${error}`);
    }

    return report;
  }

  /**
   * ç”Ÿæˆä¿®å¤å»ºè®®
   */
  private generateRecommendations(report: FixReport, healthStats: HealthStatistics): void {
    if (healthStats.enabled === 0) {
      report.recommendations.push('âŒ æ²¡æœ‰å¯ç”¨çš„ä¹¦æº,è¯·å¯¼å…¥æ–°çš„ä¹¦æº');
    } else if (healthStats.enabled < 5) {
      report.recommendations.push(`âš ï¸ å¯ç”¨ä¹¦æºè¾ƒå°‘(${healthStats.enabled}ä¸ª),å»ºè®®å¯¼å…¥æ›´å¤šä¹¦æº`);
    } else {
      report.recommendations.push(`âœ“ æœ‰ ${healthStats.enabled} ä¸ªå¯ç”¨ä¹¦æº`);
    }

    if (healthStats.permanentlyDisabled > 0) {
      report.recommendations.push(`âš ï¸ æœ‰ ${healthStats.permanentlyDisabled} ä¸ªä¹¦æºè¢«æ°¸ä¹…ç¦ç”¨,å»ºè®®åˆ é™¤è¿™äº›ä¹¦æº`);
    }

    if (healthStats.avgScore < 30) {
      report.recommendations.push('âš ï¸ ä¹¦æºå¹³å‡å¥åº·åº¦è¾ƒä½,å»ºè®®æ›´æ–°ä¹¦æº');
    } else if (healthStats.avgScore > 70) {
      report.recommendations.push('âœ“ ä¹¦æºå¥åº·åº¦è‰¯å¥½');
    }
  }

  /**
   * å¿«é€Ÿè¯Šæ–­
   */
  async quickDiagnosis(): Promise<string> {
    const report: string[] = [];

    report.push('=== å¿«é€Ÿè¯Šæ–­ ===');

    // æ£€æµ‹ç½‘ç»œ
    const isConnected = await networkDiagnostics.quickNetworkCheck();
    report.push(`ç½‘ç»œçŠ¶æ€: ${isConnected ? 'âœ“ å·²è¿æ¥' : 'âœ— æœªè¿æ¥'}`);

    // æ£€æŸ¥ä¹¦æº - ä» BookSourceManager è·å–å®é™…ä¹¦æºæ•°é‡
    const bookSourceManager = BookSourceManager.getInstance();
    const allSources = bookSourceManager.getAllSources();
    const enabledSources = bookSourceManager.getEnabledSources();

    // åŒæ­¥åˆ°å¥åº·åº¦ç®¡ç†å™¨
    for (const source of allSources) {
      enhancedSourceHealthManager.initializeSourceIfNeeded(source.id, source.name, source.url, source.metadata.enabled);
    }

    const stats = enhancedSourceHealthManager.getStatistics();
    const total = stats.total > 0 ? stats.total : allSources.length;
    const enabled = stats.enabled > 0 ? stats.enabled : enabledSources.length;
    report.push(`ä¹¦æºçŠ¶æ€: ${enabled}/${total} å¯ç”¨`);

    // æ£€æŸ¥å¤±æ•ˆä¹¦æº
    const failedSources = sourceCleaner.getFailedSourceNames();
    report.push(`å¤±æ•ˆä¹¦æº: ${failedSources.length} ä¸ª`);

    return report.join('\n');
  }

  /**
   * ç”Ÿæˆå®Œæ•´æŠ¥å‘Š
   */
  async generateFullReport(): Promise<string> {
    const report: string[] = [];

    report.push('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    report.push('â•‘     æœç´¢åŠŸèƒ½è¯Šæ–­ä¸ä¿®å¤æŠ¥å‘Š          â•‘');
    report.push('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    report.push('');

    // 1. ç½‘ç»œè¯Šæ–­
    report.push('ã€ç½‘ç»œè¯Šæ–­ã€‘');
    const networkReport = await networkDiagnostics.generateDiagnosticReport();
    report.push(networkReport);
    report.push('');

    // 2. ä¹¦æºæ¸…ç†
    report.push('ã€ä¹¦æºæ¸…ç†ã€‘');
    const cleanupReport = sourceCleaner.generateCleanupReport();
    report.push(cleanupReport);
    report.push('');

    // 3. å¥åº·åº¦æŠ¥å‘Š
    report.push('ã€å¥åº·åº¦æŠ¥å‘Šã€‘');
    const healthReport = enhancedSourceHealthManager.generateHealthReport();
    report.push(healthReport);
    report.push('');

    // 4. ä¿®å¤å»ºè®®
    report.push('ã€ä¿®å¤å»ºè®®ã€‘');
    const fixReport = await this.performFullFix();
    for (const recommendation of fixReport.recommendations) {
      report.push(recommendation);
    }
    report.push('');

    report.push(`æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}`);

    return report.join('\n');
  }
}

export const searchFixer = SearchFixer.getInstance();
