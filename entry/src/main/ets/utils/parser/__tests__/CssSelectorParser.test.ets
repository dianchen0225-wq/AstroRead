/**
 * CssSelectorParser XPath å¢å¼ºåŠŸèƒ½æµ‹è¯•
 */

import { CssSelectorParser } from '../CssSelectorParser';

export class CssSelectorParserTest {
  private passed: number = 0;
  private failed: number = 0;

  /**
   * è¿è¡Œæ‰€æœ‰æµ‹è¯•
   */
  async runAllTests(): Promise<boolean> {
    console.log('\nğŸ“‹ CssSelectorParser XPath å¢å¼ºæµ‹è¯•\n');

    // æµ‹è¯• convertXPathToCss æ–¹æ³•
    this.testConvertXPathToCss();

    // æµ‹è¯• XPath é€‰æ‹©å™¨
    this.testXPathSelectors();

    // è¾“å‡ºç»“æœ
    console.log(`\nğŸ“Š æµ‹è¯•ç»“æœ: ${this.passed} é€šè¿‡, ${this.failed} å¤±è´¥`);

    return this.failed === 0;
  }

  /**
   * æµ‹è¯• convertXPathToCss æ–¹æ³•
   */
  private testConvertXPathToCss(): void {
    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
    console.log('  convertXPathToCss æµ‹è¯•');
    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');

    const testCases: Array<{ xpath: string; expected: string; description: string }> = [
      // 1. //tag -> tag (åä»£é€‰æ‹©å™¨)
      { xpath: '//div', expected: 'div', description: '//tag è½¬æ¢ä¸º tag' },
      { xpath: '//span', expected: 'span', description: '//span è½¬æ¢ä¸º span' },

      // 2. /tag -> > tag (å­é€‰æ‹©å™¨)
      { xpath: '//div/span', expected: 'div > span', description: '//div/span è½¬æ¢ä¸º div > span' },
      { xpath: '//table/tr/td', expected: 'table > tr > td', description: '//table/tr/td è½¬æ¢ä¸º table > tr > td' },

      // 3. [@class="value"] -> .value
      { xpath: '//div[@class="content"]', expected: 'div.content', description: '[@class="value"] è½¬æ¢ä¸º .value' },
      { xpath: '//span[@class="highlight active"]', expected: 'span.highlight.active', description: 'å¤šclassè½¬æ¢ä¸ºå¤šclassé€‰æ‹©å™¨' },

      // 4. [@id="value"] -> #value
      { xpath: '//div[@id="main"]', expected: 'div#main', description: '[@id="value"] è½¬æ¢ä¸º #value' },

      // 5. [N] -> :nth-of-type(N)
      { xpath: '//div[1]', expected: 'div:nth-of-type(1)', description: '[N] è½¬æ¢ä¸º :nth-of-type(N)' },
      { xpath: '//tr[3]', expected: 'tr:nth-of-type(3)', description: '[3] è½¬æ¢ä¸º :nth-of-type(3)' },

      // 6. @attr -> [attr]
      { xpath: '//div[@data-id]', expected: 'div[data-id]', description: '[@attr] è½¬æ¢ä¸º [attr]' },

      // 7. [contains(@class,"value")] -> [class*="value"]
      { xpath: '//div[contains(@class,"item")]', expected: 'div[class*="item"]', description: 'contains(@class) è½¬æ¢ä¸º [class*=]' },
      { xpath: '//a[contains(@href,"example")]', expected: 'a[href*="example"]', description: 'contains(@href) è½¬æ¢ä¸º [href*=]' },

      // 8. [starts-with(@attr,"value")] -> [attr^="value"]
      { xpath: '//a[starts-with(@href,"https")]', expected: 'a[href^="https"]', description: 'starts-with è½¬æ¢ä¸º [attr^=]' },

      // 9. [ends-with(@attr,"value")] -> [attr$="value"]
      { xpath: '//img[ends-with(@src,".png")]', expected: 'img[src$=".png"]', description: 'ends-with è½¬æ¢ä¸º [attr$=]' },

      // 10. å¤æ‚ç»„åˆ
      { xpath: '//div[@class="container"]//span[@class="text"]', expected: 'div.container span.text', description: 'å¤æ‚åä»£é€‰æ‹©å™¨' },
      { xpath: '//ul/li[2]/a', expected: 'ul > li:nth-of-type(2) > a', description: 'è·¯å¾„+ç´¢å¼•ç»„åˆ' },

      // 11. position() è¯­æ³•
      { xpath: '//tr[position()>1]', expected: 'tr:nth-of-type(n+1)', description: 'position()>N' },
      { xpath: '//li[position()=3]', expected: 'li:nth-of-type(3)', description: 'position()=N' },

      // 12. last() è¯­æ³•
      { xpath: '//tr[last()]', expected: 'tr:last-of-type', description: 'last()' },
      { xpath: '//tr[last()-1]', expected: 'tr:nth-last-of-type(1)', description: 'last()-N' },

      // 13. not() è¯­æ³•
      { xpath: '//div[not(@class)]', expected: 'div:not([class])', description: 'not(@attr)' },
      { xpath: '//div[not(contains(@class,"exclude"))]', expected: 'div:not([class*="exclude"])', description: 'not(contains())' },
    ];

    for (const testCase of testCases) {
      const result = CssSelectorParser.convertXPathToCss(testCase.xpath);
      const passed = result === testCase.expected;

      if (passed) {
        this.passed++;
        console.log(`  âœ… ${testCase.description}`);
        console.log(`     ${testCase.xpath} -> ${result}`);
      } else {
        this.failed++;
        console.log(`  âŒ ${testCase.description}`);
        console.log(`     è¾“å…¥: ${testCase.xpath}`);
        console.log(`     æœŸæœ›: ${testCase.expected}`);
        console.log(`     å®é™…: ${result}`);
      }
    }
  }

  /**
   * æµ‹è¯• XPath é€‰æ‹©å™¨
   */
  private testXPathSelectors(): void {
    console.log('\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
    console.log('  XPath é€‰æ‹©å™¨æµ‹è¯•');
    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');

    const testHtml = `
      <html>
        <body>
          <div id="main" class="container">
            <h1 class="title">æ ‡é¢˜</h1>
            <div class="content">
              <p class="text">ç¬¬ä¸€æ®µ</p>
              <p class="text highlight">ç¬¬äºŒæ®µ</p>
              <p class="text">ç¬¬ä¸‰æ®µ</p>
            </div>
            <ul class="list">
              <li>é¡¹ç›®1</li>
              <li>é¡¹ç›®2</li>
              <li>é¡¹ç›®3</li>
            </ul>
          </div>
          <div class="sidebar">
            <a href="https://example.com" class="link">é“¾æ¥</a>
          </div>
        </body>
      </html>
    `;

    const testCases: Array<{ xpath: string; expectedCount: number; description: string }> = [
      { xpath: '//div', expectedCount: 3, description: '//div é€‰æ‹©æ‰€æœ‰div' },
      { xpath: '//div[@class="container"]', expectedCount: 1, description: '//div[@class="container"] é€‰æ‹©ç‰¹å®šclassçš„div' },
      { xpath: '//div[@id="main"]', expectedCount: 1, description: '//div[@id="main"] é€‰æ‹©ç‰¹å®šidçš„div' },
      { xpath: '//p[@class="text"]', expectedCount: 3, description: '//p[@class="text"] é€‰æ‹©æ‰€æœ‰textç±»çš„p' },
      { xpath: '//p[1]', expectedCount: 1, description: '//p[1] é€‰æ‹©ç¬¬ä¸€ä¸ªp' },
      { xpath: '//ul/li', expectedCount: 3, description: '//ul/li é€‰æ‹©ulä¸‹çš„li' },
      { xpath: '//div[@class="content"]/p', expectedCount: 3, description: '//div[@class="content"]/p é€‰æ‹©content divä¸‹çš„p' },
      { xpath: '//div//p', expectedCount: 3, description: '//div//p é€‰æ‹©divåä»£ä¸­çš„æ‰€æœ‰p' },
      { xpath: '//a[contains(@href,"example")]', expectedCount: 1, description: '//a[contains(@href,"example")]' },
      { xpath: '//li[last()]', expectedCount: 1, description: '//li[last()] é€‰æ‹©æœ€åä¸€ä¸ªli' },
    ];

    for (const testCase of testCases) {
      const elements = CssSelectorParser.selectElements(testHtml, testCase.xpath);
      const passed = elements.length === testCase.expectedCount;

      if (passed) {
        this.passed++;
        console.log(`  âœ… ${testCase.description}`);
        console.log(`     ${testCase.xpath} -> æ‰¾åˆ° ${elements.length} ä¸ªå…ƒç´ `);
      } else {
        this.failed++;
        console.log(`  âŒ ${testCase.description}`);
        console.log(`     é€‰æ‹©å™¨: ${testCase.xpath}`);
        console.log(`     æœŸæœ›: ${testCase.expectedCount} ä¸ªå…ƒç´ `);
        console.log(`     å®é™…: ${elements.length} ä¸ªå…ƒç´ `);
      }
    }
  }
}

// å¯¼å‡ºæµ‹è¯•å®ä¾‹
const cssSelectorParserTest = new CssSelectorParserTest();
export default cssSelectorParserTest;
