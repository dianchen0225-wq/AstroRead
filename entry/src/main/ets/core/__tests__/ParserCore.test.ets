import { ParserCore, ParserResult } from '../../utils/ParserCore';
import { JsonPathParser } from '../../utils/parsers/JsonPathParser';
import { RegexParser } from '../../utils/parsers/RegexParser';
import { XPathParser } from '../../utils/parsers/XPathParser';
import type { Result } from '../Result';

export class ParserCoreTest {
  private passed: number = 0;
  private failed: number = 0;

  testJsonPathParserBasic(): boolean {
    const json: string = '{"name": "å¼ ä¸‰", "age": 25}';
    const result: Result<ParserResult> = JsonPathParser.parse(json, '$.name');

    if (result.isErr()) {
      console.error('âŒ testJsonPathParserBasic: parse should succeed');
      this.failed++;
      return false;
    }

    const data: ParserResult = result.data!;
    if (data.value !== 'å¼ ä¸‰') {
      console.error('âŒ testJsonPathParserBasic: value should be "å¼ ä¸‰"');
      this.failed++;
      return false;
    }

    console.log('âœ… testJsonPathParserBasic passed');
    this.passed++;
    return true;
  }

  testJsonPathParserNested(): boolean {
    const json: string = '{"user": {"profile": {"name": "æå››"}}}';
    const result: Result<ParserResult> = JsonPathParser.parse(json, '$.user.profile.name');

    if (result.isErr()) {
      console.error('âŒ testJsonPathParserNested: parse should succeed');
      this.failed++;
      return false;
    }

    const data: ParserResult = result.data!;
    if (data.value !== 'æå››') {
      console.error('âŒ testJsonPathParserNested: value should be "æå››"');
      this.failed++;
      return false;
    }

    console.log('âœ… testJsonPathParserNested passed');
    this.passed++;
    return true;
  }

  testJsonPathParserArray(): boolean {
    const json: string = '{"items": [{"id": 1}, {"id": 2}, {"id": 3}]}';
    const result: Result<ParserResult> = JsonPathParser.parse(json, '$.items');

    if (result.isErr()) {
      console.error('âŒ testJsonPathParserArray: parse should succeed');
      this.failed++;
      return false;
    }

    const data: ParserResult = result.data!;
    if (!Array.isArray(data.raw)) {
      console.error('âŒ testJsonPathParserArray: raw should be array');
      this.failed++;
      return false;
    }

    console.log('âœ… testJsonPathParserArray passed');
    this.passed++;
    return true;
  }

  testJsonPathParserInvalidJson(): boolean {
    const invalidJson: string = 'not a json';
    const result: Result<ParserResult> = JsonPathParser.parse(invalidJson, '$.name');

    if (result.isOk()) {
      console.error('âŒ testJsonPathParserInvalidJson: should return error for invalid JSON');
      this.failed++;
      return false;
    }

    console.log('âœ… testJsonPathParserInvalidJson passed');
    this.passed++;
    return true;
  }

  testRegexParserBasic(): boolean {
    const html: string = '<div class="content">Hello World</div>';
    const result: Result<ParserResult> = RegexParser.parse(html, '<div[^>]*>([^<]+)</div>');

    if (result.isErr()) {
      console.error('âŒ testRegexParserBasic: parse should succeed');
      this.failed++;
      return false;
    }

    const data: ParserResult = result.data!;
    if (data.value !== 'Hello World') {
      console.error('âŒ testRegexParserBasic: value should be "Hello World"');
      this.failed++;
      return false;
    }

    console.log('âœ… testRegexParserBasic passed');
    this.passed++;
    return true;
  }

  testRegexParserMultiple(): boolean {
    const html: string = '<a href="link1">Link1</a><a href="link2">Link2</a>';
    const result: Result<ParserResult> = RegexParser.parse(html, '<a[^>]*>([^<]+)</a>');

    if (result.isErr()) {
      console.error('âŒ testRegexParserMultiple: parse should succeed');
      this.failed++;
      return false;
    }

    const data: ParserResult = result.data!;
    if (data.values.length !== 2) {
      console.error('âŒ testRegexParserMultiple: should find 2 matches');
      this.failed++;
      return false;
    }

    console.log('âœ… testRegexParserMultiple passed');
    this.passed++;
    return true;
  }

  testRegexParserFirst(): boolean {
    const text: string = 'Price: $100, Discount: $20';
    const result: Result<string> = RegexParser.parseFirst(text, '\\$(\\d+)');

    if (result.isErr()) {
      console.error('âŒ testRegexParserFirst: parse should succeed');
      this.failed++;
      return false;
    }

    const data: string = result.data!;
    if (data !== '100') {
      console.error('âŒ testRegexParserFirst: value should be "100"');
      this.failed++;
      return false;
    }

    console.log('âœ… testRegexParserFirst passed');
    this.passed++;
    return true;
  }

  testRegexParserReplace(): boolean {
    const text: string = 'Hello World';
    const result: string = RegexParser.replace(text, 'World', 'ArkTS');

    if (result !== 'Hello ArkTS') {
      console.error('âŒ testRegexParserReplace: result should be "Hello ArkTS"');
      this.failed++;
      return false;
    }

    console.log('âœ… testRegexParserReplace passed');
    this.passed++;
    return true;
  }

  testRegexParserEscape(): boolean {
    const escaped: string = RegexParser.escapeRegex('a.b*c+d?');

    if (escaped !== 'a\\.b\\*c\\+d\\?') {
      console.error('âŒ testRegexParserEscape: escape result incorrect');
      this.failed++;
      return false;
    }

    console.log('âœ… testRegexParserEscape passed');
    this.passed++;
    return true;
  }

  testXPathParserBasic(): boolean {
    const html: string = '<root><item>Value1</item><item>Value2</item></root>';
    const result: Result<ParserResult> = XPathParser.parse(html, '//item');

    if (result.isErr()) {
      console.error('âŒ testXPathParserBasic: parse should succeed');
      this.failed++;
      return false;
    }

    const data: ParserResult = result.data!;
    if (data.values.length !== 2) {
      console.error(`âŒ testXPathParserBasic: should find 2 items, found ${data.values.length}`);
      this.failed++;
      return false;
    }

    console.log('âœ… testXPathParserBasic passed');
    this.passed++;
    return true;
  }

  testXPathParserAttribute(): boolean {
    const html: string = '<div class="test" id="main">Content</div>';
    const result: Result<ParserResult> = XPathParser.parse(html, '//div[@class="test"]');

    if (result.isErr()) {
      console.error('âŒ testXPathParserAttribute: parse should succeed');
      this.failed++;
      return false;
    }

    const data: ParserResult = result.data!;
    if (data.values.length !== 1) {
      console.error(`âŒ testXPathParserAttribute: should find 1 item, found ${data.values.length}`);
      this.failed++;
      return false;
    }

    console.log('âœ… testXPathParserAttribute passed');
    this.passed++;
    return true;
  }

  testXPathParserPosition(): boolean {
    const html: string = '<ul><li>First</li><li>Second</li><li>Third</li></ul>';
    const result: Result<ParserResult> = XPathParser.parse(html, '//li[1]');

    if (result.isErr()) {
      console.error('âŒ testXPathParserPosition: parse should succeed');
      this.failed++;
      return false;
    }

    const data: ParserResult = result.data!;
    if (data.value !== 'First') {
      console.error(`âŒ testXPathParserPosition: value should be "First", got "${data.value}"`);
      this.failed++;
      return false;
    }

    console.log('âœ… testXPathParserPosition passed');
    this.passed++;
    return true;
  }

  testXPathParserContains(): boolean {
    const html: string = '<div class="container main"><span>Content</span></div>';
    const result: Result<ParserResult> = XPathParser.parse(html, '//div[contains(@class, "main")]');

    if (result.isErr()) {
      console.error('âŒ testXPathParserContains: parse should succeed');
      this.failed++;
      return false;
    }

    const data: ParserResult = result.data!;
    if (data.values.length !== 1) {
      console.error(`âŒ testXPathParserContains: should find 1 item, found ${data.values.length}`);
      this.failed++;
      return false;
    }

    console.log('âœ… testXPathParserContains passed');
    this.passed++;
    return true;
  }

  testXPathParserNestedPath(): boolean {
    const html: string = '<div class="outer"><div class="inner"><span>Nested Content</span></div></div>';
    const result: Result<ParserResult> = XPathParser.parse(html, '//div[@class="outer"]//span');

    if (result.isErr()) {
      console.error('âŒ testXPathParserNestedPath: parse should succeed');
      this.failed++;
      return false;
    }

    const data: ParserResult = result.data!;
    if (data.value !== 'Nested Content') {
      console.error(`âŒ testXPathParserNestedPath: value should be "Nested Content", got "${data.value}"`);
      this.failed++;
      return false;
    }

    console.log('âœ… testXPathParserNestedPath passed');
    this.passed++;
    return true;
  }

  testXPathParserLast(): boolean {
    const html: string = '<ul><li>First</li><li>Second</li><li>Third</li></ul>';
    const result: Result<ParserResult> = XPathParser.parse(html, '//li[last()]');

    if (result.isErr()) {
      console.error('âŒ testXPathParserLast: parse should succeed');
      this.failed++;
      return false;
    }

    const data: ParserResult = result.data!;
    if (data.value !== 'Third') {
      console.error(`âŒ testXPathParserLast: value should be "Third", got "${data.value}"`);
      this.failed++;
      return false;
    }

    console.log('âœ… testXPathParserLast passed');
    this.passed++;
    return true;
  }

  testXPathParserWildcard(): boolean {
    const html: string = '<div><span>A</span><p>B</p><a>C</a></div>';
    const result: Result<ParserResult> = XPathParser.parse(html, '//div/*');

    if (result.isErr()) {
      console.error('âŒ testXPathParserWildcard: parse should succeed');
      this.failed++;
      return false;
    }

    const data: ParserResult = result.data!;
    if (data.values.length !== 3) {
      console.error(`âŒ testXPathParserWildcard: should find 3 items, found ${data.values.length}`);
      this.failed++;
      return false;
    }

    console.log('âœ… testXPathParserWildcard passed');
    this.passed++;
    return true;
  }

  testParserCoreJsonPath(): boolean {
    const json: string = '{"result": "success"}';
    const result: Result<ParserResult> = ParserCore.parse(json, '$.result');

    if (result.isErr()) {
      console.error('âŒ testParserCoreJsonPath: parse should succeed');
      this.failed++;
      return false;
    }

    const data: ParserResult = result.data!;
    if (data.value !== 'success') {
      console.error('âŒ testParserCoreJsonPath: value should be "success"');
      this.failed++;
      return false;
    }

    console.log('âœ… testParserCoreJsonPath passed');
    this.passed++;
    return true;
  }

  testParserCoreRegex(): boolean {
    const html: string = '<title>Page Title</title>';
    const result: Result<ParserResult> = ParserCore.parse(html, '##<title>([^<]+)</title>');

    if (result.isErr()) {
      console.error('âŒ testParserCoreRegex: parse should succeed');
      this.failed++;
      return false;
    }

    const data: ParserResult = result.data!;
    if (data.value !== 'Page Title') {
      console.error('âŒ testParserCoreRegex: value should be "Page Title"');
      this.failed++;
      return false;
    }

    console.log('âœ… testParserCoreRegex passed');
    this.passed++;
    return true;
  }

  testParserCoreXPath(): boolean {
    const html: string = '<root><name>Test</name></root>';
    const result: Result<ParserResult> = ParserCore.parse(html, '//name');

    if (result.isErr()) {
      console.error('âŒ testParserCoreXPath: parse should succeed');
      this.failed++;
      return false;
    }

    console.log('âœ… testParserCoreXPath passed');
    this.passed++;
    return true;
  }

  testParserCoreEmptyInput(): boolean {
    const result: Result<ParserResult> = ParserCore.parse('', '$.test');

    if (result.isOk()) {
      console.error('âŒ testParserCoreEmptyInput: should return error for empty input');
      this.failed++;
      return false;
    }

    console.log('âœ… testParserCoreEmptyInput passed');
    this.passed++;
    return true;
  }

  testParserCoreParseList(): boolean {
    const html: string = '<ul><li>Item1</li><li>Item2</li><li>Item3</li></ul>';
    const result: Result<string[]> = ParserCore.parseList(html, '//li');

    if (result.isErr()) {
      console.error('âŒ testParserCoreParseList: parse should succeed');
      this.failed++;
      return false;
    }

    const data: string[] = result.data!;
    if (data.length !== 3) {
      console.error('âŒ testParserCoreParseList: should find 3 items');
      this.failed++;
      return false;
    }

    console.log('âœ… testParserCoreParseList passed');
    this.passed++;
    return true;
  }

  testParserCoreParseValue(): boolean {
    const json: string = '{"key": "value"}';
    const result: Result<string> = ParserCore.parseValue(json, '$.key');

    if (result.isErr()) {
      console.error('âŒ testParserCoreParseValue: parse should succeed');
      this.failed++;
      return false;
    }

    const data: string = result.data!;
    if (data !== 'value') {
      console.error('âŒ testParserCoreParseValue: value should be "value"');
      this.failed++;
      return false;
    }

    console.log('âœ… testParserCoreParseValue passed');
    this.passed++;
    return true;
  }

  async runAllTests(): Promise<boolean> {
    console.log('ğŸš€ Starting ParserCore tests...');

    this.testJsonPathParserBasic();
    this.testJsonPathParserNested();
    this.testJsonPathParserArray();
    this.testJsonPathParserInvalidJson();
    this.testRegexParserBasic();
    this.testRegexParserMultiple();
    this.testRegexParserFirst();
    this.testRegexParserReplace();
    this.testRegexParserEscape();
    this.testXPathParserBasic();
    this.testXPathParserAttribute();
    this.testXPathParserPosition();
    this.testXPathParserContains();
    this.testXPathParserNestedPath();
    this.testXPathParserLast();
    this.testXPathParserWildcard();
    this.testParserCoreJsonPath();
    this.testParserCoreRegex();
    this.testParserCoreXPath();
    this.testParserCoreEmptyInput();
    this.testParserCoreParseList();
    this.testParserCoreParseValue();

    const total: number = this.passed + this.failed;
    console.log(`\nğŸ“Š Test Results: ${this.passed}/${total} tests passed`);

    if (this.failed === 0) {
      console.log('âœ… All ParserCore tests passed!');
      return true;
    } else {
      console.log('âŒ Some ParserCore tests failed');
      return false;
    }
  }
}

const parserCoreTest: ParserCoreTest = new ParserCoreTest();
export default parserCoreTest;
