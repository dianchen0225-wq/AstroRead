import { themeManager } from '../common/ThemeManager';
import { DesignSystem } from '../common/DesignSystem';
import { BookSourceViewModel } from '../viewmodel/BookSourceViewModel';
import { BookViewModel } from '../viewmodel/BookViewModel';
import { BookSource } from '../models/BookSource';
import { Book } from '../models/Book';
import { Logger } from '../utils/Logger';
import { promptAction } from '@kit.ArkUI';

interface RankColor {
  light: string;
  dark: string;
}

@ComponentV2
export struct SearchPage {
  @Local isLightMode: boolean = true;
  @Local searchText: string = '';
  @Local searchHistory: string[] = ['ÊñóÁ†¥ËãçÁ©π', 'Âá°‰∫∫‰øÆ‰ªô‰º†', '‰∏â‰Ωì', 'Ê¥ªÁùÄ'];
  @Local hotSearchList: string[] = ['ÂÆåÁæé‰∏ñÁïå', 'Èõ™‰∏≠ÊÇçÂàÄË°å', 'ËØ°Áßò‰πã‰∏ª', 'Â∫Ü‰ΩôÂπ¥', 'ËµòÂ©ø'];
  @Local searchResults: Book[] = [];
  @Local isSearching: boolean = false;
  @Local hasSearched: boolean = false;
  @Local errorMessage: string = '';

  private bookSourceViewModel: BookSourceViewModel = new BookSourceViewModel();
  private bookViewModel: BookViewModel = new BookViewModel();
  private bookSources: BookSource[] = [];
  private themeListener: (isDark: boolean) => void = (isDark: boolean) => {
    this.isLightMode = !isDark;
  };

  aboutToAppear(): void {
    this.isLightMode = themeManager.isLightTheme();
    themeManager.addListener(this.themeListener);
    this.loadBookSources();
  }

  aboutToDisappear(): void {
    themeManager.removeListener(this.themeListener);
  }

  /**
   * Âä†ËΩΩ‰π¶Ê∫ê
   */
  private async loadBookSources(): Promise<void> {
    try {
      this.bookSources = await this.bookSourceViewModel.loadEnabledBookSources();
      Logger.info('SearchPage', `Âä†ËΩΩ‰∫Ü${this.bookSources.length}‰∏™‰π¶Ê∫ê`);
    } catch (error) {
      Logger.error('SearchPage', `Âä†ËΩΩ‰π¶Ê∫êÂ§±Ë¥•: ${error}`);
    }
  }

  /**
   * ÊâßË°åÊêúÁ¥¢
   */
  private async performSearch(): Promise<void> {
    if (!this.searchText.trim()) {
      return;
    }

    this.isSearching = true;
    this.hasSearched = true;
    this.errorMessage = '';
    this.searchResults = [];

    try {
      Logger.info('SearchPage', `ÂºÄÂßãÊêúÁ¥¢: ${this.searchText}`);

      if (this.bookSources.length === 0) {
        await this.loadBookSources();
      }

      if (this.bookSources.length === 0) {
        this.errorMessage = 'Ê≤°ÊúâÂèØÁî®ÁöÑ‰π¶Ê∫êÔºåËØ∑ÂÖàÂØºÂÖ•‰π¶Ê∫ê';
        this.isSearching = false;
        return;
      }

      // ‰ΩøÁî®Ââç5‰∏™ÂêØÁî®ÁöÑ‰π¶Ê∫êËøõË°åÊêúÁ¥¢
      const sourcesToUse = this.bookSources.slice(0, 5);
      Logger.info('SearchPage', `‰ΩøÁî®${sourcesToUse.length}‰∏™‰π¶Ê∫êËøõË°åÊêúÁ¥¢`);

      const results = await this.bookViewModel.searchBooks(this.searchText.trim(), sourcesToUse);

      this.searchResults = results;
      Logger.info('SearchPage', `ÊêúÁ¥¢ÂÆåÊàêÔºåÊâæÂà∞${results.length}Êú¨‰π¶`);

      if (results.length === 0) {
        this.errorMessage = 'Êú™ÊâæÂà∞Áõ∏ÂÖ≥‰π¶Á±çÔºåËØ∑Â∞ùËØïÂÖ∂‰ªñÂÖ≥ÈîÆËØç';
      }

      // Ê∑ªÂä†Âà∞ÊêúÁ¥¢ÂéÜÂè≤
      this.addToSearchHistory(this.searchText.trim());

    } catch (error) {
      Logger.error('SearchPage', `ÊêúÁ¥¢Â§±Ë¥•: ${error}`);
      this.errorMessage = `ÊêúÁ¥¢Â§±Ë¥•: ${error instanceof Error ? error.message : 'Êú™Áü•ÈîôËØØ'}`;
    } finally {
      this.isSearching = false;
    }
  }

  /**
   * Ê∑ªÂä†Âà∞ÊêúÁ¥¢ÂéÜÂè≤
   */
  private addToSearchHistory(keyword: string): void {
    const trimmedKeyword = keyword.trim();
    if (!trimmedKeyword) {
      return;
    }

    // ÁßªÈô§ÈáçÂ§çÈ°π
    this.searchHistory = this.searchHistory.filter(item => item !== trimmedKeyword);

    // Ê∑ªÂä†Âà∞ÂºÄÂ§¥
    this.searchHistory.unshift(trimmedKeyword);

    // ÈôêÂà∂ÂéÜÂè≤ËÆ∞ÂΩïÊï∞Èáè
    if (this.searchHistory.length > 10) {
      this.searchHistory = this.searchHistory.slice(0, 10);
    }
  }

  /**
   * Ê∑ªÂä†Âà∞‰π¶Êû∂
   */
  private async addToBookshelf(book: Book): Promise<void> {
    try {
      await this.bookViewModel.addBook(book);
      promptAction.showToast({
        message: 'Â∑≤Ê∑ªÂä†Âà∞‰π¶Êû∂',
        duration: 2000
      });
    } catch (error) {
      Logger.error('SearchPage', `Ê∑ªÂä†Âà∞‰π¶Êû∂Â§±Ë¥•: ${error}`);
      promptAction.showToast({
        message: 'Ê∑ªÂä†Â§±Ë¥•',
        duration: 2000
      });
    }
  }

  build() {
    Column() {
      // È°∂ÈÉ®ÂØºËà™
      Row() {
        Row() {
          Text('‚Äπ')
            .fontSize(20)
            .fontColor(DesignSystem.getPrimaryColor(this.isLightMode))
        }
        .width(32)
        .height(32)
        .borderRadius(16)
        .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
        .justifyContent(FlexAlign.Center)
        .margin({ right: 15 })

        Text($r('app.string.search_books'))
          .fontSize(18)
          .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
          .fontWeight(600)
          .layoutWeight(1)
      }
      .width('100%')
      .padding({ left: 15, right: 20, top: 15, bottom: 15 })
      .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
      .border({
        width: { bottom: 1 },
        color: DesignSystem.getBorderColor(this.isLightMode)
      })

      // ÂÜÖÂÆπÂå∫Âüü
      Scroll() {
        Column() {
          // ÊêúÁ¥¢Ê†è
          Row() {
            Text('üîç')
              .fontSize(18)
              .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
              .margin({ right: 10 })

            TextInput({ placeholder: $r('app.string.search_placeholder'), text: this.searchText })
              .layoutWeight(1)
              .backgroundColor(Color.Transparent)
              .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
              .placeholderColor(this.isLightMode ? '#666' : '#8a7f6e')
              .onChange((value: string) => {
                this.searchText = value;
              })
              .onSubmit(() => {
                this.performSearch();
              })

            Button($r('app.string.search_button'))
              .fontSize(14)
              .fontColor(DesignSystem.Colors.text.primary.light)
              .backgroundColor(DesignSystem.getPrimaryColor(this.isLightMode))
              .borderRadius(8)
              .padding({ left: 15, right: 15, top: 8, bottom: 8 })
              .margin({ left: 10 })
              .enabled(!this.isSearching)
              .onClick(() => {
                this.performSearch();
              })
          }
          .width('100%')
          .padding(15)
          .borderRadius(12)
          .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
          .border({
            width: 1,
            color: DesignSystem.getBorderColor(this.isLightMode)
          })
          .margin({ bottom: 20 })

          // ÊêúÁ¥¢‰∏≠Áä∂ÊÄÅ
          if (this.isSearching) {
            Column() {
              LoadingProgress()
                .width(40)
                .height(40)
                .color(DesignSystem.getPrimaryColor(this.isLightMode))
              Text('Ê≠£Âú®ÊêúÁ¥¢...')
                .fontSize(14)
                .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                .margin({ top: 10 })
            }
            .width('100%')
            .height(200)
            .justifyContent(FlexAlign.Center)
          }

          // ÊêúÁ¥¢ÁªìÊûú
          if (this.hasSearched && !this.isSearching) {
            if (this.errorMessage) {
              Column() {
                Text('üòî')
                  .fontSize(40)
                Text(this.errorMessage)
                  .fontSize(14)
                  .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                  .margin({ top: 10 })
                  .textAlign(TextAlign.Center)
              }
              .width('100%')
              .height(200)
              .justifyContent(FlexAlign.Center)
            } else if (this.searchResults.length > 0) {
              Column() {
                Text(`ÊâæÂà∞ ${this.searchResults.length} Êú¨‰π¶Á±ç`)
                  .fontSize(14)
                  .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                  .width('100%')
                  .margin({ bottom: 12 })

                ForEach(this.searchResults, (book: Book) => {
                  Row() {
                    // Â∞ÅÈù¢
                    if (book.cover) {
                      Image(book.cover)
                        .width(60)
                        .height(80)
                        .borderRadius(4)
                        .objectFit(ImageFit.Cover)
                    } else {
                      Column() {
                        Text('üìñ')
                          .fontSize(24)
                      }
                      .width(60)
                      .height(80)
                      .borderRadius(4)
                      .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
                      .justifyContent(FlexAlign.Center)
                    }

                    // ‰π¶Á±ç‰ø°ÊÅØ
                    Column() {
                      Text(book.name)
                        .fontSize(16)
                        .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
                        .fontWeight(500)
                        .maxLines(1)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })

                      if (book.author) {
                        Text(book.author)
                          .fontSize(12)
                          .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                          .margin({ top: 4 })
                      }

                      if (book.intro) {
                        Text(book.intro)
                          .fontSize(12)
                          .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                          .margin({ top: 4 })
                          .maxLines(2)
                          .textOverflow({ overflow: TextOverflow.Ellipsis })
                      }

                      if (book.bookSourceName) {
                        Text(`Êù•Ê∫ê: ${book.bookSourceName}`)
                          .fontSize(10)
                          .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                          .margin({ top: 4 })
                      }
                    }
                    .layoutWeight(1)
                    .alignItems(HorizontalAlign.Start)
                    .margin({ left: 12 })

                    Button('Âä†ÂÖ•‰π¶Êû∂')
                      .fontSize(12)
                      .fontColor(DesignSystem.Colors.text.primary.light)
                      .backgroundColor(DesignSystem.getPrimaryColor(this.isLightMode))
                      .borderRadius(6)
                      .padding({ left: 8, right: 8, top: 6, bottom: 6 })
                      .margin({ left: 8 })
                      .onClick(() => {
                        this.addToBookshelf(book);
                      })
                  }
                  .width('100%')
                  .padding(12)
                  .margin({ bottom: 8 })
                  .borderRadius(8)
                  .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
                })
              }
              .width('100%')
            }
          }

          // ÊêúÁ¥¢ÂéÜÂè≤ÔºàÊú™ÊêúÁ¥¢Êó∂ÊòæÁ§∫Ôºâ
          if (!this.hasSearched) {
            Column() {
              Row() {
                Text($r('app.string.search_history'))
                  .fontSize(14)
                  .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                  .fontWeight(500)

                Blank()

                Text($r('app.string.clear_history'))
                  .fontSize(12)
                  .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                  .onClick(() => {
                    this.searchHistory = [];
                  })
              }
              .width('100%')
              .margin({ bottom: 12 })

              Flex({ wrap: FlexWrap.Wrap }) {
                ForEach(this.searchHistory, (item: string) => {
                  Text(item)
                    .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                    .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
                    .borderRadius(15)
                    .fontSize(12)
                    .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                    .margin({ right: 8, bottom: 8 })
                    .onClick(() => {
                      this.searchText = item;
                      this.performSearch();
                    })
                })
              }
            }
            .width('100%')
            .margin({ bottom: 25 })

            // ÁÉ≠Èó®ÊêúÁ¥¢
            Column() {
              Text($r('app.string.hot_search'))
                .width('100%')
                .fontSize(14)
                .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                .fontWeight(500)
                .margin({ bottom: 12 })

              Column() {
                ForEach(this.hotSearchList, (item: string, index: number) => {
                  Row() {
                    Text((index + 1).toString())
                      .width(20)
                      .height(20)
                      .borderRadius(10)
                      .backgroundColor(this.getRankColor(index))
                      .fontColor(DesignSystem.Colors.text.primary.light)
                      .fontSize(12)
                      .fontWeight(600)
                      .textAlign(TextAlign.Center)
                      .margin({ right: 12 })

                    Text(item)
                      .fontSize(14)
                      .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
                  }
                  .width('100%')
                  .margin({ bottom: 12 })
                  .onClick(() => {
                    this.searchText = item;
                    this.performSearch();
                  })
                })
              }
            }
            .width('100%')
          }
        }
        .width('100%')
        .padding(20)
      }
      .width('100%')
      .layoutWeight(1)
      .align(Alignment.Top)
      .scrollBar(BarState.Auto)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(DesignSystem.getPrimaryBackgroundColor(this.isLightMode))
  }

  private getRankColor(index: number): string {
    const rankColors: RankColor[] = [
      { light: '#e8d9b0', dark: '#d4b483' },
      { light: '#ede0c3', dark: '#e0c595' },
      { light: '#f2e8d6', dark: '#eddfc8' }
    ];
    const color = rankColors[index] || rankColors[0];
    return this.isLightMode ? color.light : color.dark;
  }
}
