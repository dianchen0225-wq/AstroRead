/**
 * Copyright (c) 2025 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import { themeManager } from '../common/ThemeManager';
import { DesignSystem } from '../common/DesignSystem';
import { viewModelManager } from '../viewmodel/ViewModelManager';
import { BookSource } from '../models/BookSource';
import { Book } from '../models/Book';
import { Logger } from '../utils/Logger';
import { AlertDialog, DialogAlignment } from '@kit.ArkUI';
import { router } from '@kit.ArkUI';
import { common } from '@kit.AbilityKit';
import { NetworkManager } from '../utils/NetworkManager';

interface RankColor {
  light: string;
  dark: string;
}

@ComponentV2
export struct SearchPage {
  @Local isLightMode: boolean = true;
  @Local searchText: string = '';
  @Local searchHistory: string[] = [];
  @Local hotSearchList: string[] = ['å®Œç¾ä¸–ç•Œ', 'é›ªä¸­æ‚åˆ€è¡Œ', 'è¯¡ç§˜ä¹‹ä¸»', 'åº†ä½™å¹´', 'èµ˜å©¿'];
  @Local searchResults: Book[] = [];
  @Local isSearching: boolean = false;
  @Local hasSearched: boolean = false;
  @Local errorMessage: string = '';
  @Local hasEnabledSources: boolean = true;

  private bookSources: BookSource[] = [];
  private isComponentActive: boolean = false;
  private themeListener: (isDark: boolean) => void = (isDark: boolean) => {
    this.isLightMode = !isDark;
  };

  aboutToAppear(): void {
    this.isComponentActive = true;
    this.isLightMode = themeManager.isLightTheme();
    themeManager.addListener(this.themeListener);
    
    const context = this.getUIContext().getHostContext() as common.UIAbilityContext;
    viewModelManager.setContext(context);
    NetworkManager.getInstance().setContext(context);
    
    this.loadSearchHistory();
    this.loadBookSources();
  }

  aboutToDisappear(): void {
    this.isComponentActive = false;
    themeManager.removeListener(this.themeListener);
    this.searchResults = [];
    this.bookSources = [];
  }

  private async loadSearchHistory(): Promise<void> {
    try {
      const bookViewModel = viewModelManager.getBookViewModel();
      this.searchHistory = bookViewModel.getSearchHistory();
    } catch (error) {
      Logger.error('SearchPage', `åŠ è½½æœç´¢å†å²å¤±è´¥: ${error}`);
    }
  }

  private async loadBookSources(): Promise<void> {
    if (!this.isComponentActive) return;
    
    try {
      const bookSourceViewModel = viewModelManager.getBookSourceViewModel();
      this.bookSources = await bookSourceViewModel.loadEnabledBookSources();
      this.hasEnabledSources = this.bookSources.length > 0;
      Logger.info('SearchPage', `åŠ è½½äº†${this.bookSources.length}ä¸ªä¹¦æº`);
    } catch (error) {
      Logger.error('SearchPage', `åŠ è½½ä¹¦æºå¤±è´¥: ${error}`);
      this.hasEnabledSources = false;
    }
  }
  private async performSearch(): Promise<void> {
    if (!this.searchText.trim()) {
      try {
        AlertDialog.show({
          title: 'æç¤º',
          message: 'è¯·è¾“å…¥æœç´¢å…³é”®è¯',
          autoCancel: true,
          alignment: DialogAlignment.Center,
          buttons: [
            {
              text: 'ç¡®å®š',
              action: () => {}
            }
          ]
        });
      } catch (e) {
        Logger.error('SearchPage', `AlertDialog.show failed: ${e}`);
      }
      return;
    }

    this.isSearching = true;
    this.hasSearched = true;
    this.errorMessage = '';
    this.searchResults = [];

    try {
      Logger.info('SearchPage', `å¼€å§‹æœç´¢: ${this.searchText}`);

      if (this.bookSources.length === 0) {
        await this.loadBookSources();
      }

      if (this.bookSources.length === 0) {
        this.errorMessage = 'æ²¡æœ‰å¯ç”¨çš„ä¹¦æº';
        this.hasEnabledSources = false;
        this.isSearching = false;
        return;
      }

      const sourcesToUse = this.bookSources.slice(0, 5);
      Logger.info('SearchPage', `ä½¿ç”¨${sourcesToUse.length}ä¸ªä¹¦æºè¿›è¡Œæœç´¢`);

      const bookViewModel = viewModelManager.getBookViewModel();
      const results = await bookViewModel.searchBooks(this.searchText.trim(), sourcesToUse);

      if (this.isComponentActive) {
        this.searchResults = results;
        Logger.info('SearchPage', `æœç´¢å®Œæˆï¼Œæ‰¾åˆ°${results.length}æœ¬ä¹¦`);

        if (results.length === 0) {
          this.errorMessage = 'å½“å‰å¯ç”¨çš„ä¹¦æºæ— åŒ¹é…ç»“æœ';
        }
      }

    } catch (error) {
      Logger.error('SearchPage', `æœç´¢å¤±è´¥: ${error}`);
      if (this.isComponentActive) {
        const errorMsg = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
        
        if (errorMsg.includes('network') || errorMsg.includes('ç½‘ç»œ')) {
          this.errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®';
        } else if (errorMsg.includes('timeout') || errorMsg.includes('è¶…æ—¶')) {
          this.errorMessage = 'æœç´¢è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•';
        } else {
          this.errorMessage = `æœç´¢å¤±è´¥: ${errorMsg}`;
        }
      }
    } finally {
      if (this.isComponentActive) {
        this.isSearching = false;
      }
    }
  }

  private async addToBookshelf(book: Book): Promise<void> {
    try {
      const bookViewModel = viewModelManager.getBookViewModel();
      await bookViewModel.addBook(book);
      try {
        AlertDialog.show({
          title: 'æç¤º',
          message: 'å·²æ·»åŠ åˆ°ä¹¦æ¶',
          autoCancel: true,
          alignment: DialogAlignment.Center,
          buttons: [
            {
              text: 'ç¡®å®š',
              action: () => {}
            }
          ]
        });
      } catch (e) {
        Logger.error('SearchPage', `AlertDialog.show failed: ${e}`);
      }
    } catch (error) {
      Logger.error('SearchPage', `æ·»åŠ åˆ°ä¹¦æ¶å¤±è´¥: ${error}`);
      try {
        AlertDialog.show({
          title: 'æç¤º',
          message: 'æ·»åŠ å¤±è´¥',
          autoCancel: true,
          alignment: DialogAlignment.Center,
          buttons: [
            {
              text: 'ç¡®å®š',
              action: () => {}
            }
          ]
        });
      } catch (e) {
        Logger.error('SearchPage', `AlertDialog.show failed: ${e}`);
      }
    }
  }

  private navigateToSourcePage(): void {
    try {
      router.pushUrl({
        url: 'pages/MainPage',
        params: { tabIndex: 3 }
      });
    } catch (err) {
      Logger.error('SearchPage', `è·³è½¬å¤±è´¥: ${err}`);
    }
  }

  private async clearSearchHistory(): Promise<void> {
    try {
      const bookViewModel = viewModelManager.getBookViewModel();
      await bookViewModel.clearSearchHistory();
      this.searchHistory = [];
    } catch (error) {
      Logger.error('SearchPage', `æ¸…é™¤æœç´¢å†å²å¤±è´¥: ${error}`);
    }
  }

  build() {
    Column() {
      Row() {
        Row() {
          Text('â€¹')
            .fontSize(20)
            .fontColor(DesignSystem.getPrimaryColor(this.isLightMode))
        }
        .width(32)
        .height(32)
        .borderRadius(16)
        .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
        .justifyContent(FlexAlign.Center)
        .margin({ right: 15 })

        Text($r('app.string.search_books'))
          .fontSize(18)
          .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
          .fontWeight(600)
          .layoutWeight(1)
      }
      .width('100%')
      .padding({ left: 15, right: 20, top: 15, bottom: 15 })
      .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
      .border({
        width: { bottom: 1 },
        color: DesignSystem.getBorderColor(this.isLightMode)
      })

      Scroll() {
        Column() {
          Row() {
            Text('ğŸ”')
              .fontSize(18)
              .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
              .margin({ right: 10 })

            TextInput({ placeholder: $r('app.string.search_placeholder'), text: this.searchText })
              .layoutWeight(1)
              .backgroundColor(Color.Transparent)
              .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
              .placeholderColor(this.isLightMode ? '#666' : '#8a7f6e')
              .onChange((value: string) => {
                this.searchText = value;
              })
              .onSubmit(() => {
                this.performSearch();
              })

            Button($r('app.string.search_button'))
              .fontSize(14)
              .fontColor(DesignSystem.Colors.text.primary.light)
              .backgroundColor(DesignSystem.getPrimaryColor(this.isLightMode))
              .borderRadius(8)
              .padding({ left: 15, right: 15, top: 8, bottom: 8 })
              .margin({ left: 10 })
              .enabled(!this.isSearching)
              .onClick(() => {
                this.performSearch();
              })
          }
          .width('100%')
          .padding(15)
          .borderRadius(12)
          .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
          .border({
            width: 1,
            color: DesignSystem.getBorderColor(this.isLightMode)
          })
          .margin({ bottom: 20 })

          if (this.isSearching) {
            Column() {
              LoadingProgress()
                .width(40)
                .height(40)
                .color(DesignSystem.getPrimaryColor(this.isLightMode))
              Text('æ­£åœ¨æœç´¢...')
                .fontSize(14)
                .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                .margin({ top: 10 })
            }
            .width('100%')
            .height(200)
            .justifyContent(FlexAlign.Center)
          }

          if (this.hasSearched && !this.isSearching) {
            if (this.errorMessage) {
              Column() {
                Text('ğŸ˜”')
                  .fontSize(40)
                Text(this.errorMessage)
                  .fontSize(14)
                  .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                  .margin({ top: 10 })
                  .textAlign(TextAlign.Center)
                
                Column() {
                  if (!this.hasEnabledSources) {
                    Text('è¯·å…ˆå¯¼å…¥ä¹¦æºåå†è¿›è¡Œæœç´¢')
                      .fontSize(12)
                      .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                      .margin({ top: 8 })
                  } else {
                    Text('å¯å°è¯•ä»¥ä¸‹æ“ä½œï¼š')
                      .fontSize(12)
                      .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                      .margin({ top: 8 })
                  }
                  
                  Row() {
                    Button('ç½‘ç»œå¯¼å…¥ä¹¦æº')
                      .fontSize(13)
                      .backgroundColor(DesignSystem.getPrimaryColor(this.isLightMode))
                      .fontColor('#fff')
                      .borderRadius(6)
                      .padding({ left: 12, right: 12, top: 8, bottom: 8 })
                      .margin({ top: 12, right: 10 })
                      .onClick(() => {
                        this.navigateToSourcePage();
                      })
                    
                    if (this.hasEnabledSources) {
                      Button('éªŒè¯ä¹¦æº')
                        .fontSize(13)
                        .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
                        .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
                        .borderRadius(6)
                        .padding({ left: 12, right: 12, top: 8, bottom: 8 })
                        .margin({ top: 12 })
                        .onClick(() => {
                          this.navigateToSourcePage();
                        })
                    }
                  }
                }
                .margin({ top: 8 })
              }
              .width('100%')
              .height(250)
              .justifyContent(FlexAlign.Center)
            } else if (this.searchResults.length > 0) {
              Column() {
                Text(`æ‰¾åˆ° ${this.searchResults.length} æœ¬ä¹¦ç±`)
                  .fontSize(14)
                  .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                  .width('100%')
                  .margin({ bottom: 12 })

                List() {
                  ForEach(this.searchResults, (book: Book) => {
                    ListItem() {
                      Row() {
                        if (book.cover) {
                          Image(book.cover)
                            .width(60)
                            .height(80)
                            .borderRadius(4)
                            .objectFit(ImageFit.Cover)
                        } else {
                          Column() {
                            Text('ğŸ“–')
                              .fontSize(24)
                          }
                          .width(60)
                          .height(80)
                          .borderRadius(4)
                          .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
                          .justifyContent(FlexAlign.Center)
                        }

                        Column() {
                          Text(book.name)
                            .fontSize(16)
                            .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
                            .fontWeight(500)
                            .maxLines(1)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })

                          if (book.author) {
                            Text(book.author)
                              .fontSize(12)
                              .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                              .margin({ top: 4 })
                          }

                          if (book.intro) {
                            Text(book.intro)
                              .fontSize(12)
                              .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                              .margin({ top: 4 })
                              .maxLines(2)
                              .textOverflow({ overflow: TextOverflow.Ellipsis })
                          }

                          if (book.bookSourceName) {
                            Text(`æ¥æº: ${book.bookSourceName}`)
                              .fontSize(10)
                              .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                              .margin({ top: 4 })
                          }
                        }
                        .layoutWeight(1)
                        .alignItems(HorizontalAlign.Start)
                        .margin({ left: 12 })

                        Button('åŠ å…¥ä¹¦æ¶')
                          .fontSize(12)
                          .fontColor(DesignSystem.Colors.text.primary.light)
                          .backgroundColor(DesignSystem.getPrimaryColor(this.isLightMode))
                          .borderRadius(6)
                          .padding({ left: 8, right: 8, top: 6, bottom: 6 })
                          .margin({ left: 8 })
                          .onClick(() => {
                            this.addToBookshelf(book);
                          })
                      }
                      .width('100%')
                      .padding(12)
                      .borderRadius(8)
                      .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
                    }
                    .margin({ bottom: 8 })
                  }, (book: Book) => `${book.id}-${book.bookSourceId}`)
                }
                .width('100%')
                .height('100%')
                .cachedCount(5)
              }
              .width('100%')
            }
          }

          if (!this.hasSearched) {
            if (!this.hasEnabledSources) {
              Column() {
                Text('ğŸ“š')
                  .fontSize(48)
                  .margin({ bottom: 16 })
                Text('æš‚æ— å¯ç”¨ä¹¦æº')
                  .fontSize(16)
                  .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                  .margin({ bottom: 8 })
                Text('è¯·å…ˆå¯¼å…¥ä¹¦æºåå†è¿›è¡Œæœç´¢')
                  .fontSize(14)
                  .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                  .margin({ bottom: 16 })
                Button('å»å¯¼å…¥ä¹¦æº')
                  .fontSize(14)
                  .backgroundColor(DesignSystem.getPrimaryColor(this.isLightMode))
                  .fontColor('#fff')
                  .borderRadius(8)
                  .padding({ left: 20, right: 20, top: 10, bottom: 10 })
                  .onClick(() => {
                    this.navigateToSourcePage();
                  })
              }
              .width('100%')
              .height(200)
              .justifyContent(FlexAlign.Center)
              .margin({ bottom: 20 })
            }

            if (this.searchHistory.length > 0) {
              Column() {
                Row() {
                  Text($r('app.string.search_history'))
                    .fontSize(14)
                    .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                    .fontWeight(500)

                  Blank()

                  Text($r('app.string.clear_history'))
                    .fontSize(12)
                    .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                    .onClick(() => {
                      this.clearSearchHistory();
                    })
                }
                .width('100%')
                .margin({ bottom: 12 })

                Flex({ wrap: FlexWrap.Wrap }) {
                  ForEach(this.searchHistory, (item: string) => {
                    Text(item)
                      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                      .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
                      .borderRadius(15)
                      .fontSize(12)
                      .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                      .margin({ right: 8, bottom: 8 })
                      .onClick(() => {
                        this.searchText = item;
                        this.performSearch();
                      })
                  })
                }
              }
              .width('100%')
              .margin({ bottom: 25 })
            }

            Column() {
              Text($r('app.string.hot_search'))
                .width('100%')
                .fontSize(14)
                .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                .fontWeight(500)
                .margin({ bottom: 12 })

              Column() {
                ForEach(this.hotSearchList, (item: string, index: number) => {
                  Row() {
                    Text((index + 1).toString())
                      .width(20)
                      .height(20)
                      .borderRadius(10)
                      .backgroundColor(this.getRankColor(index))
                      .fontColor(DesignSystem.Colors.text.primary.light)
                      .fontSize(12)
                      .fontWeight(600)
                      .textAlign(TextAlign.Center)
                      .margin({ right: 12 })

                    Text(item)
                      .fontSize(14)
                      .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
                  }
                  .width('100%')
                  .margin({ bottom: 12 })
                  .onClick(() => {
                    this.searchText = item;
                    this.performSearch();
                  })
                })
              }
            }
            .width('100%')
          }
        }
        .width('100%')
        .padding(20)
      }
      .width('100%')
      .layoutWeight(1)
      .align(Alignment.Top)
      .scrollBar(BarState.Auto)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(DesignSystem.getPrimaryBackgroundColor(this.isLightMode))
  }

  private getRankColor(index: number): string {
    const rankColors: RankColor[] = [
      { light: '#e8d9b0', dark: '#d4b483' },
      { light: '#ede0c3', dark: '#e0c595' },
      { light: '#f2e8d6', dark: '#eddfc8' }
    ];
    const color = rankColors[index] || rankColors[0];
    return this.isLightMode ? color.light : color.dark;
  }
}
