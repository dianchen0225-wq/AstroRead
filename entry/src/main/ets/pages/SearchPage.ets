/**
 * Copyright (c) 2025 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import { themeManager } from '../common/ThemeManager';
import { DesignSystem } from '../common/DesignSystem';
import { viewModelManager } from '../viewmodel/ViewModelManager';
import { BookSource } from '../models/BookSource';
import { Book } from '../models/Book';
import { PagedSearchResult, SearchProgress, SourceSearchStats } from '../models/SearchResult';
import { Logger } from '../utils/Logger';
import { NavigationManager } from '../common/NavigationManager';
import { common } from '@kit.AbilityKit';
import { NetworkManager } from '../utils/NetworkManager';
import { ContentPurifier, purifyIntro } from '../utils/ContentPurifier';
import { router } from '@kit.ArkUI';

export interface RankColor {
  light: string;
  dark: string;
}

@ComponentV2
export struct SearchPage {
  @Local isLightMode: boolean = true;
  @Local searchText: string = '';
  @Local searchHistory: string[] = [];
  @Local hotSearchList: string[] = ['å®Œç¾ä¸–ç•Œ', 'é›ªä¸­æ‚åˆ€è¡Œ', 'è¯¡ç§˜ä¹‹ä¸»', 'åº†ä½™å¹´', 'èµ˜å©¿'];
  @Local searchResults: Book[] = [];
  @Local isSearching: boolean = false;
  @Local hasSearched: boolean = false;
  @Local errorMessage: string = '';
  @Local hasEnabledSources: boolean = true;
  @Local currentPage: number = 1;
  @Local totalPages: number = 1;
  @Local totalCount: number = 0;
  @Local hasMore: boolean = false;
  @Local searchProgress: string = '';
  @Local sourceStats: SourceSearchStats[] = [];

  private bookSources: BookSource[] = [];
  private isComponentActive: boolean = false;
  private lastSearchKeyword: string = '';
  private themeListener: (isDark: boolean) => void = (isDark: boolean) => {
    this.isLightMode = !isDark;
  };

  aboutToAppear(): void {
    this.isComponentActive = true;
    this.isLightMode = themeManager.isLightTheme();
    themeManager.addListener(this.themeListener);
    
    const context = this.getUIContext().getHostContext() as common.UIAbilityContext;
    viewModelManager.setContext(context);
    NetworkManager.getInstance().setContext(context);
    
    this.loadSearchHistory();
    this.loadBookSources();
  }

  aboutToDisappear(): void {
    this.isComponentActive = false;
    themeManager.removeListener(this.themeListener);
    this.searchResults = [];
    this.bookSources = [];
  }

  private async loadSearchHistory(): Promise<void> {
    try {
      const bookViewModel = viewModelManager.getBookViewModel();
      this.searchHistory = bookViewModel.getSearchHistory();
    } catch (error) {
      Logger.error('SearchPage', `åŠ è½½æœç´¢å†å²å¤±è´¥: ${error}`);
    }
  }

  private async loadBookSources(): Promise<void> {
    if (!this.isComponentActive) return;
    
    try {
      const bookSourceViewModel = viewModelManager.getBookSourceViewModel();
      this.bookSources = await bookSourceViewModel.loadEnabledBookSources();
      this.hasEnabledSources = this.bookSources.length > 0;
      Logger.info('SearchPage', `åŠ è½½äº†${this.bookSources.length}ä¸ªä¹¦æº`);
      
      if (this.bookSources.length > 0) {
        for (let i = 0; i < Math.min(3, this.bookSources.length); i++) {
          const source = this.bookSources[i];
          Logger.info('SearchPage', `ä¹¦æº[${i}]: ${source.name}, searchUrl=${source.searchUrl}, ruleType=${source.ruleType}`);
        }
      }
    } catch (error) {
      Logger.error('SearchPage', `åŠ è½½ä¹¦æºå¤±è´¥: ${error}`);
      this.hasEnabledSources = false;
    }
  }

  private async performSearch(page: number = 1): Promise<void> {
    if (!this.searchText.trim()) {
      Logger.info('SearchPage', 'è¯·è¾“å…¥æœç´¢å…³é”®è¯');
      return;
    }

    this.isSearching = true;
    this.hasSearched = true;
    this.errorMessage = '';
    this.searchProgress = 'æ­£åœ¨åˆå§‹åŒ–æœç´¢...';

    if (page === 1) {
      this.searchResults = [];
      this.currentPage = 1;
    }

    try {
      Logger.info('SearchPage', `å¼€å§‹æœç´¢: ${this.searchText}, ç¬¬${page}é¡µ`);

      if (this.bookSources.length === 0) {
        await this.loadBookSources();
      }

      if (this.bookSources.length === 0) {
        this.errorMessage = 'æ²¡æœ‰å¯ç”¨çš„ä¹¦æº';
        this.hasEnabledSources = false;
        this.isSearching = false;
        return;
      }

      const sourcesToUse = this.bookSources;
      Logger.info('SearchPage', `ä½¿ç”¨${sourcesToUse.length}ä¸ªä¹¦æºè¿›è¡Œæœç´¢`);

      const bookViewModel = viewModelManager.getBookViewModel();
      
      const progressCallback = (progress: SearchProgress): void => {
        if (this.isComponentActive) {
          this.searchProgress = `æ­£åœ¨æœç´¢ ${progress.currentSource}... (${progress.completedSources}/${progress.totalSources})`;
        }
      };

      const result: PagedSearchResult = await bookViewModel.searchBooksWithPaging(
        this.searchText.trim(),
        sourcesToUse,
        page,
        progressCallback
      );

      if (this.isComponentActive) {
        this.searchResults = result.books;
        this.currentPage = result.currentPage;
        this.totalPages = result.totalPages;
        this.totalCount = result.totalCount;
        this.hasMore = result.hasMore;
        this.sourceStats = result.sourceStats;
        this.lastSearchKeyword = this.searchText.trim();

        Logger.info('SearchPage', 
          `æœç´¢å®Œæˆï¼Œå…±${result.totalCount}æœ¬ä¹¦ï¼Œå½“å‰ç¬¬${result.currentPage}/${result.totalPages}é¡µ`
        );
        Logger.info('SearchPage', `searchResults.length = ${this.searchResults.length}`);

        if (result.totalCount === 0) {
          this.errorMessage = 'å½“å‰å¯ç”¨çš„ä¹¦æºæ— åŒ¹é…ç»“æœ';
        }
      }

    } catch (error) {
      Logger.error('SearchPage', `æœç´¢å¤±è´¥: ${error}`);
      if (this.isComponentActive) {
        const errorMsg = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
        
        if (errorMsg.includes('network') || errorMsg.includes('ç½‘ç»œ')) {
          this.errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®';
        } else if (errorMsg.includes('timeout') || errorMsg.includes('è¶…æ—¶')) {
          this.errorMessage = 'æœç´¢è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•';
        } else {
          this.errorMessage = `æœç´¢å¤±è´¥: ${errorMsg}`;
        }
      }
    } finally {
      if (this.isComponentActive) {
        this.isSearching = false;
        this.searchProgress = '';
      }
    }
  }

  private async loadNextPage(): Promise<void> {
    if (!this.hasMore || this.isSearching) {
      return;
    }
    await this.performSearch(this.currentPage + 1);
  }

  private async loadPreviousPage(): Promise<void> {
    if (this.currentPage <= 1 || this.isSearching) {
      return;
    }
    await this.performSearch(this.currentPage - 1);
  }

  private async goToPage(page: number): Promise<void> {
    if (page < 1 || page > this.totalPages || page === this.currentPage || this.isSearching) {
      return;
    }
    await this.performSearch(page);
  }

  private async addToBookshelf(book: Book): Promise<void> {
    try {
      const bookViewModel = viewModelManager.getBookViewModel();
      
      if (!book.id) {
        book.id = `book_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      }
      if (!book.addTime) {
        book.addTime = Date.now();
      }
      if (!book.lastUpdateTime) {
        book.lastUpdateTime = Date.now();
      }
      if (!book.readProgress) {
        book.readProgress = 0;
      }
      
      Logger.info('SearchPage', `å‡†å¤‡æ·»åŠ ä¹¦ç±: id=${book.id}, name=${book.name}, bookSourceId=${book.bookSourceId}`);
      
      const bookId = await bookViewModel.addBook(book);
      Logger.info('SearchPage', `å·²æ·»åŠ åˆ°ä¹¦æ¶ï¼ŒID: ${bookId}`);
    } catch (error) {
      Logger.error('SearchPage', `æ·»åŠ åˆ°ä¹¦æ¶å¤±è´¥: ${error}`);
    }
  }
  private async openBook(book: Book): Promise<void> {
    try {
      await this.addToBookshelf(book);
      
      NavigationManager.getInstance().navigateTo('BookDetailPage', {
        bookId: book.id
      });
    } catch (error) {
      Logger.error('SearchPage', `æ‰“å¼€ä¹¦ç±å¤±è´¥: ${error}`);
    }
  }
  private navigateToSourcePage(): void {
    try {
      NavigationManager.getInstance().navigateTo('MainPage', { tabIndex: 3 });
    } catch (err) {
      Logger.error('SearchPage', `è·³è½¬å¤±è´¥: ${err}`);
    }
  }

  private async clearSearchHistory(): Promise<void> {
    try {
      const bookViewModel = viewModelManager.getBookViewModel();
      await bookViewModel.clearSearchHistory();
      this.searchHistory = [];
    } catch (error) {
      Logger.error('SearchPage', `æ¸…é™¤æœç´¢å†å²å¤±è´¥: ${error}`);
    }
  }

  build() {
    Column() {
      Row() {
        Row() {
          Text('â€¹')
            .fontSize(20)
            .fontColor(DesignSystem.getPrimaryColor(this.isLightMode))
        }
        .width(32)
        .height(32)
        .borderRadius(16)
        .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
        .justifyContent(FlexAlign.Center)
        .margin({ right: 15 })
        .onClick(() => {
          NavigationManager.getInstance().navigateBack();
        })

        Text($r('app.string.search_books'))
          .fontSize(18)
          .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
          .fontWeight(600)
          .layoutWeight(1)
      }
      .width('100%')
      .padding({ left: 15, right: 20, top: 15, bottom: 15 })
      .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
      .border({
        width: { bottom: 1 },
        color: DesignSystem.getBorderColor(this.isLightMode)
      })

      Scroll() {
        Column() {
          Row() {
            Text('ğŸ”')
              .fontSize(18)
              .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
              .margin({ right: 10 })

            TextInput({ placeholder: $r('app.string.search_placeholder'), text: this.searchText })
              .layoutWeight(1)
              .backgroundColor(Color.Transparent)
              .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
              .placeholderColor(this.isLightMode ? '#666' : '#8a7f6e')
              .onChange((value: string) => {
                this.searchText = value;
              })
              .onSubmit(() => {
                this.performSearch();
              })

            Button($r('app.string.search_button'))
              .fontSize(14)
              .fontColor(DesignSystem.Colors.text.primary.light)
              .backgroundColor(DesignSystem.getPrimaryColor(this.isLightMode))
              .borderRadius(8)
              .padding({ left: 15, right: 15, top: 8, bottom: 8 })
              .margin({ left: 10 })
              .enabled(!this.isSearching)
              .onClick(() => {
                this.performSearch(1);
              })
          }
          .width('100%')
          .padding(15)
          .borderRadius(12)
          .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
          .border({
            width: 1,
            color: DesignSystem.getBorderColor(this.isLightMode)
          })
          .margin({ bottom: 20 })

          if (this.isSearching) {
            Column() {
              LoadingProgress()
                .width(40)
                .height(40)
                .color(DesignSystem.getPrimaryColor(this.isLightMode))
              Text(this.searchProgress || 'æ­£åœ¨æœç´¢...')
                .fontSize(14)
                .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                .margin({ top: 10 })
            }
            .width('100%')
            .height(200)
            .justifyContent(FlexAlign.Center)
          }

          if (this.hasSearched && !this.isSearching) {
            if (this.errorMessage) {
              Column() {
                Text('ğŸ˜”')
                  .fontSize(40)
                Text(this.errorMessage)
                  .fontSize(14)
                  .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                  .margin({ top: 10 })
                  .textAlign(TextAlign.Center)
                
                Column() {
                  if (!this.hasEnabledSources) {
                    Text('è¯·å…ˆå¯¼å…¥ä¹¦æºåå†è¿›è¡Œæœç´¢')
                      .fontSize(12)
                      .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                      .margin({ top: 8 })
                  } else {
                    Text('å¯å°è¯•ä»¥ä¸‹æ“ä½œï¼š')
                      .fontSize(12)
                      .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                      .margin({ top: 8 })
                  }
                  
                  Row() {
                    Button('ç½‘ç»œå¯¼å…¥ä¹¦æº')
                      .fontSize(13)
                      .backgroundColor(DesignSystem.getPrimaryColor(this.isLightMode))
                      .fontColor('#fff')
                      .borderRadius(6)
                      .padding({ left: 12, right: 12, top: 8, bottom: 8 })
                      .margin({ top: 12, right: 10 })
                      .onClick(() => {
                        this.navigateToSourcePage();
                      })
                    
                    if (this.hasEnabledSources) {
                      Button('éªŒè¯ä¹¦æº')
                        .fontSize(13)
                        .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
                        .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
                        .borderRadius(6)
                        .padding({ left: 12, right: 12, top: 8, bottom: 8 })
                        .margin({ top: 12 })
                        .onClick(() => {
                          this.navigateToSourcePage();
                        })
                    }
                  }
                }
                .margin({ top: 8 })
              }
              .width('100%')
              .height(250)
              .justifyContent(FlexAlign.Center)
            } else if (this.searchResults.length > 0) {
              Column() {
                Row() {
                  Text(`å…± ${this.totalCount} æœ¬ä¹¦ç± (æ˜¾ç¤º ${this.searchResults.length} æœ¬)`)
                    .fontSize(14)
                    .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                  
                  Blank()
                  
                  Text(`ç¬¬ ${this.currentPage}/${this.totalPages} é¡µ`)
                    .fontSize(12)
                    .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                }
                .width('100%')
                .margin({ bottom: 12 })

                List() {
                  ForEach(this.searchResults, (book: Book, index: number) => {
                    ListItem() {
                      Row() {
                        if (book.cover) {
                          Image(book.cover)
                            .width(60)
                            .height(80)
                            .borderRadius(4)
                            .objectFit(ImageFit.Cover)
                        } else {
                          Column() {
                            Text('ğŸ“–')
                              .fontSize(24)
                          }
                          .width(60)
                          .height(80)
                          .borderRadius(4)
                          .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
                          .justifyContent(FlexAlign.Center)
                        }

                        Column() {
                          Text(book.name)
                            .fontSize(16)
                            .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
                            .fontWeight(500)
                            .maxLines(1)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })

                          if (book.author) {
                            Text(book.author)
                              .fontSize(12)
                              .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                              .margin({ top: 4 })
                          }

                          if (book.intro) {
                            Text(purifyIntro(book.intro))
                              .fontSize(12)
                              .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                              .margin({ top: 4 })
                              .maxLines(2)
                              .textOverflow({ overflow: TextOverflow.Ellipsis })
                          }

                          if (book.bookSourceName) {
                            Text(`æ¥æº: ${book.bookSourceName}`)
                              .fontSize(10)
                              .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                              .margin({ top: 4 })
                          }
                        }
                        .layoutWeight(1)
                        .alignItems(HorizontalAlign.Start)
                        .margin({ left: 12 })

                        Button('åŠ å…¥ä¹¦æ¶')
                          .fontSize(12)
                          .fontColor(DesignSystem.Colors.text.primary.light)
                          .backgroundColor(DesignSystem.getPrimaryColor(this.isLightMode))
                          .borderRadius(6)
                          .padding({ left: 8, right: 8, top: 6, bottom: 6 })
                          .margin({ left: 8 })
                          .onClick(() => {
                            this.addToBookshelf(book);
                          })
                      }
                      .width('100%')
                      .padding(12)
                      .borderRadius(8)
                      .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
                      .onClick(() => {
                        this.openBook(book);
                      })
                    }
                    .margin({ bottom: 8 })
                  }, (book: Book, index: number) => `book_${index}_${book.name}_${book.bookSourceId}`)
                }
                .width('100%')
                .height(this.searchResults.length * 120 + 20)
                .cachedCount(5)
                .nestedScroll({
                  scrollForward: NestedScrollMode.PARENT_FIRST,
                  scrollBackward: NestedScrollMode.SELF_FIRST
                })

                if (this.totalPages > 1) {
                  Row() {
                    Button('ä¸Šä¸€é¡µ')
                      .fontSize(13)
                      .backgroundColor(this.currentPage > 1 ? 
                        DesignSystem.getPrimaryColor(this.isLightMode) : 
                        DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
                      .fontColor(this.currentPage > 1 ? '#fff' : DesignSystem.getSecondaryTextColor(this.isLightMode))
                      .borderRadius(6)
                      .padding({ left: 12, right: 12, top: 8, bottom: 8 })
                      .enabled(this.currentPage > 1 && !this.isSearching)
                      .onClick(() => {
                        this.loadPreviousPage();
                      })

                    Text(`${this.currentPage} / ${this.totalPages}`)
                      .fontSize(14)
                      .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
                      .margin({ left: 16, right: 16 })

                    Button('ä¸‹ä¸€é¡µ')
                      .fontSize(13)
                      .backgroundColor(this.hasMore ? 
                        DesignSystem.getPrimaryColor(this.isLightMode) : 
                        DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
                      .fontColor(this.hasMore ? '#fff' : DesignSystem.getSecondaryTextColor(this.isLightMode))
                      .borderRadius(6)
                      .padding({ left: 12, right: 12, top: 8, bottom: 8 })
                      .enabled(this.hasMore && !this.isSearching)
                      .onClick(() => {
                        this.loadNextPage();
                      })
                  }
                  .width('100%')
                  .justifyContent(FlexAlign.Center)
                  .margin({ top: 16, bottom: 16 })
                }
              }
              .width('100%')
            }
          }

          if (!this.hasSearched) {
            if (!this.hasEnabledSources) {
              Column() {
                Text('ğŸ“š')
                  .fontSize(48)
                  .margin({ bottom: 16 })
                Text('æš‚æ— å¯ç”¨ä¹¦æº')
                  .fontSize(16)
                  .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                  .margin({ bottom: 8 })
                Text('è¯·å…ˆå¯¼å…¥ä¹¦æºåå†è¿›è¡Œæœç´¢')
                  .fontSize(14)
                  .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                  .margin({ bottom: 16 })
                Button('å»å¯¼å…¥ä¹¦æº')
                  .fontSize(14)
                  .backgroundColor(DesignSystem.getPrimaryColor(this.isLightMode))
                  .fontColor('#fff')
                  .borderRadius(8)
                  .padding({ left: 20, right: 20, top: 10, bottom: 10 })
                  .onClick(() => {
                    this.navigateToSourcePage();
                  })
              }
              .width('100%')
              .height(200)
              .justifyContent(FlexAlign.Center)
              .margin({ bottom: 20 })
            }

            if (this.searchHistory.length > 0) {
              Column() {
                Row() {
                  Text($r('app.string.search_history'))
                    .fontSize(14)
                    .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                    .fontWeight(500)

                  Blank()

                  Text($r('app.string.clear_history'))
                    .fontSize(12)
                    .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                    .onClick(() => {
                      this.clearSearchHistory();
                    })
                }
                .width('100%')
                .margin({ bottom: 12 })

                Flex({ wrap: FlexWrap.Wrap }) {
                  ForEach(this.searchHistory, (item: string) => {
                    Text(item)
                      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                      .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
                      .borderRadius(15)
                      .fontSize(12)
                      .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                      .margin({ right: 8, bottom: 8 })
                      .onClick(() => {
                        this.searchText = item;
                        this.performSearch(1);
                      })
                  })
                }
              }
              .width('100%')
              .margin({ bottom: 25 })
            }

            Column() {
              Text($r('app.string.hot_search'))
                .width('100%')
                .fontSize(14)
                .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                .fontWeight(500)
                .margin({ bottom: 12 })

              Column() {
                ForEach(this.hotSearchList, (item: string, index: number) => {
                  Row() {
                    Text((index + 1).toString())
                      .width(20)
                      .height(20)
                      .borderRadius(10)
                      .backgroundColor(this.getRankColor(index))
                      .fontColor(DesignSystem.Colors.text.primary.light)
                      .fontSize(12)
                      .fontWeight(600)
                      .textAlign(TextAlign.Center)
                      .margin({ right: 12 })

                    Text(item)
                      .fontSize(14)
                      .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
                  }
                  .width('100%')
                  .margin({ bottom: 12 })
                  .onClick(() => {
                    this.searchText = item;
                    this.performSearch(1);
                  })
                })
              }
            }
            .width('100%')
          }
        }
        .width('100%')
        .padding(20)
      }
      .width('100%')
      .layoutWeight(1)
      .align(Alignment.Top)
      .scrollBar(BarState.Auto)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(DesignSystem.getPrimaryBackgroundColor(this.isLightMode))
  }

  private getRankColor(index: number): string {
    const rankColors: RankColor[] = [
      { light: '#e8d9b0', dark: '#d4b483' },
      { light: '#ede0c3', dark: '#e0c595' },
      { light: '#f2e8d6', dark: '#eddfc8' }
    ];
    const color = rankColors[index] || rankColors[0];
    return this.isLightMode ? color.light : color.dark;
  }
}
