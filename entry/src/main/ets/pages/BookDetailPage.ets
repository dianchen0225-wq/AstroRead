import { themeManager } from '../common/ThemeManager';
import { DesignSystem } from '../common/DesignSystem';
import { viewModelManager } from '../viewmodel/ViewModelManager';
import { Book } from '../models/Book';
import { Chapter } from '../models/Book';
import { BookSource } from '../models/BookSource';
import { Logger } from '../utils/Logger';
import { NavigationManager } from '../common/NavigationManager';
import { CommonNavBar } from '../components/CommonNavBar';
import { AppButton, AppLoading, AppEmpty } from '../components/UIComponents';
import common from '@ohos.app.ability.common';

@Entry
@ComponentV2
struct BookDetailPage {
  @Param bookId: string = '';
  @Local isLightMode: boolean = true;
  @Local book: Book | null = null;
  @Local chapters: Chapter[] = [];
  @Local isLoadingChapters: boolean = false;
  @Local bookSource: BookSource | null = null;
  @Local currentChapterIndex: number = 0;
  @Local isAdded: boolean = false;
  @Local showChapterSheet: boolean = false;
  @Local isAdding: boolean = false;
  
  private isComponentActive: boolean = false;
  private themeListener: (isDark: boolean) => void = (isDark: boolean) => {
    this.isLightMode = !isDark;
  };

  aboutToAppear(): void {
    this.isComponentActive = true;
    this.isLightMode = themeManager.isLightTheme();
    themeManager.addListener(this.themeListener);

    const context = this.getUIContext().getHostContext() as common.UIAbilityContext;
    viewModelManager.setContext(context);

    Logger.info('BookDetailPage', `æ¥æ”¶åˆ°çš„ bookId: ${this.bookId}`);

    this.loadBookDetail();
  }

  aboutToDisappear(): void {
    this.isComponentActive = false;
    themeManager.removeListener(this.themeListener);
    this.chapters = [];
    this.book = null;
    this.bookSource = null;
  }
  
  async loadBookDetail(): Promise<void> {
    if (!this.isComponentActive) return;
    
    Logger.info('BookDetailPage', `bookId: ${this.bookId}`);

    if (this.bookId) {
      try {
        const bookViewModel = viewModelManager.getBookViewModel();
        Logger.info('BookDetailPage', 'å¼€å§‹æŸ¥è¯¢ä¹¦ç±...');
        this.book = await bookViewModel.getBookById(this.bookId);
        Logger.info('BookDetailPage', `æŸ¥è¯¢ç»“æœ: ${this.book ? 'æ‰¾åˆ°ä¹¦ç±' : 'æœªæ‰¾åˆ°ä¹¦ç±'}`);
        if (this.book) {
          Logger.info('BookDetailPage', `ä¹¦ç±è¯¦æƒ…: name=${this.book.name}, bookSourceId=${this.book.bookSourceId}`);
        }

        if (this.book && this.isComponentActive) {
          const bookSourceViewModel = viewModelManager.getBookSourceViewModel();
          this.bookSource = await bookSourceViewModel.getBookSourceById(this.book.bookSourceId);
        }
      } catch (error) {
        Logger.error('BookDetailPage', `åŠ è½½ä¹¦ç±è¯¦æƒ…å¤±è´¥: ${error}`);
      }
    }

    await this.loadChapters();

    if (this.isComponentActive && this.bookId) {
      try {
        const bookViewModel = viewModelManager.getBookViewModel();
        this.isAdded = await bookViewModel.isBookAdded(this.bookId);
      } catch (error) {
        Logger.error('BookDetailPage', `æ£€æŸ¥ä¹¦ç±çŠ¶æ€å¤±è´¥: ${error}`);
      }
    }
  }

  async loadChapters(): Promise<void> {
    if (!this.book || !this.isComponentActive) {
      Logger.warn('BookDetailPage', 'æ— æ³•åŠ è½½ç« èŠ‚ï¼šä¹¦ç±ä¸ºç©ºæˆ–ç»„ä»¶æœªæ¿€æ´»');
      return;
    }

    Logger.info('BookDetailPage', 'å¼€å§‹åŠ è½½ç« èŠ‚...');
    this.isLoadingChapters = true;
    try {
      const chapterViewModel = viewModelManager.getChapterViewModel();
      Logger.info('BookDetailPage', 'å…ˆä»æœ¬åœ°è·å–ç« èŠ‚...');
      this.chapters = await chapterViewModel.getChapters(this.bookId);
      Logger.info('BookDetailPage', `æœ¬åœ°ç« èŠ‚æ•°: ${this.chapters.length}`);

      if (this.chapters.length === 0 && this.bookSource && this.isComponentActive) {
        Logger.info('BookDetailPage', 'ä»ç½‘ç»œè·å–ç« èŠ‚...');
        Logger.info('BookDetailPage', `ä¹¦æº: ${this.bookSource.name}, URL: ${this.book.bookUrl}`);
        this.chapters = await chapterViewModel.fetchAndSaveChapters(
          this.bookId,
          this.bookSource,
          this.book.bookUrl
        );
        Logger.info('BookDetailPage', `ç½‘ç»œè·å–ç« èŠ‚æ•°: ${this.chapters.length}`);
      }
    } catch (error) {
      Logger.error('BookDetailPage', `åŠ è½½ç« èŠ‚å¤±è´¥: ${error}`);
    } finally {
      if (this.isComponentActive) {
        this.isLoadingChapters = false;
      }
    }
  }

  async addBook(): Promise<void> {
    if (!this.book || !this.isComponentActive) {
      return;
    }

    this.isAdding = true;
    try {
      const bookViewModel = viewModelManager.getBookViewModel();
      await bookViewModel.addBook(this.book);
      this.isAdded = true;
    } catch (error) {
      Logger.error('BookDetailPage', `æ·»åŠ ä¹¦ç±å¤±è´¥: ${error}`);
    } finally {
      this.isAdding = false;
    }
  }

  async startRead(): Promise<void> {
    if (this.chapters.length === 0) {
      Logger.info('BookDetailPage', 'å¼€å§‹åŠ è½½ç« èŠ‚...');
      await this.loadChapters();
      if (this.chapters.length === 0) {
        Logger.error('BookDetailPage', 'ç« èŠ‚åŠ è½½å¤±è´¥');
        return;
      }
    }

    try {
      const chapterIndex = this.book?.lastReadChapterIndex ? this.book.lastReadChapterIndex : 0;
      NavigationManager.getInstance().navigateTo('ReadPage', {
        bookId: this.bookId,
        initialChapterIndex: chapterIndex,
        initialChapterUrl: this.chapters[chapterIndex].url
      });
      Logger.info('BookDetailPage', 'push page success');
    } catch (err) {
      Logger.error('BookDetailPage', `pushPage failed: ${err}`);
    }
  }

  async openChapter(index: number): Promise<void> {
    this.showChapterSheet = false;
    
    try {
      NavigationManager.getInstance().navigateTo('ReadPage', {
        bookId: this.bookId,
        initialChapterIndex: index,
        initialChapterUrl: this.chapters[index].url
      });
    } catch (err) {
      Logger.error('BookDetailPage', `pushPage failed: ${err}`);
    }
  }

  build() {
    Column() {
      CommonNavBar({
        title: 'ä¹¦ç±è¯¦æƒ…',
        showBack: true,
        rightActions: [
          {
            icon: 'ğŸ“š',
            text: this.isAdded ? 'å·²æ·»åŠ ' : 'æ·»åŠ ',
            onClick: () => {
              if (!this.isAdded) {
                this.addBook();
              }
            }
          }
        ]
      })

      if (this.book) {
        Scroll() {
          Column() {
            this.buildBookInfo()
            
            if (this.book.intro) {
              this.buildIntro()
            }

            this.buildActionButtons()

            if (this.isLoadingChapters) {
              AppLoading({ loadingText: 'åŠ è½½ç« èŠ‚ä¸­...' })
                .margin({ top: DesignSystem.Spacing.xl })
            } else if (this.chapters.length > 0) {
              this.buildChapterList()
            }
          }
          .width('100%')
          .padding(DesignSystem.Spacing.lg)
        }
        .width('100%')
        .layoutWeight(1)
        .scrollBar(BarState.Auto)
      } else {
        AppEmpty({
          emptyIcon: 'ğŸ“–',
          emptyTitle: 'æœªæ‰¾åˆ°ä¹¦ç±',
          emptyDescription: 'è¯¥ä¹¦ç±å¯èƒ½å·²è¢«åˆ é™¤'
        })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(DesignSystem.getPrimaryBackgroundColor(this.isLightMode))
    .bindSheet($$this.showChapterSheet, this.buildChapterSheet(), {
      height: '70%',
      backgroundColor: Color.Transparent,
      dragBar: true
    })
  }

  @Builder
  buildBookInfo() {
    Row() {
      if (this.book?.cover) {
        Image(this.book.cover)
          .width(100)
          .height(140)
          .borderRadius(DesignSystem.BorderRadius.md)
          .objectFit(ImageFit.Cover)
      } else {
        Column() {
          Text('ğŸ“–')
            .fontSize(40)
        }
        .width(100)
        .height(140)
        .borderRadius(DesignSystem.BorderRadius.md)
        .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
        .justifyContent(FlexAlign.Center)
      }

      Column() {
        Text(this.book?.name || '')
          .fontSize(DesignSystem.Typography.size.xl)
          .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
          .fontWeight(DesignSystem.Typography.weight.bold)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        if (this.book?.author) {
          Text(this.book.author)
            .fontSize(DesignSystem.Typography.size.sm)
            .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
            .margin({ top: DesignSystem.Spacing.sm })
        }

        if (this.book?.bookSourceName) {
          Row() {
            Text('æ¥æº: ')
              .fontSize(DesignSystem.Typography.size.xs)
              .fontColor(DesignSystem.getTertiaryTextColor(this.isLightMode))
            Text(this.book.bookSourceName)
              .fontSize(DesignSystem.Typography.size.xs)
              .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
          }
          .margin({ top: DesignSystem.Spacing.sm })
        }

        if (this.book?.kind) {
          Text(this.book.kind)
            .fontSize(DesignSystem.Typography.size.xs)
            .fontColor(DesignSystem.getPrimaryColor(this.isLightMode))
            .padding({
              left: DesignSystem.Spacing.sm,
              right: DesignSystem.Spacing.sm,
              top: DesignSystem.Spacing.xs,
              bottom: DesignSystem.Spacing.xs
            })
            .borderRadius(DesignSystem.BorderRadius.sm)
            .backgroundColor(DesignSystem.getHoverColor(this.isLightMode))
            .margin({ top: DesignSystem.Spacing.sm })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      .margin({ left: DesignSystem.Spacing.md })
    }
    .width('100%')
    .alignItems(VerticalAlign.Top)
  }

  @Builder
  buildIntro() {
    Column() {
      Text('ç®€ä»‹')
        .fontSize(DesignSystem.Typography.size.base)
        .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
        .fontWeight(DesignSystem.Typography.weight.semibold)
        .width('100%')
        .margin({ bottom: DesignSystem.Spacing.sm })

      Text(this.book?.intro || '')
        .fontSize(DesignSystem.Typography.size.sm)
        .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
        .lineHeight(22)
        .width('100%')
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .margin({ top: DesignSystem.Spacing.lg })
    .padding(DesignSystem.Spacing.md)
    .borderRadius(DesignSystem.BorderRadius.lg)
    .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
  }

  @Builder
  buildActionButtons() {
    Row({ space: DesignSystem.Spacing.md }) {
      AppButton({
        buttonText: this.chapters.length > 0 ? 'å¼€å§‹é˜…è¯»' : 'åŠ è½½ç« èŠ‚',
        variant: 'primary',
        fullWidth: true,
        loading: this.isLoadingChapters
      })
        .setOnClick(() => {
          this.startRead();
        })

      if (this.chapters.length > 0) {
        AppButton({
          buttonText: 'ç›®å½•',
          variant: 'secondary',
          fullWidth: true
        })
          .setOnClick(() => {
            this.showChapterSheet = true;
          })
      }
    }
    .width('100%')
    .margin({ top: DesignSystem.Spacing.lg })
  }

  @Builder
  buildChapterList() {
    Column() {
      Row() {
        Text(`ç›®å½•`)
          .fontSize(DesignSystem.Typography.size.base)
          .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
          .fontWeight(DesignSystem.Typography.weight.semibold)

        Blank()

        Text(`${this.chapters.length} ç« `)
          .fontSize(DesignSystem.Typography.size.sm)
          .fontColor(DesignSystem.getTertiaryTextColor(this.isLightMode))

        Text('æŸ¥çœ‹å…¨éƒ¨')
          .fontSize(DesignSystem.Typography.size.sm)
          .fontColor(DesignSystem.getPrimaryColor(this.isLightMode))
          .margin({ left: DesignSystem.Spacing.md })
          .onClick(() => {
            this.showChapterSheet = true;
          })
      }
      .width('100%')
      .margin({ bottom: DesignSystem.Spacing.md })

      Column() {
        ForEach(this.chapters.slice(0, 5), (chapter: Chapter, index: number) => {
          Row() {
            Text(chapter.title)
              .fontSize(DesignSystem.Typography.size.sm)
              .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .layoutWeight(1)

            if (chapter.isVip) {
              Text('VIP')
                .fontSize(DesignSystem.Typography.size.xs)
                .fontColor('#FFFFFF')
                .padding({
                  left: DesignSystem.Spacing.xs,
                  right: DesignSystem.Spacing.xs,
                  top: 2,
                  bottom: 2
                })
                .borderRadius(DesignSystem.BorderRadius.sm)
                .backgroundColor(DesignSystem.getWarningColor(this.isLightMode))
            }
          }
          .width('100%')
          .padding(DesignSystem.Spacing.sm)
          .borderRadius(DesignSystem.BorderRadius.md)
          .backgroundColor(this.currentChapterIndex === index ?
            DesignSystem.getHoverColor(this.isLightMode) :
            Color.Transparent)
          .onClick(() => {
            this.openChapter(index);
          })
        })
      }
      .width('100%')
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .margin({ top: DesignSystem.Spacing.lg })
    .padding(DesignSystem.Spacing.md)
    .borderRadius(DesignSystem.BorderRadius.lg)
    .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
  }

  @Builder
  buildChapterSheet() {
    Column() {
      Row() {
        Text('ç›®å½•')
          .fontSize(DesignSystem.Typography.size.lg)
          .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
          .fontWeight(DesignSystem.Typography.weight.semibold)
          .layoutWeight(1)

        Text(`${this.chapters.length} ç« `)
          .fontSize(DesignSystem.Typography.size.sm)
          .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
      }
      .width('100%')
      .padding(DesignSystem.Spacing.lg)

      List() {
        ForEach(this.chapters, (chapter: Chapter, index: number) => {
          ListItem() {
            Row() {
              Text(chapter.title)
                .fontSize(DesignSystem.Typography.size.sm)
                .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .layoutWeight(1)

              if (chapter.isVip) {
                Text('VIP')
                  .fontSize(DesignSystem.Typography.size.xs)
                  .fontColor('#FFFFFF')
                  .padding({
                    left: DesignSystem.Spacing.xs,
                    right: DesignSystem.Spacing.xs,
                    top: 2,
                    bottom: 2
                  })
                  .borderRadius(DesignSystem.BorderRadius.sm)
                  .backgroundColor(DesignSystem.getWarningColor(this.isLightMode))
              }
            }
            .width('100%')
            .padding(DesignSystem.Spacing.md)
            .borderRadius(DesignSystem.BorderRadius.md)
            .backgroundColor(this.currentChapterIndex === index ?
              DesignSystem.getHoverColor(this.isLightMode) :
              Color.Transparent)
          }
          .onClick(() => {
            this.openChapter(index);
          })
        })
      }
      .width('100%')
      .layoutWeight(1)
      .padding({
        left: DesignSystem.Spacing.lg,
        right: DesignSystem.Spacing.lg
      })
      .cachedCount(10)
    }
    .width('100%')
    .height('100%')
    .borderRadius({
      topLeft: DesignSystem.BorderRadius.xl,
      topRight: DesignSystem.BorderRadius.xl
    })
    .backgroundColor(DesignSystem.getPrimaryBackgroundColor(this.isLightMode))
  }
}

export default BookDetailPage;
