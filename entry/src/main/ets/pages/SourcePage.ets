import { themeManager } from '../common/ThemeManager';
import { BookSourceViewModel } from '../viewmodel/BookSourceViewModel';
import { BookSource } from '../models/BookSource';
import { promptAction } from '@kit.ArkUI';
import { BusinessError } from '@kit.BasicServicesKit';
import picker from '@ohos.file.picker';
import fs from '@ohos.file.fs';
import { util } from '@kit.ArkTS';
import { common } from '@kit.AbilityKit';
import { DesignSystem } from '../common/DesignSystem';

interface SourceItemData {
  name: string;
  status: string;
  enabled: boolean;
  id: string;
}

interface DecodeOptions {
  stream: boolean;
}

@ComponentV2
export struct SourcePage {
  @Local isLightMode: boolean = themeManager.isLightTheme();
  @Local sourceList: SourceItemData[] = [];
  @Local showImportDialog: boolean = false;
  @Local importUrl: string = '';
  @Local isImporting: boolean = false;
  private bookSourceViewModel: BookSourceViewModel = new BookSourceViewModel();
  private decoder = util.TextDecoder.create('utf-8');
  private themeListener: (isDark: boolean) => void = (isDark: boolean) => {
    this.isLightMode = !isDark;
  };

  aboutToAppear(): void {
    this.isLightMode = themeManager.isLightTheme();
    themeManager.addListener(this.themeListener);
    this.loadSources();
  }

  aboutToDisappear(): void {
    themeManager.removeListener(this.themeListener);
  }

  async loadSources() {
    const sources: BookSource[] = await this.bookSourceViewModel.loadAllBookSources();
    this.sourceList = sources.map((source: BookSource) => {
      const item: SourceItemData = {
        name: source.name,
        status: source.enabled ? 'æ­£å¸¸' : 'å·²ç¦ç”¨',
        enabled: source.enabled,
        id: source.id
      };
      return item;
    });
  }

  async toggleSource(id: string) {
    const source: BookSource | undefined = this.bookSourceViewModel.getBookSourceById(id);
    if (source) {
      const enabled: boolean = !source.enabled;
      await this.bookSourceViewModel.toggleBookSource(id, enabled);
      await this.loadSources();
    }
  }

  // æ˜¾ç¤ºå¯¼å…¥å¯¹è¯æ¡†
  showImportDialogUI() {
    this.showImportDialog = true;
    this.importUrl = '';
  }

  // ä»URLå¯¼å…¥ä¹¦æº
  async importFromUrl(url: string) {
    if (!url || url.trim().length === 0) {
      promptAction.showToast({
        message: 'è¯·è¾“å…¥ä¹¦æºURL',
        duration: 2000
      });
      return;
    }

    this.isImporting = true;
    try {
      let result = await this.bookSourceViewModel.importBookSource(url.trim());
      promptAction.showToast({
        message: result.message,
        duration: 2000
      });
      await this.loadSources();
      this.showImportDialog = false;
    } catch (error) {
      promptAction.showToast({
        message: 'å¯¼å…¥å¤±è´¥ï¼š' + (error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'),
        duration: 2000
      });
    } finally {
      this.isImporting = false;
    }
  }

  // ä»æœ¬åœ°æ–‡ä»¶å¯¼å…¥
  async addSource() {
    try {
      const documentPicker = new picker.DocumentViewPicker(getContext(this) as common.UIAbilityContext);
      const documentSelectOptions = new picker.DocumentSelectOptions();
      const documentSelectResult = await documentPicker.select(documentSelectOptions);
      if (documentSelectResult) {
        const uri = documentSelectResult[0];
        const file = fs.openSync(uri, fs.OpenMode.READ_ONLY);
        const arrayBuffer = new ArrayBuffer(1024 * 1024); // å¢åŠ åˆ°1MB
        fs.readSync(file.fd, arrayBuffer);
        let text = this.decoder.decodeWithStream(new Uint8Array(arrayBuffer), { stream: false } as DecodeOptions);
        let result = await this.bookSourceViewModel.importBookSource(text);
        promptAction.showToast({
          message: result.message,
          duration: 2000
        });
        await this.loadSources();
      }
    } catch (e) {
      let error: BusinessError = e as BusinessError;
      console.error(`DocumentViewPicker.select failed with error: ${JSON.stringify(error)}`);
    }
  }

  async updateSource() {
    for (let i = 0; i < this.sourceList.length; i++) {
      const item: SourceItemData = this.sourceList[i];
      await this.toggleSource(item.id);
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Row() {
          Text('â€¹')
            .fontSize(20)
            .fontColor(DesignSystem.getPrimaryColor(this.isLightMode))
        }
        .width(32)
        .height(32)
        .borderRadius(16)
        .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
        .justifyContent(FlexAlign.Center)
        .margin({ right: 15 })

        Text($r('app.string.source_management'))
          .fontSize(18)
          .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
          .fontWeight(600)
          .layoutWeight(1)
      }
      .width('100%')
      .padding({ left: 15, right: 20, top: 15, bottom: 15 })
      .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
      .border({
        width: { bottom: 1 },
        color: DesignSystem.getBorderColor(this.isLightMode)
      })

      Column() {
        // æŒ‰é’®åŒºåŸŸ
        Row() {
          // ç½‘ç»œå¯¼å…¥æŒ‰é’®
          Button() {
            Row() {
              Text('ğŸŒ')
                .fontSize(16)
                .margin({ right: 8 })

              Text('ç½‘ç»œå¯¼å…¥')
                .fontSize(14)
                .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
            }
          }
          .layoutWeight(1)
          .height(40)
          .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
          .border({
            width: 1,
            color: DesignSystem.getBorderColor(this.isLightMode)
          })
          .borderRadius(12)
          .margin({ right: 10 })
          .onClick(() => {
            this.showImportDialogUI();
          })

          // æœ¬åœ°å¯¼å…¥æŒ‰é’®
          Button() {
            Row() {
              Text('ğŸ“')
                .fontSize(16)
                .margin({ right: 8 })

              Text('æœ¬åœ°å¯¼å…¥')
                .fontSize(14)
                .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
            }
          }
          .layoutWeight(1)
          .height(40)
          .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
          .border({
            width: 1,
            color: DesignSystem.getBorderColor(this.isLightMode)
          })
          .borderRadius(12)
          .margin({ right: 10 })
          .onClick(() => {
            this.addSource();
          })

          // æ›´æ–°ä¹¦æºæŒ‰é’®
          Button() {
            Row() {
              Text('â†»')
                .fontSize(16)
                .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
                .margin({ right: 8 })

              Text($r('app.string.update_source'))
                .fontSize(14)
                .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
            }
          }
          .layoutWeight(1)
          .height(40)
          .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
          .border({
            width: 1,
            color: DesignSystem.getBorderColor(this.isLightMode)
          })
          .borderRadius(12)
          .onClick(() => {
            this.updateSource();
          })
        }
        .width('100%')
        .margin({ bottom: 20 })

        // ä¹¦æºåˆ—è¡¨
        Column() {
          if (this.sourceList.length === 0) {
            // ç©ºçŠ¶æ€æç¤º
            Column() {
              Text('ğŸ“š')
                .fontSize(48)
                .margin({ bottom: 16 })
              Text('æš‚æ— ä¹¦æº')
                .fontSize(16)
                .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                .margin({ bottom: 8 })
              Text('ç‚¹å‡»"ç½‘ç»œå¯¼å…¥"æŒ‰é’®æ·»åŠ ä¹¦æº')
                .fontSize(14)
                .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
            }
            .width('100%')
            .height(200)
            .justifyContent(FlexAlign.Center)
          } else {
            ForEach(this.sourceList, (item: SourceItemData) => {
              Row() {
                Column() {
                  Text(item.name)
                    .fontSize(14)
                    .fontWeight(500)
                    .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
                    .margin({ bottom: 4 })

                  Text(item.status)
                    .fontSize(12)
                    .fontColor(item.enabled ? '#4caf50' : '#999')
                    .fontWeight(500)
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)

                Toggle({ type: ToggleType.Switch, isOn: item.enabled })
                  .selectedColor(DesignSystem.getPrimaryColor(this.isLightMode))
                  .onChange((isOn: boolean) => {
                    item.enabled = isOn;
                    this.toggleSource(item.id);
                  })
              }
              .width('100%')
              .padding(15)
              .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
              .borderRadius(12)
              .border({
                width: 1,
                color: DesignSystem.getBorderColor(this.isLightMode)
              })
              .margin({ bottom: 8 })
            })
          }
        }
        .width('100%')
        .layoutWeight(1)
      }
      .width('100%')
      .padding(20)

      // å¯¼å…¥å¯¹è¯æ¡†
      if (this.showImportDialog) {
        Column() {
          Column() {
            // å¯¹è¯æ¡†æ ‡é¢˜
            Text('å¯¼å…¥ä¹¦æº')
              .fontSize(18)
              .fontWeight(600)
              .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
              .width('100%')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 20 })

            // URLè¾“å…¥æ¡†
            TextInput({ placeholder: 'è¯·è¾“å…¥ä¹¦æºURLæˆ–ç²˜è´´JSON', text: this.importUrl })
              .width('100%')
              .height(44)
              .backgroundColor(DesignSystem.getPrimaryBackgroundColor(this.isLightMode))
              .borderRadius(8)
              .padding({ left: 12, right: 12 })
              .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
              .placeholderColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
              .onChange((value: string) => {
                this.importUrl = value;
              })

            // æŒ‰é’®åŒºåŸŸ
            Row() {
              Button('å–æ¶ˆ')
                .layoutWeight(1)
                .height(44)
                .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
                .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
                .borderRadius(8)
                .margin({ right: 10 })
                .onClick(() => {
                  this.showImportDialog = false;
                })

              Button(this.isImporting ? 'å¯¼å…¥ä¸­...' : 'å¯¼å…¥')
                .layoutWeight(1)
                .height(44)
                .backgroundColor(DesignSystem.getPrimaryColor(this.isLightMode))
                .fontColor('#fff')
                .borderRadius(8)
                .enabled(!this.isImporting)
                .onClick(() => {
                  this.importFromUrl(this.importUrl);
                })
            }
            .width('100%')
            .margin({ top: 20 })
          }
          .width('90%')
          .constraintSize({ maxWidth: 400 })
          .padding(24)
          .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
          .borderRadius(16)
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          // ç‚¹å‡»èƒŒæ™¯å…³é—­å¯¹è¯æ¡†
          this.showImportDialog = false;
        })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(DesignSystem.getPrimaryBackgroundColor(this.isLightMode))
  }
}
