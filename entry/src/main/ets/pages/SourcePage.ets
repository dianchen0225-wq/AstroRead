import { themeManager } from '../common/ThemeManager';
import { BookSourceViewModel, ImportResult } from '../viewmodel/BookSourceViewModel';
import { BookSource } from '../models/BookSource';
import { SecurityScanResult, SecurityRisk, SecurityRiskLevel } from '../utils/SourceSandbox';
import { promptAction } from '@kit.ArkUI';
import { BusinessError } from '@kit.BasicServicesKit';
import picker from '@ohos.file.picker';
import fs from '@ohos.file.fs';
import { util } from '@kit.ArkTS';
import { common } from '@kit.AbilityKit';
import { DesignSystem } from '../common/DesignSystem';
import { Logger } from '../utils/Logger';

interface SourceItemData {
  name: string;
  status: string;
  enabled: boolean;
  id: string;
  isValidating: boolean;
}

interface DecodeOptions {
  stream: boolean;
}

@ComponentV2
export struct SourcePage {
  @Local isLightMode: boolean = themeManager.isLightTheme();
  @Local sourceList: SourceItemData[] = [];
  @Local showImportDialog: boolean = false;
  @Local importUrl: string = '';
  @Local isImporting: boolean = false;
  @Local isUpdating: boolean = false;
  @Local updateProgress: string = '';
  @Local showSecurityWarning: boolean = false;
  @Local securityScanResult: SecurityScanResult | null = null;
  @Local pendingImportContent: string = '';
  @Local pendingImportFormat: string = '';
  
  private bookSourceViewModel: BookSourceViewModel = new BookSourceViewModel();
  private decoder = util.TextDecoder.create('utf-8');
  private themeListener: (isDark: boolean) => void = (isDark: boolean) => {
    this.isLightMode = !isDark;
  };

  aboutToAppear(): void {
    this.isLightMode = themeManager.isLightTheme();
    themeManager.addListener(this.themeListener);
    this.bookSourceViewModel.setContext(getContext(this) as common.UIAbilityContext);
    this.loadSources();
  }

  aboutToDisappear(): void {
    themeManager.removeListener(this.themeListener);
  }

  async loadSources() {
    try {
      const sources: BookSource[] = await this.bookSourceViewModel.loadAllBookSources();
      this.sourceList = sources.map((source: BookSource) => {
        const item: SourceItemData = {
          name: source.name,
          status: source.enabled ? 'æ­£å¸¸' : 'å·²ç¦ç”¨',
          enabled: source.enabled,
          id: source.id,
          isValidating: false
        };
        return item;
      });
    } catch (error) {
      Logger.error('SourcePage', `åŠ è½½ä¹¦æºå¤±è´¥: ${error}`);
      promptAction.showToast({
        message: 'åŠ è½½ä¹¦æºå¤±è´¥',
        duration: 2000
      });
    }
  }

  async toggleSource(id: string) {
    const source: BookSource | undefined = this.bookSourceViewModel.getBookSourceById(id);
    if (source) {
      const enabled: boolean = !source.enabled;
      await this.bookSourceViewModel.toggleBookSource(id, enabled);
      await this.loadSources();
    }
  }

  showImportDialogUI() {
    this.showImportDialog = true;
    this.importUrl = '';
  }

  async importFromUrl(url: string): Promise<void> {
    if (!url || url.trim().length === 0) {
      try {
        promptAction.showToast({
          message: 'è¯·è¾“å…¥ä¹¦æºURL',
          duration: 2000
        });
      } catch (e) {
        let code = e.code;
        let name = e.name;
        let message = e.message;
        Logger.error('SourcePage', `promptAction.showToast call failed. code is ${code}, message is ${message}`);
      }
      return;
    }

    const trimmedUrl = url.trim();
    
    if (!this.isValidUrl(trimmedUrl)) {
      try {
        promptAction.showToast({
          message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„URLåœ°å€',
          duration: 2000
        });
      } catch (e) {
        let code = e.code;
        let name = e.name;
        let message = e.message;
        Logger.error('SourcePage', `promptAction.showToast call failed. code is ${code}, message is ${message}`);
      }
      return;
    }

    this.isImporting = true;
    try {
      Logger.info('SourcePage', `å¼€å§‹ä»URLå¯¼å…¥ä¹¦æº: ${trimmedUrl}`);
      
      const scanResult = this.bookSourceViewModel.scanSourceSecurity(trimmedUrl);
      
      if (scanResult.riskLevel === 'critical' || scanResult.riskLevel === 'high') {
        this.securityScanResult = scanResult;
        this.pendingImportContent = trimmedUrl;
        this.pendingImportFormat = 'url';
        this.showSecurityWarning = true;
        this.isImporting = false;
        return;
      }
      
      const result: ImportResult = await this.bookSourceViewModel.importBookSource(trimmedUrl);
      
      if (result.success) {
        promptAction.showToast({
          message: result.message || `æˆåŠŸå¯¼å…¥${result.count || 0}ä¸ªä¹¦æº`,
          duration: 2000
        });
        await this.loadSources();
        this.showImportDialog = false;
      } else {
        promptAction.showToast({
          message: result.message || 'å¯¼å…¥å¤±è´¥',
          duration: 3000
        });
      }
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
      Logger.error('SourcePage', `å¯¼å…¥å¤±è´¥: ${errorMessage}`);
      
      if (errorMessage.includes('network') || errorMessage.includes('ç½‘ç»œ')) {
        promptAction.showToast({
          message: 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®',
          duration: 3000
        });
      } else if (errorMessage.includes('timeout') || errorMessage.includes('è¶…æ—¶')) {
        promptAction.showToast({
          message: 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•',
          duration: 3000
        });
      } else {
        promptAction.showToast({
          message: `å¯¼å…¥å¤±è´¥: ${errorMessage}`,
          duration: 3000
        });
      }
    } finally {
      this.isImporting = false;
    }
  }

  async confirmImportWithRisk(): Promise<void> {
    this.showSecurityWarning = false;
    this.isImporting = true;
    
    try {
      let result: ImportResult;
      
      if (this.pendingImportFormat === 'url') {
        result = await this.bookSourceViewModel.importBookSource(this.pendingImportContent);
      } else {
        result = await this.bookSourceViewModel.importBookSource(this.pendingImportContent, this.pendingImportFormat);
      }
      
      if (result.success) {
        promptAction.showToast({
          message: result.message || `æˆåŠŸå¯¼å…¥${result.count || 0}ä¸ªä¹¦æº`,
          duration: 2000
        });
        await this.loadSources();
        this.showImportDialog = false;
      } else {
        promptAction.showToast({
          message: result.message || 'å¯¼å…¥å¤±è´¥',
          duration: 3000
        });
      }
    } catch (error) {
      promptAction.showToast({
        message: 'å¯¼å…¥å¤±è´¥: ' + (error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'),
        duration: 2000
      });
    } finally {
      this.isImporting = false;
      this.pendingImportContent = '';
      this.pendingImportFormat = '';
      this.securityScanResult = null;
    }
  }

  cancelImportWithRisk() {
    this.showSecurityWarning = false;
    this.pendingImportContent = '';
    this.pendingImportFormat = '';
    this.securityScanResult = null;
    try {
      promptAction.showToast({
        message: 'å·²å–æ¶ˆå¯¼å…¥',
        duration: 2000
      });
    } catch (e) {
      let code = e.code;
      let name = e.name;
      let message = e.message;
      Logger.error('SourcePage', `promptAction.showToast call failed. code is ${code}, message is ${message}`);
    }
  }

  private isValidUrl(url: string): boolean {
    try {
      return url.startsWith('http://') || url.startsWith('https://');
    } catch (error) {
      return false;
    }
  }

  async addSource(): Promise<void> {
    try {
      const documentPicker = new picker.DocumentViewPicker(getContext(this) as common.UIAbilityContext);
      const documentSelectOptions = new picker.DocumentSelectOptions();
      const documentSelectResult = await documentPicker.select(documentSelectOptions);
      if (documentSelectResult) {
        const uri = documentSelectResult[0];
        const file = fs.openSync(uri, fs.OpenMode.READ_ONLY);
        const arrayBuffer = new ArrayBuffer(1024 * 1024);
        fs.readSync(file.fd, arrayBuffer);
        let text = this.decoder.decodeWithStream(new Uint8Array(arrayBuffer), { stream: false } as DecodeOptions);
        
        const scanResult = this.bookSourceViewModel.scanSourceSecurity(text);
        
        if (scanResult.riskLevel === 'critical' || scanResult.riskLevel === 'high') {
          this.securityScanResult = scanResult;
          this.pendingImportContent = text;
          this.pendingImportFormat = this.bookSourceViewModel.detectSourceFormat(text);
          this.showSecurityWarning = true;
          return;
        }
        
        this.isImporting = true;
        try {
          const result: ImportResult = await this.bookSourceViewModel.importBookSource(text);
          promptAction.showToast({
            message: result.message || `æˆåŠŸå¯¼å…¥${result.count || 0}ä¸ªä¹¦æº`,
            duration: 2000
          });
          await this.loadSources();
        } catch (error) {
          promptAction.showToast({
            message: 'å¯¼å…¥å¤±è´¥: ' + (error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'),
            duration: 2000
          });
        } finally {
          this.isImporting = false;
        }
      }
    } catch (e) {
      let error: BusinessError = e as BusinessError;
      Logger.error('SourcePage', `æœ¬åœ°å¯¼å…¥å¤±è´¥: ${JSON.stringify(error)}`);
    }
  }

  async updateSource(): Promise<void> {
    if (this.sourceList.length === 0) {
      try {
        promptAction.showToast({
          message: 'æš‚æ— ä¹¦æºå¯æ›´æ–°',
          duration: 2000
        });
      } catch (e) {
        let code = e.code;
        let name = e.name;
        let message = e.message;
        Logger.error('SourcePage', `promptAction.showToast call failed. code is ${code}, message is ${message}`);
      }
      return;
    }

    this.isUpdating = true;
    this.updateProgress = 'æ­£åœ¨éªŒè¯ä¹¦æº...';
    
    try {
      const sources: BookSource[] = await this.bookSourceViewModel.loadAllBookSources();
      const totalSources = sources.length;
      
      let validCount = 0;
      let invalidCount = 0;

      for (let i = 0; i < sources.length; i++) {
        const source = sources[i];
        this.updateProgress = `æ­£åœ¨éªŒè¯ (${i + 1}/${totalSources})...`;
        
        try {
          const isValid = await this.bookSourceViewModel.testBookSource(source);
          
          
          if (isValid) {
            validCount++;
            source.enabled = true;
          } else {
            invalidCount++;
            source.enabled = false;
          }
          
          await this.bookSourceViewModel.upsertBookSource(source);
          
          if (i < sources.length - 1) {
            await new Promise<void>(resolve => setTimeout(resolve, 500));
          }
        } catch (error) {
          Logger.error('SourcePage', `éªŒè¯ä¹¦æº${source.name}å¤±è´¥: ${error}`);
          invalidCount++;
        }
      }

      await this.loadSources();
      
      promptAction.showToast({
        message: `éªŒè¯å®Œæˆ: æœ‰æ•ˆ${validCount}ä¸ª, å¤±æ•ˆ${invalidCount}ä¸ª`,
        duration: 3000
      });
    } catch (error) {
      Logger.error('SourcePage', `æ›´æ–°ä¹¦æºå¤±è´¥: ${error}`);
      promptAction.showToast({
        message: 'ä¹¦æºæ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
        duration: 2000
      });
    } finally {
      this.isUpdating = false;
      this.updateProgress = '';
    }
  }

  async validateSingleSource(id: string) {
    const item = this.sourceList.find(s => s.id === id);
    if (!item) return;
    
    item.isValidating = true;
    item.status = 'éªŒè¯ä¸­...';
    
    try {
      const source = this.bookSourceViewModel.getBookSourceById(id);
      if (source) {
        const isValid = await this.bookSourceViewModel.testBookSource(source);
        source.enabled = isValid;
        await this.bookSourceViewModel.upsertBookSource(source);
        
        item.status = isValid ? 'æ­£å¸¸' : 'å¤±æ•ˆ';
        item.enabled = isValid;
        
        promptAction.showToast({
          message: isValid ? 'ä¹¦æºæœ‰æ•ˆ' : 'ä¹¦æºå·²å¤±æ•ˆ',
          duration: 2000
        });
      }
    } catch (error) {
      item.status = 'éªŒè¯å¤±è´¥';
      promptAction.showToast({
        message: 'éªŒè¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
        duration: 2000
      });
    } finally {
      item.isValidating = false;
    }
  }

  async deleteSource(id: string) {
    try {
      const result = await this.bookSourceViewModel.deleteBookSource(id);
      if (result.success) {
        promptAction.showToast({
          message: 'åˆ é™¤æˆåŠŸ',
          duration: 2000
        });
        await this.loadSources();
      } else {
        promptAction.showToast({
          message: result.message || 'åˆ é™¤å¤±è´¥',
          duration: 2000
        });
      }
    } catch (error) {
      promptAction.showToast({
        message: 'åˆ é™¤å¤±è´¥',
        duration: 2000
      });
    }
  }

  build() {
    Stack() {
      Column() {
        Row() {
          Row() {
            Text('â€¹')
              .fontSize(20)
              .fontColor(DesignSystem.getPrimaryColor(this.isLightMode))
          }
          .width(32)
          .height(32)
          .borderRadius(16)
          .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
          .justifyContent(FlexAlign.Center)
          .margin({ right: 15 })

          Text($r('app.string.source_management'))
            .fontSize(18)
            .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
            .fontWeight(600)
            .layoutWeight(1)
        }
        .width('100%')
        .padding({ left: 15, right: 20, top: 15, bottom: 15 })
        .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
        .border({
          width: { bottom: 1 },
          color: DesignSystem.getBorderColor(this.isLightMode)
        })

        Column() {
          Row() {
            Button() {
              Row() {
                Text('ğŸŒ')
                  .fontSize(16)
                  .margin({ right: 8 })
                Text('ç½‘ç»œå¯¼å…¥')
                  .fontSize(14)
                  .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
              }
            }
            .layoutWeight(1)
            .height(40)
            .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
            .border({
              width: 1,
              color: DesignSystem.getBorderColor(this.isLightMode)
            })
            .borderRadius(12)
            .margin({ right: 10 })
            .enabled(!this.isImporting && !this.isUpdating)
            .onClick(() => {
              this.showImportDialogUI();
            })

            Button() {
              Row() {
                Text('ğŸ“')
                  .fontSize(16)
                  .margin({ right: 8 })
                Text('æœ¬åœ°å¯¼å…¥')
                  .fontSize(14)
                  .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
              }
            }
            .layoutWeight(1)
            .height(40)
            .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
            .border({
              width: 1,
              color: DesignSystem.getBorderColor(this.isLightMode)
            })
            .borderRadius(12)
            .margin({ right: 10 })
            .enabled(!this.isImporting && !this.isUpdating)
            .onClick(() => {
              this.addSource();
            })

            Button() {
              Row() {
                if (this.isUpdating) {
                  LoadingProgress()
                    .width(16)
                    .height(16)
                    .color(DesignSystem.getPrimaryTextColor(this.isLightMode))
                    .margin({ right: 8 })
                } else {
                  Text('â†»')
                    .fontSize(16)
                    .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
                    .margin({ right: 8 })
                }
                Text(this.isUpdating ? 'éªŒè¯ä¸­' : 'éªŒè¯ä¹¦æº')
                  .fontSize(14)
                  .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
              }
            }
            .layoutWeight(1)
            .height(40)
            .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
            .border({
              width: 1,
              color: DesignSystem.getBorderColor(this.isLightMode)
            })
            .borderRadius(12)
            .enabled(!this.isImporting && !this.isUpdating)
            .onClick(() => {
              this.updateSource();
            })
          }
          .width('100%')
          .margin({ bottom: 10 })

          if (this.isUpdating && this.updateProgress) {
            Row() {
              LoadingProgress()
                .width(16)
                .height(16)
                .color(DesignSystem.getPrimaryColor(this.isLightMode))
                .margin({ right: 8 })
              Text(this.updateProgress)
                .fontSize(12)
                .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
            }
            .width('100%')
            .padding({ top: 8, bottom: 8 })
          }

          Column() {
            if (this.sourceList.length === 0) {
              Column() {
                Text('ğŸ“š')
                  .fontSize(48)
                  .margin({ bottom: 16 })
                Text('æš‚æ— ä¹¦æº')
                  .fontSize(16)
                  .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                  .margin({ bottom: 8 })
                Text('ç‚¹å‡»"ç½‘ç»œå¯¼å…¥"æŒ‰é’®æ·»åŠ ä¹¦æº')
                  .fontSize(14)
                  .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                  .margin({ bottom: 16 })
                Button('ç½‘ç»œå¯¼å…¥ä¹¦æº')
                  .fontSize(14)
                  .backgroundColor(DesignSystem.getPrimaryColor(this.isLightMode))
                  .fontColor('#fff')
                  .borderRadius(8)
                  .padding({ left: 20, right: 20, top: 10, bottom: 10 })
                  .onClick(() => {
                    this.showImportDialogUI();
                  })
              }
              .width('100%')
              .height(200)
              .justifyContent(FlexAlign.Center)
            } else {
              ForEach(this.sourceList, (item: SourceItemData) => {
                Row() {
                  Column() {
                    Text(item.name)
                      .fontSize(14)
                      .fontWeight(500)
                      .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
                      .margin({ bottom: 4 })
                      .maxLines(1)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })

                    Row() {
                      Text(item.status)
                        .fontSize(12)
                        .fontColor(this.getStatusColor(item.status))
                        .fontWeight(500)
                      
                      if (item.isValidating) {
                        LoadingProgress()
                          .width(12)
                          .height(12)
                          .color(DesignSystem.getPrimaryColor(this.isLightMode))
                          .margin({ left: 8 })
                      }
                    }
                  }
                  .alignItems(HorizontalAlign.Start)
                  .layoutWeight(1)

                  Row() {
                    Button('éªŒè¯')
                      .fontSize(12)
                      .height(28)
                      .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
                      .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
                      .borderRadius(6)
                      .margin({ right: 8 })
                      .enabled(!item.isValidating)
                      .onClick(() => {
                        this.validateSingleSource(item.id);
                      })

                    Toggle({ type: ToggleType.Switch, isOn: item.enabled })
                      .selectedColor(DesignSystem.getPrimaryColor(this.isLightMode))
                      .onChange((isOn: boolean) => {
                        item.enabled = isOn;
                        this.toggleSource(item.id);
                      })
                  }
                }
                .width('100%')
                .padding(15)
                .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
                .borderRadius(12)
                .border({
                  width: 1,
                  color: DesignSystem.getBorderColor(this.isLightMode)
                })
                .margin({ bottom: 8 })
              })
            }
          }
          .width('100%')
          .layoutWeight(1)
        }
        .width('100%')
        .padding(20)
      }
      .width('100%')
      .height('100%')
      .backgroundColor(DesignSystem.getPrimaryBackgroundColor(this.isLightMode))

      if (this.showImportDialog) {
        Column() {
          Column() {
            Text('å¯¼å…¥ä¹¦æº')
              .fontSize(18)
              .fontWeight(600)
              .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
              .width('100%')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 12 })

            Text('æ”¯æŒé˜…è¯»APPæ ¼å¼çš„JSONä¹¦æº')
              .fontSize(12)
              .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
              .width('100%')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 16 })

            TextInput({ placeholder: 'è¯·è¾“å…¥ä¹¦æºURL', text: this.importUrl })
              .width('100%')
              .height(44)
              .backgroundColor(DesignSystem.getPrimaryBackgroundColor(this.isLightMode))
              .borderRadius(8)
              .padding({ left: 12, right: 12 })
              .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
              .placeholderColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
              .enabled(!this.isImporting)
              .onChange((value: string) => {
                this.importUrl = value;
              })

            Text('ç¤ºä¾‹: https://example.com/sources.json')
              .fontSize(11)
              .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
              .width('100%')
              .margin({ top: 8, bottom: 16 })

            Row() {
              Button('å–æ¶ˆ')
                .layoutWeight(1)
                .height(44)
                .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
                .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
                .borderRadius(8)
                .margin({ right: 10 })
                .enabled(!this.isImporting)
                .onClick(() => {
                  this.showImportDialog = false;
                })

              Button(this.isImporting ? 'å¯¼å…¥ä¸­...' : 'å¯¼å…¥')
                .layoutWeight(1)
                .height(44)
                .backgroundColor(DesignSystem.getPrimaryColor(this.isLightMode))
                .fontColor('#fff')
                .borderRadius(8)
                .enabled(!this.isImporting && this.importUrl.trim().length > 0)
                .onClick(() => {
                  this.importFromUrl(this.importUrl);
                })
            }
            .width('100%')
          }
          .width('90%')
          .constraintSize({ maxWidth: 400 })
          .padding(24)
          .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
          .borderRadius(16)
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          if (!this.isImporting) {
            this.showImportDialog = false;
          }
        })
      }

      if (this.showSecurityWarning && this.securityScanResult) {
        Column() {
          Column() {
            Row() {
              Text('âš ï¸')
                .fontSize(24)
              Text('å®‰å…¨è­¦å‘Š')
                .fontSize(18)
                .fontWeight(600)
                .fontColor('#FF6B00')
                .margin({ left: 8 })
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
            .margin({ bottom: 16 })

            Text(this.securityScanResult.summary)
              .fontSize(14)
              .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
              .width('100%')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 16 })

            Scroll() {
              Column() {
                ForEach(this.securityScanResult.risks.slice(0, 5), (risk: SecurityRisk) => {
                  Row() {
                    Text(this.getRiskLevelEmoji(risk.level))
                      .fontSize(14)
                      .margin({ right: 8 })

                    Column() {
                      Text(risk.type)
                        .fontSize(12)
                        .fontWeight(500)
                        .fontColor(this.getRiskLevelColor(risk.level))

                      Text(risk.description)
                        .fontSize(11)
                        .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
                        .margin({ top: 2 })
                    }
                    .alignItems(HorizontalAlign.Start)
                    .layoutWeight(1)
                  }
                  .width('100%')
                  .padding({ top: 8, bottom: 8 })
                  .border({
                    width: { bottom: 1 },
                    color: DesignSystem.getBorderColor(this.isLightMode)
                  })
                })
              }
              .width('100%')
            }
            .width('100%')
            .constraintSize({ maxHeight: 200 })
            .margin({ bottom: 16 })

            Text('æ˜¯å¦ä»è¦å¯¼å…¥æ­¤ä¹¦æºï¼Ÿ')
              .fontSize(13)
              .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
              .width('100%')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 16 })

            Row() {
              Button('å–æ¶ˆå¯¼å…¥')
                .layoutWeight(1)
                .height(44)
                .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
                .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
                .borderRadius(8)
                .margin({ right: 10 })
                .onClick(() => {
                  this.cancelImportWithRisk();
                })

              Button('ç»§ç»­å¯¼å…¥')
                .layoutWeight(1)
                .height(44)
                .backgroundColor('#FF6B00')
                .fontColor('#fff')
                .borderRadius(8)
                .onClick(() => {
                  this.confirmImportWithRisk();
                })
            }
            .width('100%')
          }
          .width('90%')
          .constraintSize({ maxWidth: 400 })
          .padding(24)
          .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
          .borderRadius(16)
          .border({
            width: 2,
            color: '#FF6B00'
          })
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.6)')
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
  }

  private getRiskLevelEmoji(level: SecurityRiskLevel): string {
    switch (level) {
      case 'critical': return 'ğŸ”´';
      case 'high': return 'ğŸŸ ';
      case 'medium': return 'ğŸŸ¡';
      case 'low': return 'ğŸŸ¢';
      default: return 'âšª';
    }
  }

  private getRiskLevelColor(level: SecurityRiskLevel): string {
    return this.bookSourceViewModel.getSecurityRiskLevelColor(level);
  }

  private getStatusColor(status: string): string {
    switch (status) {
      case 'æ­£å¸¸':
        return '#4caf50';
      case 'å¤±æ•ˆ':
      case 'éªŒè¯å¤±è´¥':
        return '#f44336';
      case 'å·²ç¦ç”¨':
        return '#999999';
      case 'éªŒè¯ä¸­...':
        return '#ff9800';
      default:
        return '#999999';
    }
  }
}
