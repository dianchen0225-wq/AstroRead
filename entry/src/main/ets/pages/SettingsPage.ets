import { themeManager, ThemeMode } from '../common/ThemeManager';
import { DesignSystem } from '../common/DesignSystem';
import { NavigationManager } from '../common/NavigationManager';
import { CommonNavBar, SectionHeader } from '../components/CommonNavBar';
import { viewModelManager } from '../viewmodel/ViewModelManager';
import { ReadConfig } from '../models/ReadConfig';
import { ReadConfigViewModel } from '../viewmodel/ReadConfigViewModel';
import { Logger } from '../utils/Logger';
import { showToast } from '../utils/ToastUtils';
import { floatingNavManager, FloatingNavConfig, FloatingNavPosition } from '../common/FloatingNavManager';

interface SettingItem {
  id: string;
  title: string;
  subtitle?: string;
  icon: string;
  type: 'navigation' | 'toggle' | 'slider' | 'action' | 'info';
  value?: string | number | boolean;
  route?: string;
  action?: () => void;
}

interface SettingGroup {
  id: string;
  title: string;
  items: SettingItem[];
}

interface PositionOption {
  id: string;
  label: string;
  icon: string;
}

@ComponentV2
export struct SettingsPage {
  @Local isLightMode: boolean = true;
  @Local fontSize: number = 16;
  @Local lineSpacing: number = 1.6;
  @Local cacheSize: string = '128MB';
  @Local autoUpdate: boolean = true;
  @Local themeModeIndex: number = 0;
  @Local readConfig: ReadConfig = ReadConfigViewModel.DEFAULT_READ_CONFIG;
  @Local showClearCacheConfirm: boolean = false;
  @Local isClearingCache: boolean = false;
  @Local showAboutSheet: boolean = false;
  @Local searchKeyword: string = '';
  @Local filteredGroups: SettingGroup[] = [];
  @Local floatingNavConfig: FloatingNavConfig = floatingNavManager.getConfig();
  @Local showFloatingNavSettings: boolean = false;
  @Param safeAreaTop: number = 0;
  @Param safeAreaBottom: number = 0;
  
  private isComponentActive: boolean = false;
  private settingGroups: SettingGroup[] = [];
  private themeListener: (isDark: boolean) => void = (isDark: boolean) => {
    this.isLightMode = !isDark;
  };
  private floatingNavListener: (config: FloatingNavConfig) => void = (config: FloatingNavConfig) => {
    this.floatingNavConfig = config;
    this.initSettingGroups();
    this.performSearch(this.searchKeyword);
  };

  aboutToAppear(): void {
    this.isComponentActive = true;
    this.isLightMode = themeManager.isLightTheme();
    this.themeModeIndex = this.getThemeModeIndex();
    themeManager.addListener(this.themeListener);
    floatingNavManager.addConfigChangeListener(this.floatingNavListener);
    
    this.loadReadConfig();
    this.initSettingGroups();
    this.filteredGroups = this.settingGroups.slice();
  }

  aboutToDisappear(): void {
    this.isComponentActive = false;
    themeManager.removeListener(this.themeListener);
    floatingNavManager.removeConfigChangeListener(this.floatingNavListener);
  }

  private getThemeModeIndex(): number {
    const mode = themeManager.getThemeMode();
    switch (mode) {
      case ThemeMode.LIGHT:
        return 0;
      case ThemeMode.DARK:
        return 1;
      case ThemeMode.AUTO:
        return 2;
      default:
        return 0;
    }
  }

  private async loadReadConfig(): Promise<void> {
    try {
      const readConfigViewModel = viewModelManager.getReadConfigViewModel();
      this.readConfig = await readConfigViewModel.getReadConfig();
      this.fontSize = this.readConfig.fontSize;
      this.lineSpacing = this.readConfig.lineSpacing;
    } catch (error) {
      Logger.error('SettingsPage', `Âä†ËΩΩÈòÖËØªÈÖçÁΩÆÂ§±Ë¥•: ${error}`);
    }
  }

  private initSettingGroups(): void {
    this.settingGroups = [
      {
        id: 'appearance',
        title: 'Â§ñËßÇËÆæÁΩÆ',
        items: [
          {
            id: 'theme_mode',
            title: '‰∏ªÈ¢òÊ®°Âºè',
            subtitle: this.getThemeModeText(),
            icon: 'üé®',
            type: 'navigation',
            route: 'ThemeModeSheet'
          }
        ]
      },
      {
        id: 'reading',
        title: 'ÈòÖËØªËÆæÁΩÆ',
        items: [
          {
            id: 'font_size',
            title: 'Â≠ó‰ΩìÂ§ßÂ∞è',
            subtitle: `${this.fontSize}px`,
            icon: 'üî§',
            type: 'slider',
            value: this.fontSize
          },
          {
            id: 'line_spacing',
            title: 'Ë°åÈó¥Ë∑ù',
            subtitle: `${this.lineSpacing.toFixed(1)}`,
            icon: 'üìè',
            type: 'slider',
            value: this.lineSpacing
          },
          {
            id: 'read_background',
            title: 'ÈòÖËØªËÉåÊôØ',
            subtitle: 'ÈªòËÆ§',
            icon: 'üñºÔ∏è',
            type: 'navigation'
          }
        ]
      },
      {
        id: 'app',
        title: 'Â∫îÁî®ËÆæÁΩÆ',
        items: [
          {
            id: 'auto_update',
            title: 'Ëá™Âä®Êõ¥Êñ∞',
            subtitle: 'Ëá™Âä®Ê£ÄÊü•‰π¶Ê∫êÊõ¥Êñ∞',
            icon: 'üîÑ',
            type: 'toggle',
            value: this.autoUpdate
          },
          {
            id: 'floating_nav',
            title: 'ÊÇ¨ÊµÆÂØºËà™Ê†è',
            subtitle: this.floatingNavConfig.enabled ? 'Â∑≤ÂºÄÂêØ' : 'Â∑≤ÂÖ≥Èó≠',
            icon: 'üß≠',
            type: 'navigation',
            route: 'FloatingNavSettings'
          },
          {
            id: 'cache',
            title: 'Ê∏ÖÈô§ÁºìÂ≠ò',
            subtitle: this.cacheSize,
            icon: 'üóëÔ∏è',
            type: 'action',
            action: () => {
              this.showClearCacheConfirm = true;
            }
          }
        ]
      },
      {
        id: 'developer',
        title: 'ÂºÄÂèëËÄÖÈÄâÈ°π',
        items: [
          {
            id: 'debug_log',
            title: 'Ë∞ÉËØïÊó•Âøó',
            subtitle: 'Êü•ÁúãÂ∫îÁî®ËøêË°åÊó•Âøó',
            icon: 'üìã',
            type: 'navigation',
            route: 'DebugLogPage'
          },
          {
            id: 'performance',
            title: 'ÊÄßËÉΩÁõëÊéß',
            subtitle: 'Êü•ÁúãÂ∫îÁî®ÊÄßËÉΩÊï∞ÊçÆ',
            icon: 'üìä',
            type: 'navigation',
            route: 'PerformanceMonitorPage'
          },
          {
            id: 'booksource_repair',
            title: '‰π¶Ê∫êËØäÊñ≠‰øÆÂ§ç',
            subtitle: 'ËØäÊñ≠Âπ∂‰øÆÂ§ç‰π¶Ê∫êËÆøÈóÆÈóÆÈ¢ò',
            icon: 'üîß',
            type: 'navigation',
            route: 'BookSourceRepairPage'
          }
        ]
      },
      {
        id: 'about',
        title: 'ÂÖ≥‰∫é',
        items: [
          {
            id: 'about_app',
            title: 'ÂÖ≥‰∫éÂ∫îÁî®',
            subtitle: 'ÁâàÊú¨ 1.0.0',
            icon: '‚ÑπÔ∏è',
            type: 'navigation',
            route: 'AboutSheet'
          },
          {
            id: 'feedback',
            title: 'ÊÑèËßÅÂèçÈ¶à',
            subtitle: 'Â∏ÆÂä©Êàë‰ª¨ÊîπËøõ',
            icon: 'üí¨',
            type: 'navigation'
          }
        ]
      }
    ];
  }

  private getThemeModeText(): string {
    switch (this.themeModeIndex) {
      case 0:
        return 'ÊµÖËâ≤Ê®°Âºè';
      case 1:
        return 'Ê∑±Ëâ≤Ê®°Âºè';
      case 2:
        return 'Ë∑üÈöèÁ≥ªÁªü';
      default:
        return 'ÊµÖËâ≤Ê®°Âºè';
    }
  }

  private performSearch(keyword: string): void {
    this.searchKeyword = keyword;
    
    if (!keyword || keyword.trim().length === 0) {
      this.filteredGroups = this.settingGroups.slice();
      return;
    }
    
    const lowerKeyword = keyword.toLowerCase().trim();
    const filtered: SettingGroup[] = [];
    
    for (const group of this.settingGroups) {
      const matchedItems = group.items.filter(item => 
        item.title.toLowerCase().includes(lowerKeyword) ||
        (item.subtitle && item.subtitle.toLowerCase().includes(lowerKeyword))
      );
      
      if (matchedItems.length > 0) {
        filtered.push({
          id: group.id,
          title: group.title,
          items: matchedItems
        });
      }
    }
    
    this.filteredGroups = filtered;
  }

  private async toggleAutoUpdate(): Promise<void> {
    this.autoUpdate = !this.autoUpdate;
    showToast({
      message: this.autoUpdate ? 'Â∑≤ÂºÄÂêØËá™Âä®Êõ¥Êñ∞' : 'Â∑≤ÂÖ≥Èó≠Ëá™Âä®Êõ¥Êñ∞'
    });
  }

  private async clearCache(): Promise<void> {
    this.isClearingCache = true;
    
    try {
      await new Promise<void>(resolve => setTimeout(resolve, 1000));
      this.cacheSize = '0MB';
      showToast({
        message: 'ÁºìÂ≠òÂ∑≤Ê∏ÖÈô§'
      });
    } catch (error) {
      Logger.error('SettingsPage', `Ê∏ÖÈô§ÁºìÂ≠òÂ§±Ë¥•: ${error}`);
      showToast({
        message: 'Ê∏ÖÈô§Â§±Ë¥•'
      });
    } finally {
      this.isClearingCache = false;
      this.showClearCacheConfirm = false;
    }
  }

  private async updateFontSize(size: number): Promise<void> {
    this.fontSize = Math.round(size);
    this.readConfig.fontSize = this.fontSize;
    
    try {
      const readConfigViewModel = viewModelManager.getReadConfigViewModel();
      await readConfigViewModel.updateReadConfig(this.readConfig);
    } catch (error) {
      Logger.error('SettingsPage', `‰øùÂ≠òÂ≠ó‰ΩìÂ§ßÂ∞èÂ§±Ë¥•: ${error}`);
    }
  }

  private async updateLineSpacing(spacing: number): Promise<void> {
    this.lineSpacing = Math.round(spacing * 10) / 10;
    this.readConfig.lineSpacing = this.lineSpacing;
    
    try {
      const readConfigViewModel = viewModelManager.getReadConfigViewModel();
      await readConfigViewModel.updateReadConfig(this.readConfig);
    } catch (error) {
      Logger.error('SettingsPage', `‰øùÂ≠òË°åÈó¥Ë∑ùÂ§±Ë¥•: ${error}`);
    }
  }

  private async setThemeMode(index: number): Promise<void> {
    this.themeModeIndex = index;
    const modes: ThemeMode[] = [ThemeMode.LIGHT, ThemeMode.DARK, ThemeMode.AUTO];
    await themeManager.setThemeMode(modes[index]);
    
    this.initSettingGroups();
    this.performSearch(this.searchKeyword);
  }

  private handleItemAction(item: SettingItem): void {
    if (item.type === 'navigation' && item.route) {
      if (item.route === 'DebugLogPage') {
        NavigationManager.getInstance().navigateTo('DebugLogPage');
      } else if (item.route === 'PerformanceMonitorPage') {
        NavigationManager.getInstance().navigateTo('PerformanceMonitorPage');
      } else if (item.route === 'BookSourceRepairPage') {
        NavigationManager.getInstance().navigateTo('BookSourceRepairPage');
      } else if (item.route === 'AboutSheet') {
        this.showAboutSheet = true;
      } else if (item.route === 'FloatingNavSettings') {
        this.showFloatingNavSettings = true;
      }
    } else if (item.type === 'action' && item.action) {
      item.action();
    } else if (item.type === 'toggle' && item.id === 'auto_update') {
      this.toggleAutoUpdate();
    }
  }

  build() {
    Column() {
      CommonNavBar({
        title: $r('app.string.settings'),
        showBack: true,
        safeAreaTop: this.safeAreaTop
      })

      this.buildSearchBar()

      Scroll() {
        Column() {
          ForEach(this.filteredGroups, (group: SettingGroup) => {
            this.buildSettingGroup(group)
          })

          if (this.filteredGroups.length === 0) {
            this.buildEmptySearchResult()
          }
        }
        .width('100%')
        .padding({ bottom: DesignSystem.Spacing.xxl + this.safeAreaBottom })
      }
      .width('100%')
      .layoutWeight(1)
      .scrollBar(BarState.Auto)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(DesignSystem.getPrimaryBackgroundColor(this.isLightMode))
    .bindSheet($$this.showClearCacheConfirm, this.buildClearCacheSheet(), {
      height: 'auto',
      backgroundColor: Color.Transparent,
      dragBar: false
    })
    .bindSheet($$this.showAboutSheet, this.buildAboutSheet(), {
      height: 'auto',
      backgroundColor: Color.Transparent,
      dragBar: false
    })
    .bindSheet($$this.showFloatingNavSettings, this.buildFloatingNavSettingsSheet(), {
      height: '90%',
      backgroundColor: Color.Transparent,
      dragBar: true
    })
  }

  @Builder
  buildSearchBar() {
    Row() {
      Text('üîç')
        .fontSize(DesignSystem.IconSize.sm)
        .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
        .margin({ right: DesignSystem.Spacing.sm })

      TextInput({ placeholder: 'ÊêúÁ¥¢ËÆæÁΩÆÈ°π...', text: this.searchKeyword })
        .layoutWeight(1)
        .backgroundColor(Color.Transparent)
        .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
        .fontSize(DesignSystem.Typography.size.sm)
        .placeholderColor(DesignSystem.getTertiaryTextColor(this.isLightMode))
        .onChange((value: string) => {
          this.performSearch(value);
        })

      if (this.searchKeyword.length > 0) {
        Text('‚úï')
          .fontSize(DesignSystem.IconSize.sm)
          .fontColor(DesignSystem.getTertiaryTextColor(this.isLightMode))
          .onClick(() => {
            this.performSearch('');
          })
      }
    }
    .width('100%')
    .padding(DesignSystem.Spacing.md)
    .margin({
      left: DesignSystem.Spacing.lg,
      right: DesignSystem.Spacing.lg,
      top: DesignSystem.Spacing.sm,
      bottom: DesignSystem.Spacing.md
    })
    .borderRadius(DesignSystem.BorderRadius.lg)
    .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
  }

  @Builder
  buildSettingGroup(group: SettingGroup) {
    Column() {
      SectionHeader({ title: group.title })

      Column() {
        ForEach(group.items, (item: SettingItem, index: number) => {
          Column() {
            this.buildSettingItem(item)
            
            if (index < group.items.length - 1) {
              Row()
                .width('100%')
                .height(1)
                .backgroundColor(DesignSystem.getBorderColor(this.isLightMode))
                .margin({ left: 48 + DesignSystem.Spacing.md })
            }
          }
        })
      }
      .width('100%')
      .margin({
        left: DesignSystem.Spacing.lg,
        right: DesignSystem.Spacing.lg
      })
      .borderRadius(DesignSystem.BorderRadius.lg)
      .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
      .border({
        width: 1,
        color: DesignSystem.getBorderColor(this.isLightMode)
      })
    }
    .width('100%')
    .margin({ bottom: DesignSystem.Spacing.md })
  }

  @Builder
  buildSettingItem(item: SettingItem) {
    Row() {
      Row() {
        Text(item.icon)
          .fontSize(DesignSystem.IconSize.md)
      }
      .width(32)
      .height(32)
      .borderRadius(DesignSystem.BorderRadius.md)
      .backgroundColor(DesignSystem.getHoverColor(this.isLightMode))
      .justifyContent(FlexAlign.Center)
      .margin({ right: DesignSystem.Spacing.md })

      Column() {
        Text(item.title)
          .fontSize(DesignSystem.Typography.size.base)
          .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
          .fontWeight(DesignSystem.Typography.weight.medium)

        if (item.subtitle) {
          Text(item.subtitle)
            .fontSize(DesignSystem.Typography.size.xs)
            .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
            .margin({ top: 2 })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      if (item.type === 'navigation') {
        Text('‚Ä∫')
          .fontSize(DesignSystem.Typography.size.xl)
          .fontColor(DesignSystem.getTertiaryTextColor(this.isLightMode))
      } else if (item.type === 'toggle') {
        Toggle({ type: ToggleType.Switch, isOn: item.value as boolean })
          .selectedColor(DesignSystem.getPrimaryColor(this.isLightMode))
          .onChange((isOn: boolean) => {
            if (item.id === 'auto_update') {
              this.autoUpdate = isOn;
              this.toggleAutoUpdate();
            }
          })
      } else if (item.type === 'slider') {
        Row({ space: DesignSystem.Spacing.sm }) {
          Text(item.id === 'font_size' ? 'A-' : 'Á¥ß')
            .fontSize(DesignSystem.Typography.size.xs)
            .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
            .onClick(() => {
              if (item.id === 'font_size' && this.fontSize > 12) {
                this.updateFontSize(this.fontSize - 1);
              } else if (item.id === 'line_spacing' && this.lineSpacing > 1.2) {
                this.updateLineSpacing(this.lineSpacing - 0.1);
              }
            })

          Slider({
            value: item.id === 'font_size' ? this.fontSize : this.lineSpacing * 10,
            min: item.id === 'font_size' ? 12 : 12,
            max: item.id === 'font_size' ? 32 : 24,
            step: 1
          })
            .width(80)
            .blockColor(DesignSystem.getPrimaryColor(this.isLightMode))
            .trackColor(DesignSystem.getBorderColor(this.isLightMode))
            .selectedColor(DesignSystem.getPrimaryColor(this.isLightMode))
            .onChange((value: number) => {
              if (item.id === 'font_size') {
                this.updateFontSize(value);
              } else {
                this.updateLineSpacing(value / 10);
              }
            })

          Text(item.id === 'font_size' ? 'A+' : 'Êùæ')
            .fontSize(DesignSystem.Typography.size.xs)
            .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
            .onClick(() => {
              if (item.id === 'font_size' && this.fontSize < 32) {
                this.updateFontSize(this.fontSize + 1);
              } else if (item.id === 'line_spacing' && this.lineSpacing < 2.4) {
                this.updateLineSpacing(this.lineSpacing + 0.1);
              }
            })
        }
      }
    }
    .width('100%')
    .padding(DesignSystem.Spacing.md)
    .onClick(() => {
      if (item.type === 'navigation' || item.type === 'action') {
        this.handleItemAction(item);
      }
    })
  }

  @Builder
  buildEmptySearchResult() {
    Column() {
      Text('üîç')
        .fontSize(48)
        .margin({ bottom: DesignSystem.Spacing.md })

      Text('Êú™ÊâæÂà∞Áõ∏ÂÖ≥ËÆæÁΩÆ')
        .fontSize(DesignSystem.Typography.size.base)
        .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))

      Text('ËØ∑Â∞ùËØïÂÖ∂‰ªñÂÖ≥ÈîÆËØç')
        .fontSize(DesignSystem.Typography.size.sm)
        .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
        .margin({ top: DesignSystem.Spacing.xs })
    }
    .width('100%')
    .padding(DesignSystem.Spacing.xxl)
    .margin({ top: DesignSystem.Spacing.xxl })
  }

  @Builder
  buildClearCacheSheet() {
    Column() {
      Column() {
        Text('Ê∏ÖÈô§ÁºìÂ≠ò')
          .fontSize(DesignSystem.Typography.size.lg)
          .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
          .fontWeight(DesignSystem.Typography.weight.semibold)
          .margin({ bottom: DesignSystem.Spacing.md })

        Text(`Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÁºìÂ≠òÂêóÔºüÂΩìÂâçÁºìÂ≠òÂ§ßÂ∞è: ${this.cacheSize}`)
          .fontSize(DesignSystem.Typography.size.sm)
          .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
          .textAlign(TextAlign.Center)
          .margin({ bottom: DesignSystem.Spacing.lg })

        Row({ space: DesignSystem.Spacing.md }) {
          Row() {
            Text('ÂèñÊ∂à')
              .fontSize(DesignSystem.Typography.size.base)
              .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
              .fontWeight(DesignSystem.Typography.weight.medium)
          }
          .layoutWeight(1)
          .height(44)
          .borderRadius(DesignSystem.BorderRadius.md)
          .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
          .justifyContent(FlexAlign.Center)
          .onClick(() => {
            this.showClearCacheConfirm = false;
          })

          Row() {
            if (this.isClearingCache) {
              LoadingProgress()
                .width(20)
                .height(20)
                .color('#FFFFFF')
            } else {
              Text('Á°ÆÂÆö')
                .fontSize(DesignSystem.Typography.size.base)
                .fontColor($r('sys.color.ohos_id_color_text_primary_contrary'))
                .fontWeight(DesignSystem.Typography.weight.medium)
            }
          }
          .layoutWeight(1)
          .height(44)
          .borderRadius(DesignSystem.BorderRadius.md)
          .backgroundColor(DesignSystem.getPrimaryColor(this.isLightMode))
          .justifyContent(FlexAlign.Center)
          .onClick(() => {
            if (!this.isClearingCache) {
              this.clearCache();
            }
          })
        }
        .width('100%')
      }
      .width('100%')
      .padding(DesignSystem.Spacing.lg)
      .borderRadius(DesignSystem.BorderRadius.xl)
      .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
    }
    .width('100%')
    .padding(DesignSystem.Spacing.lg)
  }

  @Builder
  buildAboutSheet() {
    Column() {
      Column() {
        Column() {
          Text('üìö')
            .fontSize(48)
            .margin({ bottom: DesignSystem.Spacing.md })

          Text('AstroRead')
            .fontSize(DesignSystem.Typography.size.xl)
            .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
            .fontWeight(DesignSystem.Typography.weight.bold)

          Text('ÁâàÊú¨ 1.0.0')
            .fontSize(DesignSystem.Typography.size.sm)
            .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
            .margin({ top: DesignSystem.Spacing.xs })
        }
        .width('100%')
        .padding(DesignSystem.Spacing.lg)

        Column() {
          Text('‰∏ÄÊ¨æÁÆÄÊ¥Å‰ºòÈõÖÁöÑÈòÖËØªÂ∫îÁî®ÔºåÊîØÊåÅÂ§öÁßç‰π¶Ê∫êÂØºÂÖ•ÔºåÊèê‰æõËàíÈÄÇÁöÑÈòÖËØª‰ΩìÈ™å„ÄÇ')
            .fontSize(DesignSystem.Typography.size.sm)
            .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
            .textAlign(TextAlign.Center)
            .lineHeight(22)
        }
        .width('100%')
        .padding({
          left: DesignSystem.Spacing.lg,
          right: DesignSystem.Spacing.lg,
          bottom: DesignSystem.Spacing.lg
        })

        Row() {
          Row() {
            Text('ÂÖ≥Èó≠')
              .fontSize(DesignSystem.Typography.size.base)
              .fontColor($r('sys.color.ohos_id_color_text_primary_contrary'))
              .fontWeight(DesignSystem.Typography.weight.medium)
          }
          .width('100%')
          .height(44)
          .borderRadius(DesignSystem.BorderRadius.md)
          .backgroundColor(DesignSystem.getPrimaryColor(this.isLightMode))
          .justifyContent(FlexAlign.Center)
          .onClick(() => {
            this.showAboutSheet = false;
          })
        }
        .width('100%')
        .padding(DesignSystem.Spacing.lg)
      }
      .width('100%')
      .borderRadius(DesignSystem.BorderRadius.xl)
      .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
    }
    .width('100%')
    .padding(DesignSystem.Spacing.lg)
  }

  @Builder
  buildFloatingNavSettingsSheet() {
    Column() {
      Column() {
        Text('ÊÇ¨ÊµÆÂØºËà™Ê†èËÆæÁΩÆ')
          .fontSize(DesignSystem.Typography.size.lg)
          .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
          .fontWeight(DesignSystem.Typography.weight.semibold)
          .margin({ bottom: DesignSystem.Spacing.lg })

        Scroll() {
          Column({ space: DesignSystem.Spacing.lg }) {
            this.buildFloatingNavToggleSection()
            this.buildFloatingNavPositionSection()
            this.buildFloatingNavSizeSection()
            this.buildFloatingNavStyleSection()
            this.buildFloatingNavBehaviorSection()
          }
          .width('100%')
          .padding({ bottom: DesignSystem.Spacing.xl })
        }
        .width('100%')
        .layoutWeight(1)
        .scrollBar(BarState.Auto)

        Row({ space: DesignSystem.Spacing.md }) {
          Row() {
            Text('ÈáçÁΩÆ')
              .fontSize(DesignSystem.Typography.size.base)
              .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
              .fontWeight(DesignSystem.Typography.weight.medium)
          }
          .layoutWeight(1)
          .height(44)
          .borderRadius(DesignSystem.BorderRadius.md)
          .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
          .justifyContent(FlexAlign.Center)
          .onClick(() => {
            floatingNavManager.resetToDefault();
            showToast({ message: 'Â∑≤ÊÅ¢Â§çÈªòËÆ§ËÆæÁΩÆ' });
          })

          Row() {
            Text('ÂÆåÊàê')
              .fontSize(DesignSystem.Typography.size.base)
              .fontColor($r('sys.color.ohos_id_color_text_primary_contrary'))
              .fontWeight(DesignSystem.Typography.weight.medium)
          }
          .layoutWeight(1)
          .height(44)
          .borderRadius(DesignSystem.BorderRadius.md)
          .backgroundColor(DesignSystem.getPrimaryColor(this.isLightMode))
          .justifyContent(FlexAlign.Center)
          .onClick(() => {
            this.showFloatingNavSettings = false;
          })
        }
        .width('100%')
        .margin({ top: DesignSystem.Spacing.lg })
      }
      .width('100%')
      .height('100%')
      .padding(DesignSystem.Spacing.lg)
      .borderRadius(DesignSystem.BorderRadius.xl)
      .backgroundColor(DesignSystem.getSecondaryBackgroundColor(this.isLightMode))
    }
    .width('100%')
    .height('100%')
    .padding(DesignSystem.Spacing.lg)
  }

  @Builder
  buildFloatingNavToggleSection() {
    Column({ space: DesignSystem.Spacing.md }) {
      SectionHeader({ title: 'ÂêØÁî®ÊÇ¨ÊµÆÂØºËà™' })

      Row() {
        Text('ÂºÄÂêØÊÇ¨ÊµÆÂØºËà™Ê†è')
          .fontSize(DesignSystem.Typography.size.base)
          .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
          .layoutWeight(1)

        Toggle({ type: ToggleType.Switch, isOn: this.floatingNavConfig.enabled })
          .selectedColor(DesignSystem.getPrimaryColor(this.isLightMode))
          .onChange((isOn: boolean) => {
            floatingNavManager.setEnabled(isOn);
          })
      }
      .width('100%')
      .padding(DesignSystem.Spacing.md)
      .borderRadius(DesignSystem.BorderRadius.lg)
      .backgroundColor(DesignSystem.getPrimaryBackgroundColor(this.isLightMode))
    }
    .width('100%')
  }

  @Builder
  buildFloatingNavPositionSection() {
    Column({ space: DesignSystem.Spacing.md }) {
      SectionHeader({ title: '‰ΩçÁΩÆËÆæÁΩÆ' })

      Column({ space: DesignSystem.Spacing.sm }) {
        ForEach([
          { id: 'bottom-left', label: 'Â∑¶‰∏ãËßí', icon: '‚ÜôÔ∏è' } as PositionOption,
          { id: 'bottom-center', label: 'Â∫ïÈÉ®Â±Ö‰∏≠', icon: '‚¨áÔ∏è' } as PositionOption,
          { id: 'bottom-right', label: 'Âè≥‰∏ãËßí', icon: '‚ÜòÔ∏è' } as PositionOption,
          { id: 'left', label: 'Â∑¶‰æßÂ±Ö‰∏≠', icon: '‚¨ÖÔ∏è' } as PositionOption,
          { id: 'center', label: 'Â±èÂπï‰∏≠Â§Æ', icon: '‚è∫Ô∏è' } as PositionOption,
          { id: 'right', label: 'Âè≥‰æßÂ±Ö‰∏≠', icon: '‚û°Ô∏è' } as PositionOption
        ], (pos: PositionOption) => {
          Row() {
            Text(pos.icon)
              .fontSize(DesignSystem.IconSize.sm)
              .margin({ right: DesignSystem.Spacing.sm })

            Text(pos.label)
              .fontSize(DesignSystem.Typography.size.base)
              .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
              .layoutWeight(1)

            if (this.floatingNavConfig.position === pos.id) {
              Text('‚úì')
                .fontSize(DesignSystem.Typography.size.base)
                .fontColor(DesignSystem.getPrimaryColor(this.isLightMode))
            }
          }
          .width('100%')
          .padding(DesignSystem.Spacing.md)
          .borderRadius(DesignSystem.BorderRadius.md)
          .backgroundColor(this.floatingNavConfig.position === pos.id ?
            DesignSystem.getHoverColor(this.isLightMode) :
            DesignSystem.getPrimaryBackgroundColor(this.isLightMode))
          .onClick(() => {
            floatingNavManager.setPosition(pos.id as FloatingNavPosition);
          })
        })
      }
      .width('100%')
      .padding(DesignSystem.Spacing.md)
      .borderRadius(DesignSystem.BorderRadius.lg)
      .backgroundColor(DesignSystem.getPrimaryBackgroundColor(this.isLightMode))
    }
    .width('100%')
  }

  @Builder
  buildFloatingNavSizeSection() {
    Column({ space: DesignSystem.Spacing.md }) {
      SectionHeader({ title: 'Â∞∫ÂØ∏ËÆæÁΩÆ' })

      Column({ space: DesignSystem.Spacing.md }) {
        Column({ space: DesignSystem.Spacing.sm }) {
          Row() {
            Text('ÂÆΩÂ∫¶')
              .fontSize(DesignSystem.Typography.size.base)
              .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
              .layoutWeight(1)

            Text(`${this.floatingNavConfig.width}px`)
              .fontSize(DesignSystem.Typography.size.sm)
              .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
          }
          .width('100%')

          Slider({
            value: this.floatingNavConfig.width,
            min: 200,
            max: 400,
            step: 10
          })
            .width('100%')
            .blockColor(DesignSystem.getPrimaryColor(this.isLightMode))
            .trackColor(DesignSystem.getBorderColor(this.isLightMode))
            .selectedColor(DesignSystem.getPrimaryColor(this.isLightMode))
            .onChange((value: number) => {
              floatingNavManager.setSize(value, this.floatingNavConfig.height);
            })
        }

        Column({ space: DesignSystem.Spacing.sm }) {
          Row() {
            Text('È´òÂ∫¶')
              .fontSize(DesignSystem.Typography.size.base)
              .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
              .layoutWeight(1)

            Text(`${this.floatingNavConfig.height}px`)
              .fontSize(DesignSystem.Typography.size.sm)
              .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
          }
          .width('100%')

          Slider({
            value: this.floatingNavConfig.height,
            min: 44,
            max: 80,
            step: 4
          })
            .width('100%')
            .blockColor(DesignSystem.getPrimaryColor(this.isLightMode))
            .trackColor(DesignSystem.getBorderColor(this.isLightMode))
            .selectedColor(DesignSystem.getPrimaryColor(this.isLightMode))
            .onChange((value: number) => {
              floatingNavManager.setSize(this.floatingNavConfig.width, value);
            })
        }

        Column({ space: DesignSystem.Spacing.sm }) {
          Row() {
            Text('ÂúÜËßí')
              .fontSize(DesignSystem.Typography.size.base)
              .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
              .layoutWeight(1)

            Text(`${this.floatingNavConfig.borderRadius}px`)
              .fontSize(DesignSystem.Typography.size.sm)
              .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
          }
          .width('100%')

          Slider({
            value: this.floatingNavConfig.borderRadius,
            min: 0,
            max: 40,
            step: 2
          })
            .width('100%')
            .blockColor(DesignSystem.getPrimaryColor(this.isLightMode))
            .trackColor(DesignSystem.getBorderColor(this.isLightMode))
            .selectedColor(DesignSystem.getPrimaryColor(this.isLightMode))
            .onChange((value: number) => {
              floatingNavManager.setBorderRadius(value);
            })
        }
      }
      .width('100%')
      .padding(DesignSystem.Spacing.md)
      .borderRadius(DesignSystem.BorderRadius.lg)
      .backgroundColor(DesignSystem.getPrimaryBackgroundColor(this.isLightMode))
    }
    .width('100%')
  }

  @Builder
  buildFloatingNavStyleSection() {
    Column({ space: DesignSystem.Spacing.md }) {
      SectionHeader({ title: 'Ê†∑ÂºèËÆæÁΩÆ' })

      Column({ space: DesignSystem.Spacing.md }) {
        Column({ space: DesignSystem.Spacing.sm }) {
          Row() {
            Text('ÈÄèÊòéÂ∫¶')
              .fontSize(DesignSystem.Typography.size.base)
              .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
              .layoutWeight(1)

            Text(`${Math.round(this.floatingNavConfig.opacity * 100)}%`)
              .fontSize(DesignSystem.Typography.size.sm)
              .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
          }
          .width('100%')

          Slider({
            value: this.floatingNavConfig.opacity * 100,
            min: 30,
            max: 100,
            step: 5
          })
            .width('100%')
            .blockColor(DesignSystem.getPrimaryColor(this.isLightMode))
            .trackColor(DesignSystem.getBorderColor(this.isLightMode))
            .selectedColor(DesignSystem.getPrimaryColor(this.isLightMode))
            .onChange((value: number) => {
              floatingNavManager.setOpacity(value / 100);
            })
        }

        Column({ space: DesignSystem.Spacing.sm }) {
          Row() {
            Text('ËÉåÊôØÈÄèÊòéÂ∫¶')
              .fontSize(DesignSystem.Typography.size.base)
              .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
              .layoutWeight(1)

            Text(`${Math.round(this.floatingNavConfig.backgroundOpacity * 100)}%`)
              .fontSize(DesignSystem.Typography.size.sm)
              .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
          }
          .width('100%')

          Slider({
            value: this.floatingNavConfig.backgroundOpacity * 100,
            min: 30,
            max: 100,
            step: 5
          })
            .width('100%')
            .blockColor(DesignSystem.getPrimaryColor(this.isLightMode))
            .trackColor(DesignSystem.getBorderColor(this.isLightMode))
            .selectedColor(DesignSystem.getPrimaryColor(this.isLightMode))
            .onChange((value: number) => {
              floatingNavManager.setBackgroundOpacity(value / 100);
            })
        }

        Row() {
          Text('ÊØõÁéªÁíÉÊïàÊûú')
            .fontSize(DesignSystem.Typography.size.base)
            .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
            .layoutWeight(1)

          Toggle({ type: ToggleType.Switch, isOn: this.floatingNavConfig.blurEnabled })
            .selectedColor(DesignSystem.getPrimaryColor(this.isLightMode))
            .onChange((isOn: boolean) => {
              floatingNavManager.setBlurEnabled(isOn);
            })
        }
        .width('100%')
      }
      .width('100%')
      .padding(DesignSystem.Spacing.md)
      .borderRadius(DesignSystem.BorderRadius.lg)
      .backgroundColor(DesignSystem.getPrimaryBackgroundColor(this.isLightMode))
    }
    .width('100%')
  }

  @Builder
  buildFloatingNavBehaviorSection() {
    Column({ space: DesignSystem.Spacing.md }) {
      SectionHeader({ title: 'Ë°å‰∏∫ËÆæÁΩÆ' })

      Column({ space: DesignSystem.Spacing.md }) {
        Row() {
          Text('Ëá™Âä®ÈöêËóè')
            .fontSize(DesignSystem.Typography.size.base)
            .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
            .layoutWeight(1)

          Toggle({ type: ToggleType.Switch, isOn: this.floatingNavConfig.autoHide })
            .selectedColor(DesignSystem.getPrimaryColor(this.isLightMode))
            .onChange((isOn: boolean) => {
              floatingNavManager.setAutoHide(isOn);
            })
        }
        .width('100%')

        if (this.floatingNavConfig.autoHide) {
          Column({ space: DesignSystem.Spacing.sm }) {
            Row() {
              Text('ÈöêËóèÂª∂Ëøü')
                .fontSize(DesignSystem.Typography.size.base)
                .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
                .layoutWeight(1)

              Text(`${Math.round(this.floatingNavConfig.autoHideDelay / 1000)}Áßí`)
                .fontSize(DesignSystem.Typography.size.sm)
                .fontColor(DesignSystem.getSecondaryTextColor(this.isLightMode))
            }
            .width('100%')

            Slider({
              value: this.floatingNavConfig.autoHideDelay / 1000,
              min: 1,
              max: 10,
              step: 0.5
            })
              .width('100%')
              .blockColor(DesignSystem.getPrimaryColor(this.isLightMode))
              .trackColor(DesignSystem.getBorderColor(this.isLightMode))
              .selectedColor(DesignSystem.getPrimaryColor(this.isLightMode))
              .onChange((value: number) => {
                floatingNavManager.setAutoHideDelay(value * 1000);
              })
          }
        }

        Row() {
          Text('Âä®ÁîªÊïàÊûú')
            .fontSize(DesignSystem.Typography.size.base)
            .fontColor(DesignSystem.getPrimaryTextColor(this.isLightMode))
            .layoutWeight(1)

          Toggle({ type: ToggleType.Switch, isOn: this.floatingNavConfig.animationEnabled })
            .selectedColor(DesignSystem.getPrimaryColor(this.isLightMode))
            .onChange((isOn: boolean) => {
              floatingNavManager.setAnimationEnabled(isOn);
            })
        }
        .width('100%')
      }
      .width('100%')
      .padding(DesignSystem.Spacing.md)
      .borderRadius(DesignSystem.BorderRadius.lg)
      .backgroundColor(DesignSystem.getPrimaryBackgroundColor(this.isLightMode))
    }
    .width('100%')
  }
}
